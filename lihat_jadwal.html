<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jadwal Pelajaran Sekolah</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Library Khusus Excel dengan Fitur Styling/Warna -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
</head>
<body class="bg-slate-50 min-h-screen font-sans">

    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white shadow-lg py-6 px-4 md:px-8 mb-8">
        <div class="max-w-6xl mx-auto flex flex-col md:flex-row items-center justify-between">
            <div class="flex items-center gap-4">
                <a href="splash.html" class="bg-white/20 hover:bg-white/30 p-2 rounded-full transition cursor-pointer">
                    üè†
                </a>
                <div>
                    <h1 class="text-2xl font-extrabold tracking-wide">Papan Jadwal Pelajaran</h1>
                    <p class="text-blue-100 text-sm font-medium" id="teksNamaSekolah">Memuat info sekolah...</p>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 md:px-8 mb-12">
        <!-- Panel Pencarian (Disesuaikan layoutnya menjadi Grid agar rapi dengan 3 Filter) -->
        <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-100 mb-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
            <div class="w-full">
                <label class="block text-sm font-bold text-gray-700 mb-2">Pilih Hari</label>
                <select id="filterHari" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 bg-gray-50 font-medium">
                    <option value="Semua">-- Semua Hari --</option>
                    <option value="Senin">Senin</option><option value="Selasa">Selasa</option>
                    <option value="Rabu">Rabu</option><option value="Kamis">Kamis</option>
                    <option value="Jumat">Jumat</option><option value="Sabtu">Sabtu</option>
                </select>
            </div>
            
            <div class="w-full">
                <label class="block text-sm font-bold text-gray-700 mb-2">Pilih Kelas</label>
                <select id="filterKelas" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 bg-gray-50 font-medium">
                    <option value="Semua">-- Semua Kelas --</option>
                </select>
            </div>

            <!-- FITUR BARU: PILIH GURU -->
            <div class="w-full">
                <label class="block text-sm font-bold text-gray-700 mb-2">Pilih Guru</label>
                <select id="filterGuru" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 bg-gray-50 font-medium">
                    <option value="Semua">-- Semua Guru --</option>
                </select>
            </div>

            <div class="w-full flex gap-2">
                <button id="btnCari" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl shadow-md transition duration-200">
                    üîç Cari
                </button>
                <button onclick="exportKeExcel()" class="flex-1 bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-4 rounded-xl shadow-md transition duration-200 flex items-center justify-center gap-2">
                    üì• Excel
                </button>
            </div>
        </div>

        <!-- Tabel Jadwal -->
        <div class="bg-white rounded-2xl shadow-md overflow-hidden border border-gray-200">
            <div class="overflow-x-auto">
                <table class="min-w-full text-left border-collapse">
                    <thead class="bg-gray-800 text-white">
                        <tr>
                            <th class="py-4 px-6 uppercase font-bold text-sm tracking-wider w-24">Hari</th>
                            <th class="py-4 px-6 uppercase font-bold text-sm tracking-wider w-40">Waktu</th>
                            <th class="py-4 px-6 uppercase font-bold text-sm tracking-wider w-32">Kelas</th>
                            <th class="py-4 px-6 uppercase font-bold text-sm tracking-wider">Mata Pelajaran</th>
                            <th class="py-4 px-6 uppercase font-bold text-sm tracking-wider">Guru Pengajar</th>
                        </tr>
                    </thead>
                    <tbody id="tabelJadwal" class="divide-y divide-gray-200">
                        <tr>
                            <td colspan="5" class="py-12 text-center text-gray-500 font-medium">Klik tombol "Cari" untuk menampilkan jadwal pelajaran.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Script Utama -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // ========================================================
        // KONFIGURASI FIREBASE
        // ========================================================
        let firebaseConfig = { 
            apiKey: "API_KEY_ANDA",
            authDomain: "PROJECT_ID.firebaseapp.com",
            projectId: "PROJECT_ID",
            storageBucket: "PROJECT_ID.appspot.com",
            messagingSenderId: "SENDER_ID",
            appId: "APP_ID"
        };
        try {
            const module = await import("./firebase-config.js");
            if (module && module.firebaseConfig) { firebaseConfig = module.firebaseConfig; }
        } catch (error) { console.warn("Menjalankan mode lokal."); }

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- MUAT INFO SEKOLAH & FILTER DROPDOWN ---
        async function muatDataAwal() {
            if (firebaseConfig.apiKey === "API_KEY_ANDA") return;
            try {
                // Info Sekolah (Dengan Fallback Text)
                const docSnap = await getDoc(doc(db, "pengaturan", "info_sekolah"));
                const teksSekolah = document.getElementById('teksNamaSekolah');
                if (docSnap.exists() && docSnap.data().nama_sekolah) {
                    teksSekolah.innerText = docSnap.data().nama_sekolah;
                } else {
                    teksSekolah.innerText = "Jadwal Pelajaran Sekolah";
                }
                
                // Dropdown Kelas
                const kelasSnap = await getDocs(collection(db, "master_kelas"));
                const selectKelas = document.getElementById('filterKelas');
                kelasSnap.forEach(k => {
                    selectKelas.insertAdjacentHTML('beforeend', `<option value="${k.data().nama}">${k.data().nama}</option>`);
                });

                // Dropdown Guru (BARU)
                const guruSnap = await getDocs(collection(db, "master_guru"));
                const selectGuru = document.getElementById('filterGuru');
                guruSnap.forEach(g => {
                    selectGuru.insertAdjacentHTML('beforeend', `<option value="${g.data().nama}">${g.data().nama}</option>`);
                });

            } catch (error) { console.error("Gagal memuat data awal:", error); }
        }
        muatDataAwal();

        let dataUntukExcel = []; // Menyimpan data mentah untuk diexport

        // --- TAMPILKAN JADWAL KE TABEL ---
        document.getElementById('btnCari').addEventListener('click', async () => {
            if (firebaseConfig.apiKey === "API_KEY_ANDA") {
                document.getElementById('tabelJadwal').innerHTML = `<tr><td colspan="5" class="py-8 text-center text-orange-500 font-bold bg-orange-50">Harap hubungkan Firebase Anda terlebih dahulu.</td></tr>`;
                return;
            }

            const btn = document.getElementById('btnCari');
            btn.innerHTML = "‚è≥ Memuat..."; btn.disabled = true;

            const filterHari = document.getElementById('filterHari').value;
            const filterKelas = document.getElementById('filterKelas').value;
            const filterGuru = document.getElementById('filterGuru').value; // Mengambil nilai guru

            try {
                const querySnapshot = await getDocs(collection(db, "jadwal_pelajaran"));
                let jadwalDifilter = [];

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    
                    // Logika Pencarian Gabungan (Hari + Kelas + Guru)
                    let cocokHari = (filterHari === "Semua" || data.hari === filterHari);
                    let cocokKelas = (filterKelas === "Semua" || data.kelas === filterKelas);
                    let cocokGuru = (filterGuru === "Semua" || data.guru === filterGuru);
                    
                    // Hanya masukkan jadwal jika memenuhi KETIGA syarat filter di atas
                    if (cocokHari && cocokKelas && cocokGuru) jadwalDifilter.push(data);
                });

                // Urutkan berdasarkan Hari dan Jam (Numerik)
                const urutanHari = { "Senin":1, "Selasa":2, "Rabu":3, "Kamis":4, "Jumat":5, "Sabtu":6 };
                jadwalDifilter.sort((a,b) => (urutanHari[a.hari]||99) - (urutanHari[b.hari]||99) || String(a.jam_ke).localeCompare(String(b.jam_ke), undefined, {numeric: true}));

                const tbody = document.getElementById('tabelJadwal');
                tbody.innerHTML = ""; 
                dataUntukExcel = []; 

                if (jadwalDifilter.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" class="py-12 text-center font-bold text-gray-500 bg-gray-50">‚ùå Tidak ada jadwal yang ditemukan.</td></tr>`;
                } else {
                    jadwalDifilter.forEach(jadwal => {
                        // Persiapkan format Waktu untuk Excel dan Tabel
                        const teksWaktu = jadwal.waktu ? jadwal.waktu : "-";
                        const teksJamLengkap = `Jam Ke-${jadwal.jam_ke} (${teksWaktu})`;

                        // Masukkan ke array Excel
                        dataUntukExcel.push({
                            "Hari": jadwal.hari,
                            "Waktu": teksJamLengkap,
                            "Kelas": jadwal.kelas,
                            "Mata Pelajaran": jadwal.mapel,
                            "Guru Pengajar": jadwal.guru
                        });

                        // Tampilkan di Tabel HTML (Dengan Waktu yang mencolok)
                        tbody.insertAdjacentHTML('beforeend', `
                            <tr class="hover:bg-blue-50 transition duration-150">
                                <td class="py-4 px-6 font-bold text-gray-800">${jadwal.hari}</td>
                                <td class="py-4 px-6">
                                    <div class="flex flex-col">
                                        <span class="text-xs font-bold text-blue-600 bg-blue-100 px-2 py-1 rounded w-max mb-1">Jam ${jadwal.jam_ke}</span>
                                        <span class="font-semibold text-gray-700">${teksWaktu}</span>
                                    </div>
                                </td>
                                <td class="py-4 px-6">
                                    <span class="bg-green-100 text-green-800 text-xs font-extrabold px-3 py-1 rounded-full border border-green-200">${jadwal.kelas}</span>
                                </td>
                                <td class="py-4 px-6 font-semibold text-indigo-700">${jadwal.mapel}</td>
                                <td class="py-4 px-6 text-gray-700 font-medium">${jadwal.guru}</td>
                            </tr>
                        `);
                    });
                }
            } catch (error) {
                console.error("Error:", error);
                document.getElementById('tabelJadwal').innerHTML = `<tr><td colspan="5" class="py-8 text-center text-red-500 font-bold bg-red-50">‚ö†Ô∏è Gagal memuat data. Periksa koneksi internet Anda.</td></tr>`;
            }

            btn.innerHTML = "üîç Cari"; btn.disabled = false;
        });

        // --- EXPORT KE EXCEL DENGAN WARNA OTOMATIS BERDASARKAN GURU ---
        window.exportKeExcel = function() {
            if(dataUntukExcel.length === 0) {
                alert("Tidak ada jadwal yang bisa didownload. Silakan klik tombol 'Cari' terlebih dahulu!");
                return;
            }

            // Buat Worksheet dari Data
            const ws = XLSX.utils.json_to_sheet(dataUntukExcel);
            
            // Palet warna lembut (pastel) untuk mewarnai baris berdasarkan nama guru
            const paletWarna = ["FFB3BA", "FFDFBA", "FFFFBA", "BAFFC9", "BAE1FF", "E8BAFF", "FFC4E1", "E2F0CB", "FFB7B2", "C7CEEA", "D4F0F0", "F3E0ECE"];
            let mapWarnaGuru = {};
            let counterWarna = 0;

            const range = XLSX.utils.decode_range(ws['!ref']);

            // 1. Styling untuk Header Tabel
            for(let C = range.s.c; C <= range.e.c; ++C) {
                const alamat = XLSX.utils.encode_cell({r:0, c:C});
                if(!ws[alamat]) continue;
                ws[alamat].s = {
                    font: { bold: true, color: { rgb: "FFFFFF" } },
                    fill: { fgColor: { rgb: "2563EB" } }, // Warna Biru
                    alignment: { horizontal: "center", vertical: "center" },
                    border: { top: {style: 'thin'}, bottom: {style: 'thin'}, left: {style: 'thin'}, right: {style: 'thin'} }
                };
            }

            // 2. Styling Data dan Pewarnaan Guru
            for(let R = 1; R <= range.e.r; ++R) {
                // Ambil nama guru dari kolom ke-5 (Indeks 4: Hari, Waktu, Kelas, Mapel, Guru)
                const selGuru = ws[XLSX.utils.encode_cell({r: R, c: 4})];
                const namaGuru = selGuru ? selGuru.v : "";

                // Tentukan warna untuk guru ini (jika belum ada, ambil warna baru)
                if (namaGuru && !mapWarnaGuru[namaGuru]) {
                    mapWarnaGuru[namaGuru] = paletWarna[counterWarna % paletWarna.length];
                    counterWarna++;
                }
                const warnaBaris = mapWarnaGuru[namaGuru] || "FFFFFF";

                for(let C = range.s.c; C <= range.e.c; ++C) {
                    const alamat = XLSX.utils.encode_cell({r:R, c:C});
                    if(!ws[alamat]) continue;
                    
                    ws[alamat].s = {
                        fill: { fgColor: { rgb: warnaBaris } }, // Beri warna background
                        border: {
                            top: {style: 'thin', color: {rgb: "DDDDDD"}},
                            bottom: {style: 'thin', color: {rgb: "DDDDDD"}},
                            left: {style: 'thin', color: {rgb: "DDDDDD"}},
                            right: {style: 'thin', color: {rgb: "DDDDDD"}}
                        },
                        alignment: { vertical: "center", wrapText: true }
                    };

                    // Bold nama gurunya biar makin jelas
                    if(C === 4) {
                        ws[alamat].s.font = { bold: true, color: { rgb: "333333" } };
                    }
                }
            }

            // Atur lebar kolom Excel
            ws['!cols'] = [
                {wch: 12}, // Hari
                {wch: 22}, // Waktu
                {wch: 12}, // Kelas
                {wch: 35}, // Mata Pelajaran
                {wch: 30}  // Guru Pengajar
            ];

            // Proses Download
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Jadwal Pelajaran");
            XLSX.writeFile(wb, "Jadwal_Sekolah_Export.xlsx");
        };
    </script>
</body>
</html>
