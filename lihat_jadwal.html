<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jadwal Pelajaran Sekolah</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Library Khusus Excel dengan Fitur Styling/Warna -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
</head>
<body class="bg-slate-50 min-h-screen font-sans">

    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white shadow-lg py-6 px-4 md:px-8 mb-8">
        <div class="max-w-6xl mx-auto flex flex-col md:flex-row items-center justify-between">
            <div class="flex items-center gap-4">
                <a href="index.html" class="flex items-center gap-2 bg-white/20 hover:bg-white/30 py-2 px-4 rounded-xl transition cursor-pointer text-white font-bold text-sm shadow-sm">
                    <span>üè†</span> Beranda
                </a>
                <div>
                    <h1 class="text-2xl font-extrabold tracking-wide">Papan Jadwal Pelajaran</h1>
                    <p class="text-blue-100 text-sm font-medium" id="teksNamaSekolah">Memuat info sekolah...</p>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 md:px-8 mb-12">
        <!-- Panel Pencarian (Disesuaikan layoutnya menjadi Grid agar rapi dengan 3 Filter) -->
        <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-100 mb-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
            <div class="w-full">
                <label class="block text-sm font-bold text-gray-700 mb-2">Pilih Hari</label>
                <select id="filterHari" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 bg-gray-50 font-medium">
                    <option value="Semua">-- Semua Hari --</option>
                    <option value="Senin">Senin</option><option value="Selasa">Selasa</option>
                    <option value="Rabu">Rabu</option><option value="Kamis">Kamis</option>
                    <option value="Jumat">Jumat</option><option value="Sabtu">Sabtu</option>
                </select>
            </div>
            
            <div class="w-full">
                <label class="block text-sm font-bold text-gray-700 mb-2">Pilih Kelas</label>
                <select id="filterKelas" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 bg-gray-50 font-medium">
                    <option value="Semua">-- Semua Kelas --</option>
                </select>
            </div>

            <!-- FITUR BARU: PILIH GURU -->
            <div class="w-full">
                <label class="block text-sm font-bold text-gray-700 mb-2">Pilih Guru</label>
                <select id="filterGuru" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 bg-gray-50 font-medium">
                    <option value="Semua">-- Semua Guru --</option>
                </select>
            </div>

            <div class="w-full flex gap-2">
                <button id="btnCari" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl shadow-md transition duration-200">
                    üîç Cari
                </button>
                <button onclick="exportKeExcel()" class="flex-1 bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-4 rounded-xl shadow-md transition duration-200 flex items-center justify-center gap-2">
                    üì• Excel
                </button>
            </div>
        </div>

        <!-- INFO TOTAL JAM MENGAJAR -->
        <div id="infoSesi" class="mb-4"></div>

        <!-- Tabel Jadwal -->
        <div class="bg-white rounded-2xl shadow-md overflow-hidden border border-gray-200">
            <div class="overflow-x-auto">
                <table class="min-w-full text-left border-collapse">
                    <thead class="bg-gray-800 text-white">
                        <tr>
                            <th class="py-4 px-4 uppercase font-bold text-sm tracking-wider whitespace-nowrap">Hari</th>
                            <th class="py-4 px-4 uppercase font-bold text-sm tracking-wider whitespace-nowrap">Waktu</th>
                            <th class="py-4 px-4 uppercase font-bold text-sm tracking-wider whitespace-nowrap">Kelas</th>
                            <th class="py-4 px-4 uppercase font-bold text-sm tracking-wider">Mata Pelajaran</th>
                            <th class="py-4 px-4 uppercase font-bold text-sm tracking-wider">Guru Pengajar</th>
                        </tr>
                    </thead>
                    <tbody id="tabelJadwal" class="divide-y divide-gray-200">
                        <tr>
                            <td colspan="5" class="py-12 text-center text-gray-500 font-medium">Klik tombol "Cari" untuk menampilkan jadwal pelajaran.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Script Utama -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // ========================================================
        // KONFIGURASI FIREBASE
        // ========================================================
        let firebaseConfig = { 
            apiKey: "API_KEY_ANDA",
            authDomain: "PROJECT_ID.firebaseapp.com",
            projectId: "PROJECT_ID",
            storageBucket: "PROJECT_ID.appspot.com",
            messagingSenderId: "SENDER_ID",
            appId: "APP_ID"
        };
        try {
            const module = await import("./firebase-config.js");
            if (module && module.firebaseConfig) { firebaseConfig = module.firebaseConfig; }
        } catch (error) { console.warn("Menjalankan mode lokal."); }

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- MUAT INFO SEKOLAH & FILTER DROPDOWN ---
        async function muatDataAwal() {
            if (firebaseConfig.apiKey === "API_KEY_ANDA") return;
            try {
                // Info Sekolah (Dengan Fallback Text)
                const docSnap = await getDoc(doc(db, "pengaturan", "info_sekolah"));
                const teksSekolah = document.getElementById('teksNamaSekolah');
                if (docSnap.exists() && docSnap.data().nama_sekolah) {
                    teksSekolah.innerText = docSnap.data().nama_sekolah;
                } else {
                    teksSekolah.innerText = "Jadwal Pelajaran Sekolah";
                }
                
                // Dropdown Kelas
                const kelasSnap = await getDocs(collection(db, "master_kelas"));
                const selectKelas = document.getElementById('filterKelas');
                kelasSnap.forEach(k => {
                    selectKelas.insertAdjacentHTML('beforeend', `<option value="${k.data().nama}">${k.data().nama}</option>`);
                });

                // Dropdown Guru (BARU)
                const guruSnap = await getDocs(collection(db, "master_guru"));
                const selectGuru = document.getElementById('filterGuru');
                guruSnap.forEach(g => {
                    selectGuru.insertAdjacentHTML('beforeend', `<option value="${g.data().nama}">${g.data().nama}</option>`);
                });

            } catch (error) { console.error("Gagal memuat data awal:", error); }
        }
        muatDataAwal();

        let dataUntukExcel = []; // Menyimpan data mentah untuk diexport

        // --- TAMPILKAN JADWAL KE TABEL ---
        document.getElementById('btnCari').addEventListener('click', async () => {
            if (firebaseConfig.apiKey === "API_KEY_ANDA") {
                document.getElementById('tabelJadwal').innerHTML = `<tr><td colspan="5" class="py-8 text-center text-orange-500 font-bold bg-orange-50">Harap hubungkan Firebase Anda terlebih dahulu.</td></tr>`;
                return;
            }

            const btn = document.getElementById('btnCari');
            btn.innerHTML = "‚è≥ Memuat..."; btn.disabled = true;

            const filterHari = document.getElementById('filterHari').value;
            const filterKelas = document.getElementById('filterKelas').value;
            const filterGuru = document.getElementById('filterGuru').value; // Mengambil nilai guru

            try {
                const querySnapshot = await getDocs(collection(db, "jadwal_pelajaran"));
                let jadwalDifilter = [];

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    
                    // Logika Pencarian Gabungan (Hari + Kelas + Guru)
                    let cocokHari = (filterHari === "Semua" || data.hari === filterHari);
                    let cocokKelas = (filterKelas === "Semua" || data.kelas === filterKelas);
                    let cocokGuru = (filterGuru === "Semua" || data.guru === filterGuru);
                    
                    // Hanya masukkan jadwal jika memenuhi KETIGA syarat filter di atas
                    if (cocokHari && cocokKelas && cocokGuru) jadwalDifilter.push(data);
                });

                // Fungsi untuk menemukan jam dari kolom waktu saja (tanpa Jam Ke)
                function getMenit(jadwal) {
                    const teks = String(jadwal.waktu || "");
                    const match = teks.match(/(\d{1,2})[:.](\d{2})/);
                    if (match) {
                        return (parseInt(match[1], 10) * 60) + parseInt(match[2], 10);
                    }
                    return 999999;
                }

                // --- LOGIKA PENGURUTAN TANPA JAM KE- ---
                jadwalDifilter.sort((a, b) => {
                    // 1. Urutkan Hari
                    const urutanHari = { "Senin":1, "Selasa":2, "Rabu":3, "Kamis":4, "Jumat":5, "Sabtu":6, "Minggu":7 };
                    const hariA = urutanHari[a.hari] || 99;
                    const hariB = urutanHari[b.hari] || 99;
                    if (hariA !== hariB) return hariA - hariB;

                    // 2. Urutkan Waktu (Membaca langsung dari teks waktu)
                    const menitA = getMenit(a);
                    const menitB = getMenit(b);
                    if (menitA !== menitB) return menitA - menitB;

                    // 3. Fallback terakhir jika waktu sama persis, urutkan nama kelas
                    return String(a.kelas || "").localeCompare(String(b.kelas || ""));
                });

                // --- TAMPILKAN INFO JUMLAH JAM JIKA GURU DIPILIH ---
                const infoSesi = document.getElementById('infoSesi');
                if (filterGuru !== "Semua") {
                    infoSesi.innerHTML = `
                        <div class="bg-indigo-50 text-indigo-900 p-4 rounded-xl font-bold border border-indigo-200 shadow-sm flex items-center justify-between">
                            <span class="text-sm md:text-base">üë®‚Äçüè´ Total Jam Mengajar <span class="text-indigo-600 text-lg uppercase">${filterGuru}</span> :</span>
                            <span class="bg-indigo-600 text-white px-4 py-1.5 rounded-lg text-lg shadow-inner">${jadwalDifilter.length} Jam</span>
                        </div>`;
                } else {
                    infoSesi.innerHTML = '';
                }

                const tbody = document.getElementById('tabelJadwal');
                tbody.innerHTML = ""; 
                dataUntukExcel = []; 

                if (jadwalDifilter.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" class="py-12 text-center font-bold text-gray-500 bg-gray-50">‚ùå Tidak ada jadwal yang ditemukan.</td></tr>`;
                } else {
                    jadwalDifilter.forEach(jadwal => {
                        // Persiapkan format Waktu untuk Excel dan Tabel
                        const teksWaktu = jadwal.waktu ? jadwal.waktu : "-";

                        // Masukkan ke array Excel (Tanpa Jam Ke)
                        dataUntukExcel.push({
                            "Hari": jadwal.hari,
                            "Waktu": teksWaktu,
                            "Kelas": jadwal.kelas,
                            "Mata Pelajaran": jadwal.mapel,
                            "Guru Pengajar": jadwal.guru
                        });

                        // Tampilkan di Tabel HTML (Badge Jam Ke dihilangkan, Waktu dipercantik)
                        tbody.insertAdjacentHTML('beforeend', `
                            <tr class="hover:bg-blue-50 transition duration-150 border-b border-gray-100">
                                <td class="py-4 px-4 font-bold text-gray-800 whitespace-nowrap">${jadwal.hari}</td>
                                <td class="py-4 px-4 whitespace-nowrap">
                                    <span class="font-bold text-blue-800 bg-blue-100 px-3 py-1.5 rounded-lg border border-blue-200 shadow-sm">${teksWaktu}</span>
                                </td>
                                <td class="py-4 px-4 whitespace-nowrap">
                                    <span class="bg-green-100 text-green-800 text-sm font-extrabold px-3 py-1 rounded-lg border border-green-200">${jadwal.kelas}</span>
                                </td>
                                <td class="py-4 px-4 font-bold text-indigo-700">${jadwal.mapel}</td>
                                <td class="py-4 px-4 text-gray-700 font-semibold">${jadwal.guru}</td>
                            </tr>
                        `);
                    });
                }
            } catch (error) {
                console.error("Error:", error);
                document.getElementById('tabelJadwal').innerHTML = `<tr><td colspan="5" class="py-8 text-center text-red-500 font-bold bg-red-50">‚ö†Ô∏è Gagal memuat data. Periksa koneksi internet Anda.</td></tr>`;
            }

            btn.innerHTML = "üîç Cari"; btn.disabled = false;
        });

        // --- EXPORT KE EXCEL DENGAN WARNA OTOMATIS BERDASARKAN GURU ---
        window.exportKeExcel = function() {
            if(dataUntukExcel.length === 0) {
                alert("Tidak ada jadwal yang bisa didownload. Silakan klik tombol 'Cari' terlebih dahulu!");
                return;
            }

            // Buat Worksheet dari Data
            const ws = XLSX.utils.json_to_sheet(dataUntukExcel);
            
            // Palet warna lembut (pastel) untuk mewarnai baris berdasarkan nama guru
            const paletWarna = ["FFB3BA", "FFDFBA", "FFFFBA", "BAFFC9", "BAE1FF", "E8BAFF", "FFC4E1", "E2F0CB", "FFB7B2", "C7CEEA", "D4F0F0", "F3E0ECE"];
            let mapWarnaGuru = {};
            let counterWarna = 0;

            const range = XLSX.utils.decode_range(ws['!ref']);

            // 1. Styling untuk Header Tabel
            for(let C = range.s.c; C <= range.e.c; ++C) {
                const alamat = XLSX.utils.encode_cell({r:0, c:C});
                if(!ws[alamat]) continue;
                ws[alamat].s = {
                    font: { bold: true, color: { rgb: "FFFFFF" } },
                    fill: { fgColor: { rgb: "2563EB" } }, // Warna Biru
                    alignment: { horizontal: "center", vertical: "center" },
                    border: { top: {style: 'thin'}, bottom: {style: 'thin'}, left: {style: 'thin'}, right: {style: 'thin'} }
                };
            }

            // 2. Styling Data dan Pewarnaan Guru
            for(let R = 1; R <= range.e.r; ++R) {
                // Ambil nama guru dari kolom ke-5 (Indeks 4: Hari, Waktu, Kelas, Mapel, Guru)
                const selGuru = ws[XLSX.utils.encode_cell({r: R, c: 4})];
                const namaGuru = selGuru ? selGuru.v : "";

                // Tentukan warna untuk guru ini (jika belum ada, ambil warna baru)
                if (namaGuru && !mapWarnaGuru[namaGuru]) {
                    mapWarnaGuru[namaGuru] = paletWarna[counterWarna % paletWarna.length];
                    counterWarna++;
                }
                const warnaBaris = mapWarnaGuru[namaGuru] || "FFFFFF";

                for(let C = range.s.c; C <= range.e.c; ++C) {
                    const alamat = XLSX.utils.encode_cell({r:R, c:C});
                    if(!ws[alamat]) continue;
                    
                    ws[alamat].s = {
                        fill: { fgColor: { rgb: warnaBaris } }, // Beri warna background
                        border: {
                            top: {style: 'thin', color: {rgb: "DDDDDD"}},
                            bottom: {style: 'thin', color: {rgb: "DDDDDD"}},
                            left: {style: 'thin', color: {rgb: "DDDDDD"}},
                            right: {style: 'thin', color: {rgb: "DDDDDD"}}
                        },
                        alignment: { vertical: "center", wrapText: true }
                    };

                    // Bold nama gurunya biar makin jelas
                    if(C === 4) {
                        ws[alamat].s.font = { bold: true, color: { rgb: "333333" } };
                    }
                }
            }

            // Atur lebar kolom Excel
            ws['!cols'] = [
                {wch: 12}, // Hari
                {wch: 22}, // Waktu
                {wch: 12}, // Kelas
                {wch: 35}, // Mata Pelajaran
                {wch: 30}  // Guru Pengajar
            ];

            // Proses Download
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Jadwal Pelajaran");
            XLSX.writeFile(wb, "Jadwal_Sekolah_Export.xlsx");
        };
    </script>
</body>
</html>
