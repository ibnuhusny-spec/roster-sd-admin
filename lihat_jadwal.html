<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lihat Jadwal Pelajaran</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Library ExcelJS untuk Export Excel dengan Styling Warna & Border -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-gray-800">

    <!-- Navbar Sederhana -->
    <nav class="bg-blue-700 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <img src="logo1.png" alt="Logo Sekolah" class="h-10 w-auto object-contain bg-white p-1 rounded-full shadow-sm" onerror="this.src='https://ui-avatars.com/api/?name=JS&background=fff&color=1d4ed8&rounded=true'">
                    <span class="font-bold text-white text-lg tracking-wide" id="teksNamaSekolah">Jadwal Pelajaran</span>
                </div>
                <div>
                    <a href="/index.html" class="text-blue-100 hover:text-white font-medium flex items-center gap-1 transition">
                        <span>üè†</span> Kembali
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto p-4 md:p-8">
        
        <div class="flex flex-col md:flex-row justify-between items-end mb-6 gap-4 bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
            <div>
                <h1 class="text-3xl font-extrabold text-blue-800 mb-2">üìÖ Jadwal Pelajaran</h1>
                <p class="text-gray-500">Pilih kelas atau guru untuk melihat jadwal secara spesifik.</p>
            </div>
            
            <div class="flex flex-wrap items-center gap-3 w-full md:w-auto">
                <div class="flex-grow md:flex-grow-0">
                    <label class="block text-sm font-bold text-gray-600 mb-1">Hari:</label>
                    <select id="filterHari" onchange="tampilkanJadwal()" class="w-full md:w-36 p-2.5 border border-gray-300 rounded-xl bg-gray-50 focus:ring-2 focus:ring-blue-500 font-semibold text-blue-700 shadow-sm cursor-pointer">
                        <option value="Semua">Semua Hari</option>
                        <option value="Senin">Senin</option>
                        <option value="Selasa">Selasa</option>
                        <option value="Rabu">Rabu</option>
                        <option value="Kamis">Kamis</option>
                        <option value="Jumat">Jumat</option>
                        <option value="Sabtu">Sabtu</option>
                        <option value="Minggu">Minggu</option>
                    </select>
                </div>

                <div class="flex-grow md:flex-grow-0">
                    <label class="block text-sm font-bold text-gray-600 mb-1">Kelas:</label>
                    <select id="filterKelas" onchange="tampilkanJadwal()" class="w-full md:w-36 p-2.5 border border-gray-300 rounded-xl bg-gray-50 focus:ring-2 focus:ring-blue-500 font-semibold text-blue-700 shadow-sm cursor-pointer">
                        <option value="Semua">Semua Kelas</option>
                    </select>
                </div>

                <div class="flex-grow md:flex-grow-0">
                    <label class="block text-sm font-bold text-gray-600 mb-1">Guru:</label>
                    <select id="filterGuru" onchange="tampilkanJadwal()" class="w-full md:w-48 p-2.5 border border-gray-300 rounded-xl bg-gray-50 focus:ring-2 focus:ring-blue-500 font-semibold text-blue-700 shadow-sm cursor-pointer">
                        <option value="Semua">Semua Guru</option>
                    </select>
                </div>
                
                <button onclick="bukaModalExport()" class="mt-auto h-[46px] bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-xl shadow-md shadow-green-200 transition transform hover:-translate-y-0.5 flex items-center gap-2">
                    üì• Download Excel
                </button>
            </div>
        </div>

        <!-- Info Jam Mengajar (Muncul Otomatis saat Guru Dipilih) -->
        <div id="infoJamMengajar" class="hidden mb-6 transition-all duration-300 transform origin-top scale-95 opacity-0">
            <div class="inline-flex items-center p-4 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-2xl shadow-lg border border-blue-400 w-full md:w-auto">
                <div class="p-3 bg-white/20 rounded-xl backdrop-blur-sm mr-4 text-white shadow-inner">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                <div>
                    <p class="text-blue-100 text-sm font-medium mb-0.5">Total Jam Mengajar <span id="namaGuruInfo" class="font-bold text-white ml-1"></span></p>
                    <div class="flex items-baseline gap-1.5">
                        <span id="angkaJamMengajar" class="text-3xl font-extrabold text-white leading-none tracking-tight">0</span>
                        <span class="text-blue-200 font-semibold text-sm uppercase tracking-wider">Jam Pelajaran (JP)</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabel Jadwal Publik -->
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-200">
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm text-left border-collapse">
                    <thead class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white uppercase font-bold text-xs tracking-wider">
                        <tr>
                            <th class="py-4 px-5 w-24">Hari</th>
                            <th class="py-4 px-5 w-32">Waktu</th>
                            <th class="py-4 px-5 w-24">Kelas</th>
                            <th class="py-4 px-5">Mata Pelajaran</th>
                            <th class="py-4 px-5">Guru Pengajar</th>
                        </tr>
                    </thead>
                    <tbody id="tabelJadwal" class="bg-white">
                        <tr><td colspan="5" class="text-center py-8 text-gray-500 animate-pulse">Memuat data jadwal pelajaran...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MODAL EXPORT EXCEL -->
    <div id="modalExportExcel" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center p-4 backdrop-blur-sm transition-opacity overflow-y-auto">
        <div class="bg-white rounded-2xl shadow-2xl p-6 md:p-8 w-full max-w-2xl transform scale-100 transition-transform my-8">
            <div class="mb-6 border-b pb-4">
                <h3 class="text-2xl font-bold text-green-700 flex items-center gap-2">üì• Download Roster Siap Cetak</h3>
                <p class="text-sm text-gray-500 mt-1">Lengkapi data di bawah ini untuk mengisi KOP dan Tanda Tangan pada file Excel.</p>
            </div>
            
            <form id="formExport" onsubmit="prosesExportExcel(event)" class="space-y-4">
                
                <!-- NAMA SEKOLAH -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Nama Sekolah</label>
                    <input type="text" id="exNamaSekolah" placeholder="Contoh: SD Negeri 1 Jakarta" class="w-full p-2.5 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-green-500 text-blue-800 font-semibold uppercase" required>
                </div>

                <!-- Tahun & Tempat -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Tahun Pelajaran</label>
                        <input type="text" id="exTahun" placeholder="Contoh: 2024/2025" class="w-full p-2.5 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-green-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Tempat, Tanggal Pembuatan</label>
                        <input type="text" id="exTempatTgl" placeholder="Contoh: Makassar, 15 Juli 2024" class="w-full p-2.5 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-green-500" required>
                    </div>
                </div>

                <!-- Kepala Sekolah -->
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 mt-2">
                    <h4 class="font-bold text-blue-800 mb-3 text-sm flex items-center gap-2">üë®‚Äçüíº Data Kepala Sekolah</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">Nama Kepala Sekolah</label>
                            <input type="text" id="exNamaKepsek" placeholder="Nama Lengkap beserta gelar" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">NIP Kepala Sekolah</label>
                            <input type="text" id="exNipKepsek" placeholder="Nomor Induk Pegawai" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                    </div>
                </div>

                <!-- Wali Kelas / Guru -->
                <div class="bg-green-50 p-4 rounded-xl border border-green-100 mt-2">
                    <h4 class="font-bold text-green-800 mb-3 text-sm flex items-center gap-2">üë©‚Äçüè´ Data Wali Kelas / Guru <span id="labelWaliKelas" class="font-normal text-xs bg-green-200 text-green-800 px-2 py-0.5 rounded"></span></h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">Nama Wali / Guru</label>
                            <input type="text" id="exNamaWali" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">NIP Wali / Guru</label>
                            <input type="text" id="exNipWali" placeholder="Kosongkan jika tidak ada" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                        </div>
                    </div>
                </div>
                
                <div class="flex flex-col-reverse sm:flex-row gap-3 mt-6 pt-4 border-t">
                    <button type="button" onclick="tutupModal('modalExportExcel')" class="w-full sm:w-1/3 px-4 py-3 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-xl font-semibold transition-colors">Batal</button>
                    <button type="submit" id="btnProsesExport" class="w-full sm:w-2/3 px-4 py-3 text-white bg-green-600 hover:bg-green-700 shadow-lg shadow-green-200 rounded-xl font-bold transition-all flex justify-center items-center gap-2">
                        <span>üì•</span> Unduh File Excel Sekarang
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFirestore, collection, getDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // Konfigurasi Firebase
        let firebaseConfig = { 
            apiKey: "API_KEY_ANDA",
            authDomain: "PROJECT_ID.firebaseapp.com",
            projectId: "PROJECT_ID",
            storageBucket: "PROJECT_ID.appspot.com",
            messagingSenderId: "SENDER_ID",
            appId: "APP_ID"
        };
        try {
            const module = await import("./firebase-config.js");
            if (module && module.firebaseConfig) { firebaseConfig = module.firebaseConfig; }
        } catch (error) { console.warn("Menjalankan mode lokal tanpa Firebase Config eksternal."); }

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let semuaJadwal = [];
        let namaSekolahSistem = "NAMA SEKOLAH BELUM DISETTING";

        // --- MENGAMBIL INFO SEKOLAH ---
        async function ambilInfoSekolah() {
            if (firebaseConfig.apiKey === "API_KEY_ANDA") return;
            try {
                const docSnap = await getDoc(doc(db, "pengaturan", "info_sekolah"));
                if (docSnap.exists() && docSnap.data().nama_sekolah) {
                    namaSekolahSistem = docSnap.data().nama_sekolah;
                    document.getElementById('teksNamaSekolah').innerText = namaSekolahSistem;
                }
            } catch (e) { console.error("Gagal mengambil info sekolah", e); }
        }
        ambilInfoSekolah();

        // --- MEMUAT FILTER KELAS ---
        function muatFilterKelas() {
            if (firebaseConfig.apiKey === "API_KEY_ANDA") return;
            onSnapshot(collection(db, "master_kelas"), (snapshot) => {
                const selectEl = document.getElementById('filterKelas');
                selectEl.innerHTML = '<option value="Semua">Semua Kelas</option>';
                
                let kelasArr = [];
                snapshot.forEach(docSnap => kelasArr.push(docSnap.data().nama));
                kelasArr.sort((a,b) => a.localeCompare(b));
                
                kelasArr.forEach(nama => {
                    selectEl.insertAdjacentHTML('beforeend', `<option value="${nama}">${nama}</option>`);
                });
            });
        }
        muatFilterKelas();

        // --- MEMUAT FILTER GURU ---
        function muatFilterGuru() {
            if (firebaseConfig.apiKey === "API_KEY_ANDA") return;
            onSnapshot(collection(db, "master_guru"), (snapshot) => {
                const selectEl = document.getElementById('filterGuru');
                selectEl.innerHTML = '<option value="Semua">Semua Guru</option>';
                
                let guruArr = [];
                snapshot.forEach(docSnap => guruArr.push(docSnap.data().nama));
                guruArr.sort((a,b) => a.localeCompare(b));
                
                guruArr.forEach(nama => {
                    selectEl.insertAdjacentHTML('beforeend', `<option value="${nama}">${nama}</option>`);
                });
            });
        }
        muatFilterGuru();

        // --- URUTAN HARI ---
        const urutanHari = { "Senin":1, "Selasa":2, "Rabu":3, "Kamis":4, "Jumat":5, "Sabtu":6, "Minggu":7 };

        // --- MEMUAT JADWAL PELAJARAN ---
        function muatDataJadwal() {
            if (firebaseConfig.apiKey === "API_KEY_ANDA") return;
            onSnapshot(collection(db, "jadwal_pelajaran"), (snapshot) => {
                semuaJadwal = [];
                snapshot.forEach(docSnap => {
                    semuaJadwal.push({ id: docSnap.id, ...docSnap.data() });
                });
                tampilkanJadwal();
            });
        }
        muatDataJadwal();

        // --- MENAMPILKAN JADWAL DI TABEL & JUMLAH JAM ---
        window.tampilkanJadwal = function() {
            const tabel = document.getElementById('tabelJadwal');
            const kelasDipilih = document.getElementById('filterKelas').value;
            const hariDipilih = document.getElementById('filterHari').value;
            const guruDipilih = document.getElementById('filterGuru').value;
            tabel.innerHTML = '';

            let jadwalTerfilter = semuaJadwal.filter(j => {
                let matchKelas = (kelasDipilih === "Semua" || j.kelas === kelasDipilih);
                let matchHari = (hariDipilih === "Semua" || j.hari === hariDipilih);
                let matchGuru = (guruDipilih === "Semua" || j.guru === guruDipilih);
                return matchKelas && matchHari && matchGuru;
            });

            // LOGIKA MENAMPILKAN KARTU JUMLAH JAM MENGAJAR
            const infoJamDiv = document.getElementById('infoJamMengajar');
            const angkaJamSpan = document.getElementById('angkaJamMengajar');
            const namaGuruSpan = document.getElementById('namaGuruInfo');

            if (guruDipilih !== "Semua") {
                // Tampilkan card dengan animasi
                infoJamDiv.classList.remove('hidden');
                setTimeout(() => {
                    infoJamDiv.classList.remove('scale-95', 'opacity-0');
                    infoJamDiv.classList.add('scale-100', 'opacity-100');
                }, 10); // sedikit jeda agar animasi berjalan

                angkaJamSpan.innerText = jadwalTerfilter.length;
                namaGuruSpan.innerText = `(${guruDipilih})`;
            } else {
                // Sembunyikan card dengan animasi
                infoJamDiv.classList.remove('scale-100', 'opacity-100');
                infoJamDiv.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    infoJamDiv.classList.add('hidden');
                }, 300); // jeda sesuai dengan duration-300 di class CSS
            }

            // Urutkan berdasarkan Hari lalu Waktu
            jadwalTerfilter.sort((a, b) => {
                if (urutanHari[a.hari] !== urutanHari[b.hari]) {
                    return urutanHari[a.hari] - urutanHari[b.hari];
                }
                return (a.waktu || "").localeCompare(b.waktu || "");
            });

            if (jadwalTerfilter.length === 0) {
                tabel.innerHTML = `<tr><td colspan="5" class="text-center py-10 text-gray-500 text-lg bg-gray-50">üì≠ Belum ada jadwal yang sesuai dengan filter.</td></tr>`;
                return;
            }

            jadwalTerfilter.forEach((j, index) => {
                const isEven = index % 2 === 0;
                const rowBgClass = isEven ? 'bg-white' : 'bg-slate-50';

                let bgHari = "bg-gray-100 text-gray-700 border border-gray-200";
                if(j.hari === "Senin") bgHari = "bg-red-50 text-red-700 border border-red-200";
                if(j.hari === "Selasa") bgHari = "bg-orange-50 text-orange-700 border border-orange-200";
                if(j.hari === "Rabu") bgHari = "bg-amber-50 text-amber-700 border border-amber-200";
                if(j.hari === "Kamis") bgHari = "bg-emerald-50 text-emerald-700 border border-emerald-200";
                if(j.hari === "Jumat") bgHari = "bg-sky-50 text-sky-700 border border-sky-200";
                if(j.hari === "Sabtu") bgHari = "bg-indigo-50 text-indigo-700 border border-indigo-200";

                const guruCell = j.guru 
                    ? `<div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-green-500"></span><span class="font-medium text-gray-700">${j.guru}</span></div>` 
                    : `<span class="text-rose-500 italic text-sm font-medium">Belum ditentukan</span>`;

                tabel.insertAdjacentHTML('beforeend', `
                    <tr class="hover:bg-blue-50 transition-colors duration-200 border-b border-gray-100 ${rowBgClass}">
                        <td class="py-4 px-5 align-middle">
                            <span class="inline-block px-3 py-1 rounded-md font-bold text-xs shadow-sm ${bgHari}">${j.hari}</span>
                        </td>
                        <td class="py-4 px-5 align-middle font-semibold text-gray-600 whitespace-nowrap">${j.waktu}</td>
                        <td class="py-4 px-5 align-middle">
                            <span class="bg-indigo-100 text-indigo-800 text-sm font-bold px-2.5 py-1 rounded border border-indigo-200">${j.kelas}</span>
                        </td>
                        <td class="py-4 px-5 align-middle font-medium text-gray-800">${j.mapel}</td>
                        <td class="py-4 px-5 align-middle">${guruCell}</td>
                    </tr>
                `);
            });
        };

        // ==========================================
        // FITUR EXPORT EXCELJS (KOP SURAT & TTD)
        // ==========================================
        
        window.tutupModal = function(idModal) {
            document.getElementById(idModal).classList.add('hidden');
        };

        window.bukaModalExport = function() {
            if (semuaJadwal.length === 0) {
                return alert("‚ö†Ô∏è Tidak ada data jadwal yang bisa di-export saat ini.");
            }
            const kelasAktif = document.getElementById('filterKelas').value;
            const guruAktif = document.getElementById('filterGuru').value;
            
            // Ambil data dari LocalStorage
            const dataTersimpan = JSON.parse(localStorage.getItem('savedDataExportExcelPublic') || '{}');

            document.getElementById('exNamaSekolah').value = (namaSekolahSistem !== "NAMA SEKOLAH BELUM DISETTING") 
                ? namaSekolahSistem 
                : (dataTersimpan.sekolah || "");
            
            const bulanIndo = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            const tglSekarang = new Date();
            const formatTgl = `${tglSekarang.getDate()} ${bulanIndo[tglSekarang.getMonth()]} ${tglSekarang.getFullYear()}`;
            
            document.getElementById('exTahun').value = dataTersimpan.tahun || `${tglSekarang.getFullYear()}/${tglSekarang.getFullYear() + 1}`;
            document.getElementById('exTempatTgl').value = dataTersimpan.tempat || `Makassar, ${formatTgl}`;
            
            document.getElementById('exNamaKepsek').value = dataTersimpan.kepsek || "";
            document.getElementById('exNipKepsek').value = dataTersimpan.nipKepsek || "";
            
            if (guruAktif !== "Semua") {
                document.getElementById('labelWaliKelas').innerText = `(Guru: ${guruAktif})`;
                document.getElementById('exNamaWali').placeholder = `Nama Guru Yang Bersangkutan`;
                document.getElementById('exNamaWali').value = guruAktif; 
                document.getElementById('exNipWali').value = "";
            } else if (kelasAktif !== "Semua") {
                document.getElementById('labelWaliKelas').innerText = `(Kelas ${kelasAktif})`;
                document.getElementById('exNamaWali').placeholder = `Masukkan Nama Wali Kelas ${kelasAktif}`;
                document.getElementById('exNamaWali').value = ""; 
                document.getElementById('exNipWali').value = "";
            } else {
                document.getElementById('labelWaliKelas').innerText = `(Dikosongkan karena ekspor Semua Data)`;
                document.getElementById('exNamaWali').placeholder = `Kosongkan jika ekspor semua data`;
                document.getElementById('exNamaWali').value = ""; 
                document.getElementById('exNipWali').value = "";
            }

            document.getElementById('modalExportExcel').classList.remove('hidden');
        };

        window.prosesExportExcel = async function(e) {
            e.preventDefault();

            const btnExport = document.getElementById('btnProsesExport');
            const teksAwalBtn = btnExport.innerHTML;
            btnExport.innerHTML = "‚è≥ Sedang Menyiapkan Excel..."; btnExport.disabled = true;

            try {
                const namaSekolahExport = document.getElementById('exNamaSekolah').value.toUpperCase();
                const tahun = document.getElementById('exTahun').value.toUpperCase();
                const tempatTgl = document.getElementById('exTempatTgl').value;
                const kepsek = document.getElementById('exNamaKepsek').value;
                const nipKepsek = document.getElementById('exNipKepsek').value;
                const wali = document.getElementById('exNamaWali').value || "....................................";
                const nipWali = document.getElementById('exNipWali').value || "..................";
                
                const kelasAktif = document.getElementById('filterKelas').value;
                const hariAktif = document.getElementById('filterHari').value;
                const guruAktif = document.getElementById('filterGuru').value;

                localStorage.setItem('savedDataExportExcelPublic', JSON.stringify({
                    sekolah: namaSekolahExport,
                    tahun: document.getElementById('exTahun').value,
                    tempat: tempatTgl,
                    kepsek: kepsek,
                    nipKepsek: nipKepsek
                }));
                
                let dataExport = semuaJadwal.filter(j => {
                    let matchKelas = (kelasAktif === "Semua" || j.kelas === kelasAktif);
                    let matchHari = (hariAktif === "Semua" || j.hari === hariAktif);
                    let matchGuru = (guruAktif === "Semua" || j.guru === guruAktif);
                    return matchKelas && matchHari && matchGuru;
                });

                dataExport.sort((a, b) => {
                    if (urutanHari[a.hari] !== urutanHari[b.hari]) return urutanHari[a.hari] - urutanHari[b.hari];
                    return (a.waktu || "").localeCompare(b.waktu || "");
                });

                const wb = new ExcelJS.Workbook();
                let sheetName = "Jadwal";
                if(kelasAktif !== "Semua") sheetName += `_Kls_${kelasAktif}`;
                if(guruAktif !== "Semua") sheetName += `_Guru`;
                if(sheetName === "Jadwal") sheetName = "Semua_Jadwal";
                sheetName = sheetName.substring(0, 31); 
                
                const ws = wb.addWorksheet(sheetName);

                const centerAlign = { vertical: 'middle', horizontal: 'center' };
                const borderAll = {
                    top: {style:'thin'}, left: {style:'thin'},
                    bottom: {style:'thin'}, right: {style:'thin'}
                };

                ws.mergeCells('A1:E1');
                ws.getCell('A1').value = "ROSTER MATA PELAJARAN";
                ws.getCell('A1').font = { bold: true, size: 14 };
                ws.getCell('A1').alignment = centerAlign;

                ws.mergeCells('A2:E2');
                ws.getCell('A2').value = namaSekolahExport; 
                ws.getCell('A2').font = { bold: true, size: 12 };
                ws.getCell('A2').alignment = centerAlign;

                ws.mergeCells('A3:E3');
                ws.getCell('A3').value = "TAHUN PELAJARAN " + tahun;
                ws.getCell('A3').font = { bold: true, size: 11 };
                ws.getCell('A3').alignment = centerAlign;

                let startRow = 4;
                
                if (kelasAktif !== "Semua") {
                    ws.mergeCells(`A${startRow}:E${startRow}`);
                    ws.getCell(`A${startRow}`).value = "KELAS: " + kelasAktif;
                    ws.getCell(`A${startRow}`).font = { bold: true, size: 11 };
                    ws.getCell(`A${startRow}`).alignment = centerAlign;
                    startRow++;
                }
                if (guruAktif !== "Semua") {
                    ws.mergeCells(`A${startRow}:E${startRow}`);
                    ws.getCell(`A${startRow}`).value = "GURU: " + guruAktif;
                    ws.getCell(`A${startRow}`).font = { bold: true, size: 11 };
                    ws.getCell(`A${startRow}`).alignment = centerAlign;
                    startRow++;
                }
                
                if (kelasAktif === "Semua" && guruAktif === "Semua") {
                     startRow++; 
                }

                const headers = ["Hari", "Waktu", "Kelas", "Mata Pelajaran", "Guru Pengajar"];
                const headerRow = ws.getRow(startRow);
                headers.forEach((h, i) => {
                    const cell = headerRow.getCell(i + 1);
                    cell.value = h;
                    cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1E3A8A' } };
                    cell.alignment = centerAlign;
                    cell.border = borderAll;
                });

                startRow++;

                const warnaKontras = [
                    'FFFFFF99', 'FF99FF99', 'FF99FFFF', 'FF99CCFF', 'FFCC99FF', 
                    'FFFF99CC', 'FFFF9999', 'FFFFCC99', 'FFCCFF99', 'FF66FFCC', 
                    'FFFF66FF', 'FFFFD700', 'FFB3B3CC', 'FFFFB366', 'FF99FFCC'
                ];
                let warnaGuruMap = {};
                let indeksWarna = 0;

                dataExport.forEach((j) => {
                    const row = ws.getRow(startRow);
                    row.getCell(1).value = j.hari;
                    row.getCell(2).value = j.waktu;
                    row.getCell(3).value = j.kelas;
                    row.getCell(4).value = j.mapel;
                    row.getCell(5).value = j.guru || "";

                    for(let i=1; i<=5; i++) {
                        const cell = row.getCell(i);
                        cell.border = borderAll;
                        cell.alignment = { vertical: 'middle', horizontal: 'left' };
                        if (i <= 3) cell.alignment = centerAlign;
                    }

                    if (j.guru) {
                        if (!warnaGuruMap[j.guru]) {
                            warnaGuruMap[j.guru] = warnaKontras[indeksWarna % warnaKontras.length];
                            indeksWarna++;
                        }
                        const warnaBaris = warnaGuruMap[j.guru];
                        for(let i=1; i<=5; i++) {
                             row.getCell(i).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: warnaBaris } };
                        }
                    } else {
                         row.getCell(5).font = { color: { argb: 'FFFF0000' }, italic: true };
                         row.getCell(5).value = "Belum ditentukan";
                    }

                    startRow++;
                });

                ws.getColumn(1).width = 15;
                ws.getColumn(2).width = 20;
                ws.getColumn(3).width = 12;
                ws.getColumn(4).width = 35;
                ws.getColumn(5).width = 35;

                let footerRow = startRow + 2;

                ws.mergeCells(`D${footerRow}:E${footerRow}`);
                ws.getCell(`D${footerRow}`).value = tempatTgl;
                ws.getCell(`D${footerRow}`).alignment = centerAlign;

                footerRow++;
                ws.mergeCells(`A${footerRow}:B${footerRow}`);
                ws.getCell(`A${footerRow}`).value = "Mengetahui,";
                ws.getCell(`A${footerRow}`).alignment = centerAlign;

                ws.mergeCells(`D${footerRow}:E${footerRow}`);
                ws.getCell(`D${footerRow}`).value = (guruAktif !== "Semua") ? "Guru Pengajar," : "Wali Kelas,";
                ws.getCell(`D${footerRow}`).alignment = centerAlign;

                footerRow++;
                ws.mergeCells(`A${footerRow}:B${footerRow}`);
                ws.getCell(`A${footerRow}`).value = "Kepala Sekolah,";
                ws.getCell(`A${footerRow}`).alignment = centerAlign;

                footerRow += 4; 

                ws.mergeCells(`A${footerRow}:B${footerRow}`);
                ws.getCell(`A${footerRow}`).value = kepsek;
                ws.getCell(`A${footerRow}`).font = { bold: true, underline: true };
                ws.getCell(`A${footerRow}`).alignment = centerAlign;

                ws.mergeCells(`D${footerRow}:E${footerRow}`);
                ws.getCell(`D${footerRow}`).value = wali;
                ws.getCell(`D${footerRow}`).font = { bold: true, underline: true };
                ws.getCell(`D${footerRow}`).alignment = centerAlign;

                footerRow++;
                ws.mergeCells(`A${footerRow}:B${footerRow}`);
                ws.getCell(`A${footerRow}`).value = "NIP. " + nipKepsek;
                ws.getCell(`A${footerRow}`).alignment = centerAlign;

                ws.mergeCells(`D${footerRow}:E${footerRow}`);
                ws.getCell(`D${footerRow}`).value = "NIP. " + nipWali;
                ws.getCell(`D${footerRow}`).alignment = centerAlign;

                const buffer = await wb.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                const fileName = `Jadwal_${sheetName}_${tahun.replace('/', '-')}.xlsx`;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                tutupModal('modalExportExcel');

            } catch (error) {
                console.error("Gagal export excel:", error);
                alert("‚ùå Terjadi kesalahan saat membuat file Excel.");
            }

            btnExport.innerHTML = teksAwalBtn; btnExport.disabled = false;
        };
    </script>
</body>
</html>
