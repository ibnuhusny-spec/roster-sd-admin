<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Input Jadwal SD - Admin</title>
    <!-- Menggunakan Tailwind CSS untuk desain agar langsung terlihat rapi di HP/Laptop -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8 font-sans text-gray-800">
<!-- Tombol Navigasi -->
    <div class="max-w-lg mx-auto mb-4 text-right">
        <a href="/lihat_jadwal.html" class="inline-block bg-green-100 text-green-700 hover:bg-green-200 font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-sm">
            Lihat Jadwal Pelajaran &rarr;
        </a>
    </div>
    <div class="max-w-lg mx-auto bg-white rounded-xl shadow-md overflow-hidden p-6 md:p-8">
        <h2 class="text-2xl font-bold text-center text-blue-600 mb-6">Susun Jadwal Pelajaran</h2>
        
        <!-- Tempat munculnya pesan sukses atau error -->
        <div id="pesanBox" class="hidden p-4 mb-6 rounded-lg font-medium text-sm"></div>

        <form id="formJadwal" class="space-y-4">
            
            <div>
                <label class="block text-sm font-semibold mb-1">Hari</label>
                <select id="hari" required class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- Pilih Hari --</option>
                    <option value="Senin">Senin</option>
                    <option value="Selasa">Selasa</option>
                    <option value="Rabu">Rabu</option>
                    <option value="Kamis">Kamis</option>
                    <option value="Jumat">Jumat</option>
                    <option value="Sabtu">Sabtu</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-semibold mb-1">Jam Ke-</label>
                <select id="jam_ke" required class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- Pilih Jam --</option>
                    <option value="1">Jam ke-1 (07:15 - 07:50)</option>
                    <option value="2">Jam ke-2 (07:50 - 08:25)</option>
                    <option value="3">Jam ke-3 (08:25 - 09:00)</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-semibold mb-1">Kelas</label>
                <select id="kelas" required class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- Pilih Kelas --</option>
                    <option value="1A">Kelas 1A</option>
                    <option value="1B">Kelas 1B</option>
                    <option value="2A">Kelas 2A</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-semibold mb-1">Mata Pelajaran</label>
                <select id="mapel" required class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- Pilih Mapel --</option>
                    <option value="Tematik">Tematik</option>
                    <option value="Matematika">Matematika</option>
                    <option value="Pendidikan Agama">Pendidikan Agama</option>
                    <option value="PJOK">PJOK (Olahraga)</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-semibold mb-1">Guru Pengajar</label>
                <select id="guru" required class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- Pilih Guru --</option>
                    <option value="Pak Budi">Pak Budi</option>
                    <option value="Ibu Siti">Ibu Siti</option>
                    <option value="Pak Andi">Pak Andi</option>
                    <option value="Ibu Ratna">Ibu Ratna</option>
                </select>
            </div>

            <button type="submit" id="btnSubmit" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded transition duration-200">
                Simpan Jadwal
            </button>
        </form>
    </div>

    <!-- Script Firebase versi Modular (v11) -->
    <script type="module">
        // Import fungsi Firebase dari CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // ========================================================
        // ⚠️ MASUKKAN FIREBASE CONFIG ANDA DI SINI
        // Ganti kode di bawah ini dengan kode dari dashboard Firebase Anda
        // ========================================================
        const firebaseConfig = {
             apiKey: "AIzaSyAu8st2VRsNFyzC8UR8TDq8821y4_TVHVk",
  authDomain: "roster-sekolah-sd.firebaseapp.com",
  projectId: "roster-sekolah-sd",
  storageBucket: "roster-sekolah-sd.firebasestorage.app",
  messagingSenderId: "819380185646",
  appId: "1:819380185646:web:39ae854591ca40f0498dbf"
        };

        // Inisialisasi Firebase & Firestore
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Menangkap elemen HTML
        const form = document.getElementById('formJadwal');
        const btnSubmit = document.getElementById('btnSubmit');
        const pesanBox = document.getElementById('pesanBox');

        // Fungsi untuk menampilkan pesan (Sukses/Error)
        function tampilkanPesan(pesan, tipe) {
            pesanBox.innerHTML = pesan;
            pesanBox.className = `p-4 mb-6 rounded-lg font-medium text-sm block ${tipe === 'sukses' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
            pesanBox.classList.remove('hidden');
        }

        // Ketika tombol Simpan ditekan
        form.addEventListener('submit', async (e) => {
            e.preventDefault(); // Mencegah halaman reload
            
            // Ubah tombol jadi status loading
            btnSubmit.innerHTML = "Menyimpan...";
            btnSubmit.disabled = true;
            pesanBox.classList.add('hidden');

            // Ambil data dari formulir
            const hari = document.getElementById('hari').value;
            const jam_ke = document.getElementById('jam_ke').value;
            const kelas = document.getElementById('kelas').value;
            const mapel = document.getElementById('mapel').value;
            const guru = document.getElementById('guru').value;

            try {
                // --- LOGIKA ANTI-BENTROK ---
                const jadwalRef = collection(db, "jadwal_pelajaran");

                // 1. Cek Bentrok Guru: Apakah di hari & jam tersebut guru ini sudah mengajar?
                const qGuru = query(jadwalRef, 
                    where("hari", "==", hari), 
                    where("jam_ke", "==", jam_ke), 
                    where("guru", "==", guru)
                );
                const snapshotGuru = await getDocs(qGuru);
                
                if (!snapshotGuru.empty) {
                    tampilkanPesan(`❌ <b>Gagal!</b> ${guru} sudah memiliki jadwal mengajar di kelas lain pada hari ${hari} jam ke-${jam_ke}.`, 'error');
                    btnSubmit.innerHTML = "Simpan Jadwal";
                    btnSubmit.disabled = false;
                    return; // Hentikan proses simpan
                }

                // 2. Cek Bentrok Kelas: Apakah di hari & jam tersebut kelas ini sudah ada pelajaran lain?
                const qKelas = query(jadwalRef, 
                    where("hari", "==", hari), 
                    where("jam_ke", "==", jam_ke), 
                    where("kelas", "==", kelas)
                );
                const snapshotKelas = await getDocs(qKelas);

                if (!snapshotKelas.empty) {
                    tampilkanPesan(`❌ <b>Gagal!</b> Kelas ${kelas} sudah memiliki mata pelajaran lain pada hari ${hari} jam ke-${jam_ke}.`, 'error');
                    btnSubmit.innerHTML = "Simpan Jadwal";
                    btnSubmit.disabled = false;
                    return; // Hentikan proses simpan
                }

                // --- JIKA AMAN, SIMPAN DATA KE FIREBASE ---
                await addDoc(jadwalRef, {
                    hari: hari,
                    jam_ke: jam_ke,
                    kelas: kelas,
                    mapel: mapel,
                    guru: guru,
                    dibuat_pada: new Date()
                });

                // Tampilkan sukses dan reset form
                tampilkanPesan("✅ <b>Sukses!</b> Jadwal berhasil disimpan ke database.", 'sukses');
                form.reset();

            } catch (error) {
                console.error("Error menambahkan dokumen: ", error);
                tampilkanPesan("❌ Terjadi kesalahan sistem. Cek koneksi atau aturan Firebase Anda.", 'error');
            }

            // Kembalikan tombol seperti semula
            btnSubmit.innerHTML = "Simpan Jadwal";
            btnSubmit.disabled = false;
        });
    </script>
</body>
</html>
