<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Input Jadwal</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 min-h-screen p-4 md:p-8 font-sans text-gray-800">

    <div class="max-w-5xl mx-auto mb-6 flex justify-between items-center">
        <a href="index.html" class="inline-block bg-white text-indigo-700 hover:bg-indigo-50 font-bold py-2 px-5 rounded-lg transition duration-200 shadow shadow-indigo-200">
            üè† Keluar (Ke Depan)
        </a>
        <a href="kelola_data.html" class="inline-block bg-indigo-600 text-white hover:bg-indigo-700 font-bold py-2 px-5 rounded-lg transition duration-200 shadow shadow-indigo-200">
            ‚öôÔ∏è Kelola Data Master
        </a>
    </div>

    <div class="max-w-5xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden p-6 md:p-8 border border-gray-100">
        <h2 class="text-3xl font-extrabold text-center text-indigo-700 mb-8 tracking-tight">Input Jadwal Pelajaran</h2>
        
        <form id="formJadwal" class="bg-gradient-to-r from-indigo-50 to-blue-50 p-6 rounded-xl mb-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 shadow-inner border border-indigo-100">
            
            <div>
                <label class="block text-sm font-bold text-indigo-900 mb-2">Hari</label>
                <select id="inputHari" required class="w-full p-3 border border-indigo-200 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-white font-medium">
                    <option value="" disabled selected>Pilih Hari...</option>
                    <option value="Senin">Senin</option><option value="Selasa">Selasa</option>
                    <option value="Rabu">Rabu</option><option value="Kamis">Kamis</option>
                    <option value="Jumat">Jumat</option><option value="Sabtu">Sabtu</option>
                </select>
            </div>
            
            <!-- INI BAGIAN YANG DIUBAH MENJADI DROPDOWN -->
            <div>
                <label class="block text-sm font-bold text-indigo-900 mb-2">Jam & Waktu</label>
                <select id="inputMasterJam" required class="w-full p-3 border border-indigo-200 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-white font-medium">
                    <option value="" disabled selected>Memuat...</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-bold text-indigo-900 mb-2">Kelas</label>
                <select id="inputKelas" required class="w-full p-3 border border-indigo-200 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-white font-medium">
                    <option value="" disabled selected>Memuat...</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-bold text-indigo-900 mb-2">Mata Pelajaran</label>
                <select id="inputMapel" required class="w-full p-3 border border-indigo-200 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-white font-medium">
                    <option value="" disabled selected>Memuat...</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-bold text-indigo-900 mb-2">Guru Pengajar</label>
                <select id="inputGuru" required class="w-full p-3 border border-indigo-200 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-white font-medium">
                    <option value="" disabled selected>Memuat...</option>
                </select>
            </div>

            <div class="md:col-span-2 lg:col-span-5 flex justify-end mt-2">
                <button type="submit" id="btnSimpan" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg transition duration-200 shadow-md">
                    üíæ Simpan Jadwal
                </button>
            </div>
        </form>

        <!-- HEADER DAFTAR JADWAL DAN TOMBOL HAPUS SEMUA -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-4 border-b pb-2 gap-4">
            <h3 class="text-xl font-bold text-gray-800">Daftar Jadwal Tersimpan</h3>
            <button onclick="hapusSemuaJadwal()" class="bg-red-100 hover:bg-red-600 text-red-700 hover:text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-sm border border-red-200 text-sm flex items-center gap-2">
                üóëÔ∏è Kosongkan Semua Jadwal
            </button>
        </div>

        <div class="overflow-x-auto rounded-xl shadow-sm border border-gray-200">
            <table class="min-w-full bg-white text-left border-collapse">
                <thead class="bg-gray-800 text-white">
                    <tr>
                        <th class="py-3 px-4 uppercase font-bold text-xs">Hari</th>
                        <th class="py-3 px-4 uppercase font-bold text-xs">Jam</th>
                        <th class="py-3 px-4 uppercase font-bold text-xs">Waktu</th>
                        <th class="py-3 px-4 uppercase font-bold text-xs">Kelas</th>
                        <th class="py-3 px-4 uppercase font-bold text-xs">Mapel</th>
                        <th class="py-3 px-4 uppercase font-bold text-xs">Guru</th>
                        <th class="py-3 px-4 uppercase font-bold text-xs text-center">Aksi</th>
                    </tr>
                </thead>
                <tbody id="tabelJadwalAdmin" class="divide-y divide-gray-200 text-sm">
                    <tr><td colspan="7" class="py-6 text-center text-gray-500">Memuat data jadwal...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        // Menambahkan getDocs dan writeBatch untuk fitur Hapus Semua
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // ========================================================
        // KONFIGURASI FIREBASE
        // ========================================================
        let firebaseConfig = { 
            apiKey: "API_KEY_ANDA",
            authDomain: "PROJECT_ID.firebaseapp.com",
            projectId: "PROJECT_ID",
            storageBucket: "PROJECT_ID.appspot.com",
            messagingSenderId: "SENDER_ID",
            appId: "APP_ID"
        };
        try {
            const module = await import("./firebase-config.js");
            if (module && module.firebaseConfig) { firebaseConfig = module.firebaseConfig; }
        } catch (error) { console.warn("Menjalankan mode preview/lokal."); }

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- MUAT DROPDOWN MASTER DATA UMUM ---
        function muatDropdown(koleksi, idElemen) {
            if (firebaseConfig.apiKey === "API_KEY_ANDA") return;
            onSnapshot(collection(db, koleksi), (snapshot) => {
                const el = document.getElementById(idElemen);
                el.innerHTML = '<option value="" disabled selected>Pilih...</option>';
                snapshot.forEach(doc => {
                    el.insertAdjacentHTML('beforeend', `<option value="${doc.data().nama}">${doc.data().nama}</option>`);
                });
            });
        }
        muatDropdown("master_kelas", "inputKelas");
        muatDropdown("master_mapel", "inputMapel");
        muatDropdown("master_guru", "inputGuru");

        // --- MUAT DROPDOWN KHUSUS JAM ---
        function muatDropdownJam() {
            if (firebaseConfig.apiKey === "API_KEY_ANDA") return;
            onSnapshot(collection(db, "master_jam"), (snapshot) => {
                const el = document.getElementById("inputMasterJam");
                el.innerHTML = '<option value="" disabled selected>Pilih Jam...</option>';
                let arr = [];
                snapshot.forEach(docSnap => arr.push({id: docSnap.id, ...docSnap.data()}));
                arr.sort((a,b) => String(a.jam_ke).localeCompare(String(b.jam_ke), undefined, {numeric: true}));
                arr.forEach(data => {
                    // Menyimpan data jam_ke dan waktu di dalam dataset option
                    el.insertAdjacentHTML('beforeend', `<option value="${data.id}" data-jam="${data.jam_ke}" data-waktu="${data.waktu}">Jam ${data.jam_ke} (${data.waktu})</option>`);
                });
            });
        }
        muatDropdownJam();

        // --- SIMPAN JADWAL ---
        document.getElementById('formJadwal').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (firebaseConfig.apiKey === "API_KEY_ANDA") return alert("Isi Firebase Config dulu!");
            
            const btn = document.getElementById('btnSimpan');
            btn.innerHTML = "Menyimpan..."; btn.disabled = true;

            // Mengambil nilai jam dan waktu dari opsi dropdown yang dipilih
            const optJam = document.getElementById('inputMasterJam').selectedOptions[0];
            const valJamKe = optJam.getAttribute('data-jam');
            const valWaktu = optJam.getAttribute('data-waktu');

            try {
                await addDoc(collection(db, "jadwal_pelajaran"), {
                    hari: document.getElementById('inputHari').value,
                    jam_ke: valJamKe,
                    waktu: valWaktu,
                    kelas: document.getElementById('inputKelas').value,
                    mapel: document.getElementById('inputMapel').value,
                    guru: document.getElementById('inputGuru').value,
                    timestamp: new Date()
                });
                document.getElementById('formJadwal').reset();
            } catch (error) {
                alert("Gagal menyimpan: " + error.message);
            }
            btn.innerHTML = "üíæ Simpan Jadwal"; btn.disabled = false;
        });

        // --- TAMPILKAN DAN HAPUS JADWAL ---
        if (firebaseConfig.apiKey !== "API_KEY_ANDA") {
            const q = query(collection(db, "jadwal_pelajaran"));
            onSnapshot(q, (snapshot) => {
                const tbody = document.getElementById('tabelJadwalAdmin');
                tbody.innerHTML = '';
                if(snapshot.empty) {
                    tbody.innerHTML = `<tr><td colspan="7" class="py-6 text-center text-gray-500 font-medium">Belum ada jadwal yang tersimpan.</td></tr>`;
                    return;
                }
                
                // Urutkan lokal
                let jadwalArr = [];
                snapshot.forEach(doc => jadwalArr.push({id: doc.id, ...doc.data()}));
                const urutanHari = { "Senin":1, "Selasa":2, "Rabu":3, "Kamis":4, "Jumat":5, "Sabtu":6 };
                jadwalArr.sort((a,b) => (urutanHari[a.hari]||99) - (urutanHari[b.hari]||99) || String(a.jam_ke).localeCompare(String(b.jam_ke), undefined, {numeric: true}));

                jadwalArr.forEach(data => {
                    tbody.insertAdjacentHTML('beforeend', `
                        <tr class="hover:bg-gray-50">
                            <td class="py-3 px-4 font-semibold">${data.hari}</td>
                            <td class="py-3 px-4">${data.jam_ke}</td>
                            <td class="py-3 px-4 text-gray-600 text-xs font-bold">${data.waktu || '-'}</td>
                            <td class="py-3 px-4"><span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-bold">${data.kelas}</span></td>
                            <td class="py-3 px-4 font-medium text-indigo-700">${data.mapel}</td>
                            <td class="py-3 px-4">${data.guru}</td>
                            <td class="py-3 px-4 text-center">
                                <button onclick="hapusJadwal('${data.id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs font-bold shadow">Hapus</button>
                            </td>
                        </tr>
                    `);
                });
            });
        }

        window.hapusJadwal = async function(id) {
            if(confirm("Yakin ingin menghapus jadwal tunggal ini?")) {
                await deleteDoc(doc(db, "jadwal_pelajaran", id));
            }
        };

        // --- FITUR HAPUS SEMUA JADWAL SEKALIGUS ---
        window.hapusSemuaJadwal = async function() {
            // Peringatan ganda agar tidak salah klik
            const konfirmasi = confirm("‚ö†Ô∏è PERINGATAN: Apakah Anda yakin ingin MENGHAPUS SEMUA jadwal pelajaran? Data yang dihapus tidak dapat dikembalikan!");
            
            if (konfirmasi) {
                const konfirmasiKedua = confirm("Satu kali lagi: Apakah Anda BENAR-BENAR YAKIN ingin mengosongkan seluruh tabel jadwal untuk pergantian tahun/semester?");
                
                if (konfirmasiKedua) {
                    try {
                        const jadwalRef = collection(db, "jadwal_pelajaran");
                        const snapshot = await getDocs(jadwalRef);
                        
                        if (snapshot.empty) {
                            alert("Jadwal sudah kosong, tidak ada yang perlu dihapus.");
                            return;
                        }

                        // Menggunakan sistem "Batch" dari Firebase untuk menghapus massal dengan cepat
                        const batch = writeBatch(db);
                        snapshot.forEach((docSnap) => {
                            batch.delete(docSnap.ref);
                        });
                        
                        await batch.commit(); // Eksekusi penghapusan massal
                        alert("‚úÖ Berhasil! Semua jadwal pelajaran telah dikosongkan.");
                        
                    } catch (error) {
                        console.error("Gagal menghapus semua jadwal:", error);
                        alert("Terjadi kesalahan saat menghapus data: " + error.message);
                    }
                }
            }
        };
    </script>
</body>
</html>
