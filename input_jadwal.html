<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Input Jadwal Pelajaran</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Library ExcelJS untuk Export Excel dengan Styling Warna & Border -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8 font-sans text-gray-800">

    <div class="max-w-7xl mx-auto mb-6 flex flex-col sm:flex-row justify-between items-center gap-4">
        <h1 class="text-3xl font-extrabold text-blue-800">üìÖ Kelola Jadwal Pelajaran</h1>
        
        <div class="flex gap-3">
            <a href="/index.html" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg transition shadow">
                üè† Halaman Depan
            </a>
            <a href="/kelola_data.html" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition shadow flex items-center gap-2">
                ‚öôÔ∏è Master Data
            </a>
        </div>
    </div>

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
        
        <!-- FORM INPUT JADWAL (Sticky) -->
        <div class="lg:col-span-1 bg-white rounded-2xl shadow-xl p-6 border border-blue-100 h-fit sticky top-6">
            <h2 id="formTitle" class="text-xl font-bold text-blue-700 mb-4 border-b pb-2">‚ûï Tambah Jadwal</h2>
            
            <form id="formJadwal" class="space-y-4" onsubmit="simpanJadwal(event)">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Hari</label>
                    <select id="pilihHari" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-gray-50" required>
                        <option value="">-- Pilih Hari --</option>
                        <option value="Senin">Senin</option>
                        <option value="Selasa">Selasa</option>
                        <option value="Rabu">Rabu</option>
                        <option value="Kamis">Kamis</option>
                        <option value="Jumat">Jumat</option>
                        <option value="Sabtu">Sabtu</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Kelas</label>
                    <select id="pilihKelas" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-gray-50" required>
                        <option value="">Memuat...</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Waktu / Jam</label>
                    <select id="pilihWaktu" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-gray-50" required>
                        <option value="">Memuat...</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Mata Pelajaran</label>
                    <select id="pilihMapel" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-gray-50" required>
                        <option value="">Memuat...</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Guru Pengajar</label>
                    <select id="pilihGuru" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-gray-50" required>
                        <option value="">Memuat...</option>
                    </select>
                </div>

                <div class="flex gap-2 mt-4">
                    <button type="button" id="btnBatalEdit" onclick="batalEdit()" class="hidden w-1/3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-4 rounded-xl shadow transition">
                        Batal
                    </button>
                    <button type="submit" id="btnSubmitJadwal" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition transform hover:-translate-y-0.5">
                        üíæ Simpan Jadwal
                    </button>
                </div>
            </form>
        </div>

        <!-- TABEL PREVIEW JADWAL -->
        <div class="lg:col-span-2 bg-white rounded-2xl shadow-xl p-6 border border-gray-100">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4 border-b pb-4">
                <h2 class="text-xl font-bold text-gray-800 whitespace-nowrap">üìã Daftar Jadwal</h2>
                
                <div class="flex flex-wrap items-center justify-end gap-2 w-full">
                    <button onclick="bukaModalSetGuru()" class="bg-indigo-100 hover:bg-indigo-600 text-indigo-700 hover:text-white font-bold py-2 px-3 rounded-lg text-sm transition shadow flex items-center gap-1" title="Isi otomatis guru untuk jadwal yang kosong">
                        üë®‚Äçüè´ Set Guru Massal
                    </button>
                    <button onclick="salinJadwalKelas()" class="bg-blue-100 hover:bg-blue-600 text-blue-700 hover:text-white font-bold py-2 px-3 rounded-lg text-sm transition shadow flex items-center gap-1" title="Salin seluruh jadwal kelas ini ke kelas lain">
                        üìã Salin Kelas
                    </button>
                    <button onclick="bukaModalExport()" class="bg-green-100 hover:bg-green-600 text-green-700 hover:text-white font-bold py-2 px-3 rounded-lg text-sm transition shadow flex items-center gap-1" title="Download Excel Roster">
                        üì• Export Excel
                    </button>
                    <button onclick="hapusSemuaJadwal()" class="bg-red-100 hover:bg-red-600 text-red-700 hover:text-white font-bold py-2 px-3 rounded-lg text-sm transition shadow flex items-center gap-1" title="Hapus Jadwal Berdasarkan Filter">
                        üóëÔ∏è Hapus
                    </button>

                    <div class="flex items-center ml-auto w-full sm:w-auto mt-2 sm:mt-0">
                        <label class="text-sm font-bold text-gray-600 whitespace-nowrap mr-2">Filter Kelas:</label>
                        <select id="filterKelas" onchange="tampilkanJadwal()" class="w-full sm:w-40 p-2 border border-gray-300 rounded-lg bg-gray-50 font-semibold text-blue-700">
                            <option value="Semua">Semua Kelas</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Tabel yang bisa di-scroll sendiri -->
            <div class="overflow-y-auto max-h-[calc(100vh-220px)] rounded-lg border border-gray-200 relative">
                <table class="min-w-full bg-white text-sm text-left relative">
                    <thead class="bg-blue-50 text-blue-900 uppercase font-bold text-xs sticky top-0 z-10 shadow-sm">
                        <tr>
                            <th class="py-3 px-4 bg-blue-50">Hari</th>
                            <th class="py-3 px-4 bg-blue-50">Waktu</th>
                            <th class="py-3 px-4 bg-blue-50">Kelas</th>
                            <th class="py-3 px-4 bg-blue-50">Mata Pelajaran</th>
                            <th class="py-3 px-4 bg-blue-50">Guru</th>
                            <th class="py-3 px-4 bg-blue-50 text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="tabelJadwal" class="divide-y divide-gray-100">
                        <tr><td colspan="6" class="text-center py-4 text-gray-500">Memuat data jadwal...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MODAL SALIN KELAS -->
    <div id="modalSalinKelas" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-2xl shadow-2xl p-6 md:p-8 w-full max-w-md transform scale-100 transition-transform">
            <div class="mb-6">
                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">üìã Salin Jadwal Kelas</h3>
                <p class="text-sm text-gray-500 mt-1" id="teksInfoSalin">Pilih kelas tujuan untuk menyalin jadwal.</p>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-bold text-gray-700 mb-2">Kelas Tujuan</label>
                <select id="pilihKelasTujuan" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none bg-gray-50 font-semibold text-blue-700">
                    <option value="">Memuat...</option>
                </select>
            </div>
            
            <div class="flex flex-col-reverse sm:flex-row gap-3 mt-6">
                <button onclick="tutupModal('modalSalinKelas')" class="w-full px-4 py-2.5 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-xl font-semibold transition-colors">Batal</button>
                <button onclick="prosesSalinKelas(event)" class="w-full px-4 py-2.5 text-white bg-blue-600 hover:bg-blue-700 shadow-md shadow-blue-200 rounded-xl font-semibold transition-all">Salin Sekarang</button>
            </div>
        </div>
    </div>

    <!-- MODAL SET GURU MASSAL -->
    <div id="modalSetGuru" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-2xl shadow-2xl p-6 md:p-8 w-full max-w-md transform scale-100 transition-transform">
            <div class="mb-6">
                <h3 class="text-xl font-bold text-indigo-800 flex items-center gap-2">üë®‚Äçüè´ Set Guru Massal</h3>
                <p class="text-sm text-gray-500 mt-1" id="teksInfoGuruMassal">Isi otomatis nama guru untuk jadwal yang masih <span class="text-red-500 font-bold">KOSONG</span> di kelas ini.</p>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-bold text-gray-700 mb-2">Pilih Guru (Wali Kelas/Guru Utama)</label>
                <select id="pilihGuruMassal" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none bg-gray-50 font-semibold text-indigo-700">
                    <option value="">Memuat...</option>
                </select>
            </div>
            
            <div class="flex flex-col-reverse sm:flex-row gap-3 mt-6">
                <button onclick="tutupModal('modalSetGuru')" class="w-full px-4 py-2.5 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-xl font-semibold transition-colors">Batal</button>
                <button onclick="prosesSetGuruMassal(event)" class="w-full px-4 py-2.5 text-white bg-indigo-600 hover:bg-indigo-700 shadow-md shadow-indigo-200 rounded-xl font-semibold transition-all">Tetapkan Guru</button>
            </div>
        </div>
    </div>

    <!-- MODAL EXPORT EXCEL -->
    <div id="modalExportExcel" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center p-4 backdrop-blur-sm transition-opacity overflow-y-auto">
        <div class="bg-white rounded-2xl shadow-2xl p-6 md:p-8 w-full max-w-2xl transform scale-100 transition-transform my-8">
            <div class="mb-6 border-b pb-4">
                <h3 class="text-xl font-bold text-green-700 flex items-center gap-2">üì• Download Excel Roster</h3>
                <p class="text-sm text-gray-500 mt-1">Lengkapi data di bawah ini untuk Kop dan Tanda Tangan pada file Excel.</p>
            </div>
            
            <form id="formExport" onsubmit="prosesExportExcel(event)" class="space-y-4">
                
                <!-- NAMA SEKOLAH -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Nama Sekolah</label>
                    <input type="text" id="exNamaSekolah" placeholder="Contoh: SD Negeri 1 Jakarta" class="w-full p-2.5 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-green-500 text-blue-800 font-semibold" required>
                </div>

                <!-- Tahun & Tempat -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Tahun Pelajaran</label>
                        <input type="text" id="exTahun" placeholder="Contoh: 2023/2024" class="w-full p-2.5 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-green-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Tempat, Tanggal Pembuatan</label>
                        <input type="text" id="exTempatTgl" placeholder="Contoh: Makassar, 15 Juli 2024" class="w-full p-2.5 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-green-500" required>
                    </div>
                </div>

                <!-- Kepala Sekolah -->
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 mt-2">
                    <h4 class="font-bold text-blue-800 mb-3 text-sm">Data Kepala Sekolah</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">Nama Kepala Sekolah</label>
                            <input type="text" id="exNamaKepsek" placeholder="Nama Lengkap beserta gelar" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">NIP Kepala Sekolah</label>
                            <input type="text" id="exNipKepsek" placeholder="Nomor Induk Pegawai" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                    </div>
                </div>

                <!-- Wali Kelas -->
                <div class="bg-green-50 p-4 rounded-xl border border-green-100 mt-2">
                    <h4 class="font-bold text-green-800 mb-3 text-sm">Data Wali Kelas (Opsional)</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">Nama Wali Kelas</label>
                            <input type="text" id="exNamaWali" placeholder="Kosongkan jika ekspor Semua Kelas" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">NIP Wali Kelas</label>
                            <input type="text" id="exNipWali" placeholder="Kosongkan jika tidak ada" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                        </div>
                    </div>
                </div>
                
                <div class="flex flex-col-reverse sm:flex-row gap-3 mt-6 pt-4 border-t">
                    <button type="button" onclick="tutupModal('modalExportExcel')" class="w-full sm:w-1/3 px-4 py-3 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-xl font-semibold transition-colors">Batal</button>
                    <button type="submit" id="btnProsesExport" class="w-full sm:w-2/3 px-4 py-3 text-white bg-green-600 hover:bg-green-700 shadow-lg shadow-green-200 rounded-xl font-bold transition-all flex justify-center items-center gap-2">
                        <span>üì•</span> Unduh File Excel Sekarang
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, getDoc, onSnapshot, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        let firebaseConfig = { 
            apiKey: "API_KEY_ANDA",
            authDomain: "PROJECT_ID.firebaseapp.com",
            projectId: "PROJECT_ID",
            storageBucket: "PROJECT_ID.appspot.com",
            messagingSenderId: "SENDER_ID",
            appId: "APP_ID"
        };
        try {
            const module = await import("./firebase-config.js");
            if (module && module.firebaseConfig) { firebaseConfig = module.firebaseConfig; }
        } catch (error) { console.warn("Mode lokal."); }

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let semuaJadwal = []; 
        let idEditJadwal = null; 
        let kelasSumberAktif = ""; 
        let namaSekolahSistem = "NAMA SEKOLAH BELUM DISETTING";

        // --- AMBIL NAMA SEKOLAH ---
        async function ambilNamaSekolah() {
            if (firebaseConfig.apiKey === "API_KEY_ANDA") return;
            try {
                const docSnap = await getDoc(doc(db, "pengaturan", "info_sekolah"));
                if (docSnap.exists() && docSnap.data().nama_sekolah) {
                    namaSekolahSistem = docSnap.data().nama_sekolah;
                }
            } catch (e) { console.error("Gagal mengambil nama sekolah", e); }
        }
        ambilNamaSekolah();

        // --- MUAT DROPDOWN ---
        function muatDropdown(koleksi, idSelect, isWaktu = false) {
            if (firebaseConfig.apiKey === "API_KEY_ANDA") return;
            onSnapshot(collection(db, koleksi), (snapshot) => {
                const selectEl = document.getElementById(idSelect);
                if (idSelect === 'filterKelas') {
                    selectEl.innerHTML = '<option value="Semua">Semua Kelas</option>';
                } else {
                    selectEl.innerHTML = '<option value="">-- Pilih --</option>';
                }
                
                let dataArr = [];
                snapshot.forEach(docSnap => dataArr.push(docSnap.data()));

                if(isWaktu) {
                    dataArr.sort((a, b) => {
                        let t1 = a.waktu || a.nama || "";
                        let t2 = b.waktu || b.nama || "";
                        return t1.localeCompare(t2);
                    });
                } else {
                    dataArr.sort((a,b) => (a.nama || "").localeCompare(b.nama || ""));
                }

                dataArr.forEach(data => {
                    const nilai = data.nama || data.waktu;
                    if(nilai) {
                        selectEl.insertAdjacentHTML('beforeend', `<option value="${nilai}">${nilai}</option>`);
                    }
                });

                if(idSelect === 'pilihGuru') {
                    document.getElementById('pilihGuruMassal').innerHTML = selectEl.innerHTML;
                }
            });
        }

        muatDropdown("master_kelas", "pilihKelas");
        muatDropdown("master_kelas", "filterKelas");
        muatDropdown("master_kelas", "pilihKelasTujuan");
        muatDropdown("master_waktu", "pilihWaktu", true);
        muatDropdown("master_mapel", "pilihMapel");
        muatDropdown("master_guru", "pilihGuru");

        // --- FUNGSI GLOBAL TUTUP MODAL ---
        window.tutupModal = function(idModal) {
            document.getElementById(idModal).classList.add('hidden');
        };

        // --- FUNGSI BATAL EDIT ---
        window.batalEdit = function() {
            idEditJadwal = null;
            document.getElementById('formJadwal').reset();
            const btnSubmit = document.getElementById('btnSubmitJadwal');
            btnSubmit.innerHTML = "üíæ Simpan Jadwal";
            btnSubmit.classList.replace("bg-green-600", "bg-blue-600");
            btnSubmit.classList.replace("hover:bg-green-700", "hover:bg-blue-700");
            document.getElementById('formTitle').innerText = "‚ûï Tambah Jadwal";
            document.getElementById('btnBatalEdit').classList.add('hidden');
            btnSubmit.classList.remove('w-2/3');
            btnSubmit.classList.add('w-full');
        };

        // --- FUNGSI SIMPAN & UPDATE ---
        window.simpanJadwal = async function(e) {
            e.preventDefault();
            if (firebaseConfig.apiKey === "API_KEY_ANDA") return alert("Isi config Firebase dahulu!");

            const jadwalBaru = {
                hari: document.getElementById('pilihHari').value,
                kelas: document.getElementById('pilihKelas').value,
                waktu: document.getElementById('pilihWaktu').value,
                mapel: document.getElementById('pilihMapel').value,
                guru: document.getElementById('pilihGuru').value,
                timestamp: new Date().getTime()
            };

            const btnSubmit = document.getElementById('btnSubmitJadwal');
            const teksAsli = btnSubmit.innerHTML;
            btnSubmit.innerHTML = "‚è≥ Memproses..."; btnSubmit.disabled = true;

            try {
                if (idEditJadwal) {
                    await updateDoc(doc(db, "jadwal_pelajaran", idEditJadwal), jadwalBaru);
                    alert("‚úÖ Jadwal Berhasil Diperbarui!");
                    batalEdit();
                } else {
                    await addDoc(collection(db, "jadwal_pelajaran"), jadwalBaru);
                    alert("‚úÖ Jadwal Berhasil Disimpan!");
                }
            } catch (error) {
                console.error("Error menyimpan jadwal: ", error);
                alert("‚ùå Gagal menyimpan jadwal.");
            }
            
            btnSubmit.innerHTML = teksAsli; btnSubmit.disabled = false;
        };

        // --- FUNGSI TAMPILKAN JADWAL ---
        function muatDataJadwal() {
            if (firebaseConfig.apiKey === "API_KEY_ANDA") return;
            onSnapshot(collection(db, "jadwal_pelajaran"), (snapshot) => {
                semuaJadwal = [];
                snapshot.forEach(docSnap => {
                    semuaJadwal.push({ id: docSnap.id, ...docSnap.data() });
                });
                tampilkanJadwal();
            });
        }

        const urutanHari = { "Senin":1, "Selasa":2, "Rabu":3, "Kamis":4, "Jumat":5, "Sabtu":6, "Minggu":7 };

        window.tampilkanJadwal = function() {
            const tabel = document.getElementById('tabelJadwal');
            const kelasDipilih = document.getElementById('filterKelas').value;
            tabel.innerHTML = '';

            let jadwalTerfilter = semuaJadwal;
            if (kelasDipilih !== "Semua") {
                jadwalTerfilter = semuaJadwal.filter(j => j.kelas === kelasDipilih);
            }

            jadwalTerfilter.sort((a, b) => {
                if (urutanHari[a.hari] !== urutanHari[b.hari]) {
                    return urutanHari[a.hari] - urutanHari[b.hari];
                }
                return (a.waktu || "").localeCompare(b.waktu || "");
            });

            if (jadwalTerfilter.length === 0) {
                tabel.innerHTML = `<tr><td colspan="6" class="text-center py-6 text-gray-500 italic">Belum ada data jadwal untuk kelas ini.</td></tr>`;
                return;
            }

            jadwalTerfilter.forEach(j => {
                let bgHari = "bg-gray-50";
                if(j.hari === "Senin") bgHari = "bg-red-50 text-red-700";
                if(j.hari === "Selasa") bgHari = "bg-orange-50 text-orange-700";
                if(j.hari === "Rabu") bgHari = "bg-yellow-50 text-yellow-700";
                if(j.hari === "Kamis") bgHari = "bg-green-50 text-green-700";
                if(j.hari === "Jumat") bgHari = "bg-blue-50 text-blue-700";
                if(j.hari === "Sabtu") bgHari = "bg-purple-50 text-purple-700";

                tabel.insertAdjacentHTML('beforeend', `
                    <tr class="hover:bg-gray-50 transition duration-150">
                        <td class="py-3 px-4"><span class="px-2 py-1 rounded-md font-bold text-xs ${bgHari}">${j.hari}</span></td>
                        <td class="py-3 px-4 font-medium">${j.waktu}</td>
                        <td class="py-3 px-4 font-bold text-gray-700">${j.kelas}</td>
                        <td class="py-3 px-4">${j.mapel}</td>
                        <td class="py-3 px-4">${j.guru ? j.guru : '<span class="text-red-500 italic font-semibold">Belum diisi</span>'}</td>
                        <td class="py-3 px-4 text-center whitespace-nowrap">
                            <button onclick="editJadwal('${j.id}')" class="bg-yellow-100 text-yellow-600 hover:bg-yellow-500 hover:text-white p-2 rounded transition mr-1" title="Edit">
                                ‚úèÔ∏è
                            </button>
                            <button onclick="hapusJadwal('${j.id}')" class="bg-red-100 text-red-600 hover:bg-red-500 hover:text-white p-2 rounded transition" title="Hapus">
                                üóëÔ∏è
                            </button>
                        </td>
                    </tr>
                `);
            });
        };

        // --- FUNGSI EDIT JADWAL ---
        window.editJadwal = function(id) {
            const jadwal = semuaJadwal.find(j => j.id === id);
            if(!jadwal) return;
            
            document.getElementById('pilihHari').value = jadwal.hari;
            document.getElementById('pilihKelas').value = jadwal.kelas;
            document.getElementById('pilihWaktu').value = jadwal.waktu;
            document.getElementById('pilihMapel').value = jadwal.mapel;
            document.getElementById('pilihGuru').value = jadwal.guru;
            
            idEditJadwal = id; 
            
            const btnSubmit = document.getElementById('btnSubmitJadwal');
            btnSubmit.innerHTML = "üîÑ Update Jadwal";
            btnSubmit.classList.replace("bg-blue-600", "bg-green-600");
            btnSubmit.classList.replace("hover:bg-blue-700", "hover:bg-green-700");
            btnSubmit.classList.remove('w-full');
            btnSubmit.classList.add('w-2/3');
            
            document.getElementById('formTitle').innerText = "‚úèÔ∏è Edit Jadwal";
            document.getElementById('btnBatalEdit').classList.remove('hidden');
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        // --- FITUR 1: SET GURU MASSAL ---
        window.bukaModalSetGuru = function() {
            const kelasAktif = document.getElementById('filterKelas').value;
            if (kelasAktif === "Semua") {
                return alert("‚ö†Ô∏è Harap pilih satu kelas di bagian 'Filter Kelas' terlebih dahulu! (Misalnya: Kelas 1A)");
            }

            const jadwalKosong = semuaJadwal.filter(j => j.kelas === kelasAktif && (!j.guru || j.guru.trim() === ""));
            
            if (jadwalKosong.length === 0) {
                return alert(`üéâ Luar biasa! Tidak ada jadwal yang kosong/tanpa guru di kelas ${kelasAktif}.`);
            }

            document.getElementById('teksInfoGuruMassal').innerHTML = `Terdapat <span class="font-bold text-red-600">${jadwalKosong.length} jadwal kosong</span> di kelas <b>${kelasAktif}</b>. Pilih guru untuk mengisi semua jadwal kosong tersebut:`;
            document.getElementById('pilihGuruMassal').value = "";
            document.getElementById('modalSetGuru').classList.remove('hidden');
        };

        window.prosesSetGuruMassal = async function(e) {
            const guruPilihan = document.getElementById('pilihGuruMassal').value;
            const kelasAktif = document.getElementById('filterKelas').value;

            if (!guruPilihan) return alert("Pilih nama guru terlebih dahulu!");

            const jadwalKosong = semuaJadwal.filter(j => j.kelas === kelasAktif && (!j.guru || j.guru.trim() === ""));

            if (confirm(`Yakin ingin menetapkan "${guruPilihan}" untuk ${jadwalKosong.length} jadwal yang kosong di kelas ${kelasAktif}?`)) {
                
                const btnSubmit = e.target;
                const teksAsli = btnSubmit.innerHTML;
                btnSubmit.innerHTML = "‚è≥ Memproses..."; btnSubmit.disabled = true;

                try {
                    const batch = writeBatch(db);
                    
                    jadwalKosong.forEach(j => {
                        const docRef = doc(db, "jadwal_pelajaran", j.id);
                        batch.update(docRef, { guru: guruPilihan });
                    });

                    await batch.commit();
                    alert(`‚úÖ Berhasil menetapkan ${guruPilihan} ke ${jadwalKosong.length} jadwal di kelas ${kelasAktif}!`);
                    tutupModal('modalSetGuru');
                } catch (error) {
                    console.error("Error update massal guru: ", error);
                    alert("‚ùå Gagal mengupdate guru.");
                }

                btnSubmit.innerHTML = teksAsli; btnSubmit.disabled = false;
            }
        };

        // --- FITUR 2: EXPORT EXCELJS (DENGAN WARNA KONTRAS TINGGI) ---
        window.bukaModalExport = function() {
            if (semuaJadwal.length === 0) {
                return alert("‚ö†Ô∏è Tidak ada data jadwal yang bisa di-export.");
            }
            const kelasAktif = document.getElementById('filterKelas').value;
            
            // Set Default Input
            document.getElementById('exNamaSekolah').value = namaSekolahSistem !== "NAMA SEKOLAH BELUM DISETTING" ? namaSekolahSistem : "";
            document.getElementById('exTahun').value = `${new Date().getFullYear()}/${new Date().getFullYear() + 1}`;
            
            if (kelasAktif !== "Semua") {
                document.getElementById('exNamaWali').placeholder = `Wali Kelas ${kelasAktif}`;
            } else {
                document.getElementById('exNamaWali').placeholder = `Kosongkan jika ekspor semua kelas`;
            }
            document.getElementById('modalExportExcel').classList.remove('hidden');
        };

        window.prosesExportExcel = async function(e) {
            e.preventDefault();

            const btnExport = document.getElementById('btnProsesExport');
            const teksAwalBtn = btnExport.innerHTML;
            btnExport.innerHTML = "‚è≥ Sedang Memproses Excel..."; btnExport.disabled = true;

            try {
                // Ambil Nilai Input
                const namaSekolahExport = document.getElementById('exNamaSekolah').value.toUpperCase();
                const tahun = document.getElementById('exTahun').value.toUpperCase();
                const tempatTgl = document.getElementById('exTempatTgl').value;
                const kepsek = document.getElementById('exNamaKepsek').value;
                const nipKepsek = document.getElementById('exNipKepsek').value;
                const wali = document.getElementById('exNamaWali').value || "....................................";
                const nipWali = document.getElementById('exNipWali').value || "..................";
                
                const filterKelas = document.getElementById('filterKelas').value;
                const isSemua = filterKelas === "Semua";
                
                let dataExport = isSemua ? semuaJadwal : semuaJadwal.filter(j => j.kelas === filterKelas);

                // Urutkan data
                dataExport.sort((a, b) => {
                    if (urutanHari[a.hari] !== urutanHari[b.hari]) return urutanHari[a.hari] - urutanHari[b.hari];
                    return (a.waktu || "").localeCompare(b.waktu || "");
                });

                // Buat Workbook ExcelJS
                const wb = new ExcelJS.Workbook();
                const sheetName = isSemua ? "Semua_Kelas" : `Kelas_${filterKelas}`;
                const ws = wb.addWorksheet(sheetName);

                // Pengaturan Gaya Dasar
                const centerAlign = { vertical: 'middle', horizontal: 'center' };
                const borderAll = {
                    top: {style:'thin'}, left: {style:'thin'},
                    bottom: {style:'thin'}, right: {style:'thin'}
                };

                // KOP SURAT
                ws.mergeCells('A1:E1');
                ws.getCell('A1').value = "ROSTER MATA PELAJARAN";
                ws.getCell('A1').font = { bold: true, size: 14 };
                ws.getCell('A1').alignment = centerAlign;

                // Nama Sekolah yang diketik User
                ws.mergeCells('A2:E2');
                ws.getCell('A2').value = namaSekolahExport; 
                ws.getCell('A2').font = { bold: true, size: 12 };
                ws.getCell('A2').alignment = centerAlign;

                ws.mergeCells('A3:E3');
                ws.getCell('A3').value = "TAHUN PELAJARAN " + tahun;
                ws.getCell('A3').font = { bold: true, size: 11 };
                ws.getCell('A3').alignment = centerAlign;

                let startRow = 5;
                if (!isSemua) {
                    ws.mergeCells('A4:E4');
                    ws.getCell('A4').value = "KELAS: " + filterKelas;
                    ws.getCell('A4').font = { bold: true, size: 11 };
                    ws.getCell('A4').alignment = centerAlign;
                    startRow = 6;
                }

                // HEADER TABEL
                const headers = ["Hari", "Waktu", "Kelas", "Mata Pelajaran", "Guru Pengajar"];
                const headerRow = ws.getRow(startRow);
                headers.forEach((h, i) => {
                    const cell = headerRow.getCell(i + 1);
                    cell.value = h;
                    cell.font = { bold: true, color: { argb: 'FFFFFFFF' } }; // Putih
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1E3A8A' } }; // Biru gelap Tailwind
                    cell.alignment = centerAlign;
                    cell.border = borderAll;
                });

                startRow++;

                // PALET WARNA CERAH & KONTRAS UNTUK GURU
                // Sangat ramah untuk membedakan kategori (termasuk color blind friendly yang butuh kontras kuat)
                const warnaKontras = [
                    'FFFFFF99', // Kuning Terang
                    'FF99FF99', // Hijau Muda
                    'FF99FFFF', // Cyan
                    'FF99CCFF', // Biru Langit
                    'FFCC99FF', // Ungu Muda
                    'FFFF99CC', // Pink
                    'FFFF9999', // Merah Muda
                    'FFFFCC99', // Oranye
                    'FFCCFF99', // Lime
                    'FF66FFCC', // Teal
                    'FFFF66FF', // Magenta
                    'FFFFD700', // Emas
                    'FFB3B3CC', // Abu-abu kebiruan
                    'FFFFB366', // Peach
                    'FF99FFCC'  // Mint
                ];
                let warnaGuruMap = {};
                let indeksWarna = 0;

                // ISI DATA
                dataExport.forEach((j) => {
                    const row = ws.getRow(startRow);
                    row.getCell(1).value = j.hari;
                    row.getCell(2).value = j.waktu;
                    row.getCell(3).value = j.kelas;
                    row.getCell(4).value = j.mapel;
                    row.getCell(5).value = j.guru || "";

                    // Styling Sel
                    for(let i=1; i<=5; i++) {
                        const cell = row.getCell(i);
                        cell.border = borderAll;
                        cell.alignment = { vertical: 'middle', horizontal: 'left' };
                        // Center align untuk Hari, Waktu, Kelas
                        if (i <= 3) cell.alignment = centerAlign;
                    }

                    // Terapkan Warna Baris Berdasarkan Guru
                    if (j.guru) {
                        if (!warnaGuruMap[j.guru]) {
                            warnaGuruMap[j.guru] = warnaKontras[indeksWarna % warnaKontras.length];
                            indeksWarna++;
                        }
                        const warnaBaris = warnaGuruMap[j.guru];
                        for(let i=1; i<=5; i++) {
                             row.getCell(i).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: warnaBaris } };
                        }
                    } else {
                         row.getCell(5).font = { color: { argb: 'FFFF0000' }, italic: true };
                         row.getCell(5).value = "Belum diisi";
                    }

                    startRow++;
                });

                // MENGATUR LEBAR KOLOM
                ws.getColumn(1).width = 15; // Hari
                ws.getColumn(2).width = 20; // Waktu
                ws.getColumn(3).width = 12; // Kelas
                ws.getColumn(4).width = 35; // Mapel
                ws.getColumn(5).width = 35; // Guru

                // AREA TANDA TANGAN (FOOTER)
                let footerRow = startRow + 2;

                ws.mergeCells(`D${footerRow}:E${footerRow}`);
                ws.getCell(`D${footerRow}`).value = tempatTgl;
                ws.getCell(`D${footerRow}`).alignment = centerAlign;

                footerRow++;
                ws.mergeCells(`A${footerRow}:B${footerRow}`);
                ws.getCell(`A${footerRow}`).value = "Mengetahui,";
                ws.getCell(`A${footerRow}`).alignment = centerAlign;

                ws.mergeCells(`D${footerRow}:E${footerRow}`);
                ws.getCell(`D${footerRow}`).value = "Wali Kelas,";
                ws.getCell(`D${footerRow}`).alignment = centerAlign;

                footerRow++;
                ws.mergeCells(`A${footerRow}:B${footerRow}`);
                ws.getCell(`A${footerRow}`).value = "Kepala Sekolah,";
                ws.getCell(`A${footerRow}`).alignment = centerAlign;

                footerRow += 4; 

                ws.mergeCells(`A${footerRow}:B${footerRow}`);
                ws.getCell(`A${footerRow}`).value = kepsek;
                ws.getCell(`A${footerRow}`).font = { bold: true, underline: true };
                ws.getCell(`A${footerRow}`).alignment = centerAlign;

                ws.mergeCells(`D${footerRow}:E${footerRow}`);
                ws.getCell(`D${footerRow}`).value = wali;
                ws.getCell(`D${footerRow}`).font = { bold: true, underline: true };
                ws.getCell(`D${footerRow}`).alignment = centerAlign;

                footerRow++;
                ws.mergeCells(`A${footerRow}:B${footerRow}`);
                ws.getCell(`A${footerRow}`).value = "NIP. " + nipKepsek;
                ws.getCell(`A${footerRow}`).alignment = centerAlign;

                ws.mergeCells(`D${footerRow}:E${footerRow}`);
                ws.getCell(`D${footerRow}`).value = "NIP. " + nipWali;
                ws.getCell(`D${footerRow}`).alignment = centerAlign;

                // PROSES EXPORT DAN DOWNLOAD FILE
                const buffer = await wb.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                const fileName = `Roster_Jadwal_${sheetName}_${tahun.replace('/', '-')}.xlsx`;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                tutupModal('modalExportExcel');
                alert(`‚úÖ Roster jadwal berhasil didownload!\nNama Sekolah di Excel: ${namaSekolahExport}`);

            } catch (error) {
                console.error("Gagal export excel:", error);
                alert("‚ùå Terjadi kesalahan saat membuat file Excel.");
            }

            btnExport.innerHTML = teksAwalBtn; btnExport.disabled = false;
        };


        // --- FUNGSI SALIN JADWAL KELAS (MASSAL) DENGAN MODAL ---
        window.salinJadwalKelas = function() {
            if (firebaseConfig.apiKey === "API_KEY_ANDA") return alert("Isi config Firebase dahulu!");
            
            const kelasSumber = document.getElementById('filterKelas').value;
            if (kelasSumber === "Semua") {
                return alert("‚ö†Ô∏è Pilih kelas sumber yang ingin disalin dari dropdown 'Filter Kelas' terlebih dahulu! (Misal: 1A)");
            }

            const jadwalSumber = semuaJadwal.filter(j => j.kelas === kelasSumber);
            if (jadwalSumber.length === 0) {
                return alert(`Tidak ada jadwal di kelas ${kelasSumber} untuk disalin.`);
            }

            kelasSumberAktif = kelasSumber;
            document.getElementById('teksInfoSalin').innerText = `Menyalin ${jadwalSumber.length} baris jadwal dari kelas ${kelasSumber}. Pilih kelas tujuan:`;
            document.getElementById('pilihKelasTujuan').value = ""; 
            document.getElementById('modalSalinKelas').classList.remove('hidden');
        };

        window.prosesSalinKelas = async function(e) {
            const kelasTarget = document.getElementById('pilihKelasTujuan').value;
            
            if (!kelasTarget) return alert("Pilih kelas tujuan terlebih dahulu!");
            
            if (kelasTarget === kelasSumberAktif) {
                return alert("‚ùå Kelas tujuan tidak boleh sama dengan kelas sumber!");
            }

            const jadwalSumber = semuaJadwal.filter(j => j.kelas === kelasSumberAktif);

            if (confirm(`Yakin ingin menyalin jadwal ${kelasSumberAktif} ke ${kelasTarget}? \n(Hari, Waktu, dan Mapel akan disamakan, tetapi Nama Guru akan dikosongkan agar Anda bisa mengisinya ulang)`)) {
                
                const btnSubmit = e.target;
                const teksAsli = btnSubmit.innerHTML;
                btnSubmit.innerHTML = "‚è≥ Menyalin..."; btnSubmit.disabled = true;

                try {
                    const batch = writeBatch(db);
                    
                    jadwalSumber.forEach(j => {
                        const docRef = doc(collection(db, "jadwal_pelajaran")); 
                        batch.set(docRef, {
                            hari: j.hari,
                            waktu: j.waktu,
                            mapel: j.mapel,
                            kelas: kelasTarget,
                            guru: "", 
                            timestamp: new Date().getTime()
                        });
                    });

                    await batch.commit();
                    alert(`‚úÖ Berhasil menyalin ${jadwalSumber.length} jadwal ke kelas ${kelasTarget}!\nSilakan edit jadwal di kelas tersebut untuk mengisi nama guru.`);
                    
                    tutupModal('modalSalinKelas');
                    
                    document.getElementById('filterKelas').value = kelasTarget;
                    tampilkanJadwal();

                } catch (error) {
                    console.error("Error menyalin jadwal massal: ", error);
                    alert("‚ùå Gagal menyalin jadwal massal.");
                }

                btnSubmit.innerHTML = teksAsli; btnSubmit.disabled = false;
            }
        };

        // --- FUNGSI HAPUS SATUAN ---
        window.hapusJadwal = async function(id) {
            if(confirm("Apakah Anda yakin ingin menghapus jadwal ini?")) {
                await deleteDoc(doc(db, "jadwal_pelajaran", id));
            }
        };

        // --- FUNGSI HAPUS MASSAL ---
        window.hapusSemuaJadwal = async function() {
            if (firebaseConfig.apiKey === "API_KEY_ANDA") return alert("Isi config Firebase dahulu!");
            
            const kelasDipilih = document.getElementById('filterKelas').value;
            let pesan = kelasDipilih === "Semua" 
                ? "PERINGATAN Keras!\n\nAnda yakin ingin menghapus SEMUA jadwal dari semua kelas?\nTindakan ini tidak bisa dibatalkan!" 
                : `Yakin ingin menghapus SEMUA jadwal KHUSUS UNTUK KELAS ${kelasDipilih}?\n(Kelas lain tidak akan terhapus)`;

            if(confirm(pesan)) {
                try {
                    const batch = writeBatch(db);
                    let jumlahDihapus = 0;

                    semuaJadwal.forEach(j => {
                        if (kelasDipilih === "Semua" || j.kelas === kelasDipilih) {
                            const docRef = doc(db, "jadwal_pelajaran", j.id);
                            batch.delete(docRef);
                            jumlahDihapus++;
                        }
                    });

                    if (jumlahDihapus > 0) {
                        await batch.commit();
                        alert(`‚úÖ Berhasil menghapus ${jumlahDihapus} jadwal.`);
                    } else {
                        alert("Tidak ada jadwal yang bisa dihapus pada filter saat ini.");
                    }
                } catch(e) {
                    console.error("Error menghapus massal: ", e);
                    alert("‚ùå Gagal menghapus jadwal.");
                }
            }
        };

        // Inisialisasi
        muatDataJadwal();
    </script>
</body>
</html>
