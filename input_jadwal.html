<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Input Jadwal Pelajaran</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8 font-sans text-gray-800">

    <div class="max-w-7xl mx-auto mb-6 flex flex-col sm:flex-row justify-between items-center gap-4">
        <h1 class="text-3xl font-extrabold text-blue-800">üìÖ Kelola Jadwal Pelajaran</h1>
        
        <div class="flex gap-3">
            <!-- Tombol ke Halaman Depan -->
            <a href="/index.html" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg transition shadow">
                üè† Halaman Depan
            </a>
            <!-- Tombol ke Master Data -->
            <a href="/kelola_data.html" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition shadow flex items-center gap-2">
                ‚öôÔ∏è Master Data
            </a>
        </div>
    </div>

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- FORM INPUT JADWAL -->
        <div class="lg:col-span-1 bg-white rounded-2xl shadow-xl p-6 border border-blue-100 h-fit">
            <h2 class="text-xl font-bold text-blue-700 mb-4 border-b pb-2">‚ûï Tambah Jadwal</h2>
            
            <form id="formJadwal" class="space-y-4" onsubmit="simpanJadwal(event)">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Hari</label>
                    <select id="pilihHari" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-gray-50" required>
                        <option value="">-- Pilih Hari --</option>
                        <option value="Senin">Senin</option>
                        <option value="Selasa">Selasa</option>
                        <option value="Rabu">Rabu</option>
                        <option value="Kamis">Kamis</option>
                        <option value="Jumat">Jumat</option>
                        <option value="Sabtu">Sabtu</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Kelas</label>
                    <select id="pilihKelas" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-gray-50" required>
                        <option value="">Memuat...</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Waktu / Jam</label>
                    <select id="pilihWaktu" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-gray-50" required>
                        <option value="">Memuat...</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Mata Pelajaran</label>
                    <select id="pilihMapel" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-gray-50" required>
                        <option value="">Memuat...</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Guru Pengajar</label>
                    <select id="pilihGuru" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-gray-50" required>
                        <option value="">Memuat...</option>
                    </select>
                </div>

                <button type="submit" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition transform hover:-translate-y-0.5">
                    üíæ Simpan Jadwal
                </button>
            </form>
        </div>

        <!-- TABEL PREVIEW JADWAL -->
        <div class="lg:col-span-2 bg-white rounded-2xl shadow-xl p-6 border border-gray-100">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4 border-b pb-4">
                <h2 class="text-xl font-bold text-gray-800">üìã Daftar Jadwal</h2>
                
                <div class="flex items-center gap-2 w-full sm:w-auto">
                    <label class="text-sm font-bold text-gray-600 whitespace-nowrap">Filter Kelas:</label>
                    <select id="filterKelas" onchange="tampilkanJadwal()" class="w-full sm:w-48 p-2 border border-gray-300 rounded-lg bg-gray-50 font-semibold text-blue-700">
                        <option value="Semua">Semua Kelas</option>
                    </select>
                </div>
            </div>

            <div class="overflow-x-auto rounded-lg border border-gray-200">
                <table class="min-w-full bg-white text-sm text-left">
                    <thead class="bg-blue-50 text-blue-900 uppercase font-bold text-xs border-b">
                        <tr>
                            <th class="py-3 px-4">Hari</th>
                            <th class="py-3 px-4">Waktu</th>
                            <th class="py-3 px-4">Kelas</th>
                            <th class="py-3 px-4">Mata Pelajaran</th>
                            <th class="py-3 px-4">Guru</th>
                            <th class="py-3 px-4 text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="tabelJadwal" class="divide-y divide-gray-100">
                        <tr><td colspan="6" class="text-center py-4 text-gray-500">Memuat data jadwal...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // ========================================================
        // KONFIGURASI FIREBASE
        // ========================================================
        let firebaseConfig = { 
            apiKey: "API_KEY_ANDA",
            authDomain: "PROJECT_ID.firebaseapp.com",
            projectId: "PROJECT_ID",
            storageBucket: "PROJECT_ID.appspot.com",
            messagingSenderId: "SENDER_ID",
            appId: "APP_ID"
        };
        try {
            const module = await import("./firebase-config.js");
            if (module && module.firebaseConfig) { firebaseConfig = module.firebaseConfig; }
        } catch (error) { console.warn("Mode lokal."); }

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let semuaJadwal = []; // Menyimpan semua jadwal di memori

        // --- FUNGSI MUAT DROPDOWN DARI MASTER DATA ---
        function muatDropdown(koleksi, idSelect, isWaktu = false) {
            if (firebaseConfig.apiKey === "API_KEY_ANDA") return;
            onSnapshot(collection(db, koleksi), (snapshot) => {
                const selectEl = document.getElementById(idSelect);
                // Jika ini dropdown untuk filter kelas, pertahankan opsi "Semua Kelas"
                if (idSelect === 'filterKelas') {
                    selectEl.innerHTML = '<option value="Semua">Semua Kelas</option>';
                } else {
                    selectEl.innerHTML = '<option value="">-- Pilih --</option>';
                }
                
                let dataArr = [];
                snapshot.forEach(docSnap => dataArr.push(docSnap.data()));

                // Pengurutan khusus untuk Waktu agar berurutan sesuai jam
                if(isWaktu) {
                    dataArr.sort((a, b) => {
                        let t1 = a.waktu || a.nama || "";
                        let t2 = b.waktu || b.nama || "";
                        return t1.localeCompare(t2);
                    });
                } else {
                    // Urut abjad untuk yang lain
                    dataArr.sort((a,b) => (a.nama || "").localeCompare(b.nama || ""));
                }

                dataArr.forEach(data => {
                    const nilai = data.nama || data.waktu;
                    if(nilai) {
                        selectEl.insertAdjacentHTML('beforeend', `<option value="${nilai}">${nilai}</option>`);
                    }
                });
            });
        }

        // Panggil untuk mengisi semua pilihan
        muatDropdown("master_kelas", "pilihKelas");
        muatDropdown("master_kelas", "filterKelas"); // Untuk filter tabel
        muatDropdown("master_waktu", "pilihWaktu", true);
        muatDropdown("master_mapel", "pilihMapel");
        muatDropdown("master_guru", "pilihGuru");

        // --- FUNGSI SIMPAN JADWAL ---
        window.simpanJadwal = async function(e) {
            e.preventDefault();
            if (firebaseConfig.apiKey === "API_KEY_ANDA") return alert("Isi config Firebase dahulu!");

            const jadwalBaru = {
                hari: document.getElementById('pilihHari').value,
                kelas: document.getElementById('pilihKelas').value,
                waktu: document.getElementById('pilihWaktu').value,
                mapel: document.getElementById('pilihMapel').value,
                guru: document.getElementById('pilihGuru').value,
                timestamp: new Date().getTime()
            };

            try {
                // Simpan ke koleksi 'jadwal_pelajaran'
                await addDoc(collection(db, "jadwal_pelajaran"), jadwalBaru);
                alert("‚úÖ Jadwal Berhasil Disimpan!");
            } catch (error) {
                console.error("Error menambah jadwal: ", error);
                alert("‚ùå Gagal menyimpan jadwal.");
            }
        };

        // --- FUNGSI TAMPILKAN JADWAL DI TABEL ---
        function muatDataJadwal() {
            if (firebaseConfig.apiKey === "API_KEY_ANDA") return;
            onSnapshot(collection(db, "jadwal_pelajaran"), (snapshot) => {
                semuaJadwal = [];
                snapshot.forEach(docSnap => {
                    semuaJadwal.push({ id: docSnap.id, ...docSnap.data() });
                });
                tampilkanJadwal();
            });
        }

        const urutanHari = { "Senin":1, "Selasa":2, "Rabu":3, "Kamis":4, "Jumat":5, "Sabtu":6, "Minggu":7 };

        window.tampilkanJadwal = function() {
            const tabel = document.getElementById('tabelJadwal');
            const kelasDipilih = document.getElementById('filterKelas').value;
            tabel.innerHTML = '';

            // Filter di JavaScript
            let jadwalTerfilter = semuaJadwal;
            if (kelasDipilih !== "Semua") {
                jadwalTerfilter = semuaJadwal.filter(j => j.kelas === kelasDipilih);
            }

            // Urutkan berdasarkan Hari, lalu Waktu
            jadwalTerfilter.sort((a, b) => {
                if (urutanHari[a.hari] !== urutanHari[b.hari]) {
                    return urutanHari[a.hari] - urutanHari[b.hari];
                }
                return (a.waktu || "").localeCompare(b.waktu || "");
            });

            if (jadwalTerfilter.length === 0) {
                tabel.innerHTML = `<tr><td colspan="6" class="text-center py-6 text-gray-500 italic">Belum ada data jadwal untuk kelas ini.</td></tr>`;
                return;
            }

            jadwalTerfilter.forEach(j => {
                // Warna background beda untuk tiap hari agar mudah dibaca
                let bgHari = "bg-gray-50";
                if(j.hari === "Senin") bgHari = "bg-red-50 text-red-700";
                if(j.hari === "Selasa") bgHari = "bg-orange-50 text-orange-700";
                if(j.hari === "Rabu") bgHari = "bg-yellow-50 text-yellow-700";
                if(j.hari === "Kamis") bgHari = "bg-green-50 text-green-700";
                if(j.hari === "Jumat") bgHari = "bg-blue-50 text-blue-700";
                if(j.hari === "Sabtu") bgHari = "bg-purple-50 text-purple-700";

                tabel.insertAdjacentHTML('beforeend', `
                    <tr class="hover:bg-gray-50 transition duration-150">
                        <td class="py-3 px-4"><span class="px-2 py-1 rounded-md font-bold text-xs ${bgHari}">${j.hari}</span></td>
                        <td class="py-3 px-4 font-medium">${j.waktu}</td>
                        <td class="py-3 px-4 font-bold text-gray-700">${j.kelas}</td>
                        <td class="py-3 px-4">${j.mapel}</td>
                        <td class="py-3 px-4">${j.guru}</td>
                        <td class="py-3 px-4 text-center">
                            <button onclick="hapusJadwal('${j.id}')" class="bg-red-100 text-red-600 hover:bg-red-500 hover:text-white p-2 rounded transition" title="Hapus">
                                üóëÔ∏è
                            </button>
                        </td>
                    </tr>
                `);
            });
        };

        // --- FUNGSI HAPUS JADWAL ---
        window.hapusJadwal = async function(id) {
            if(confirm("Apakah Anda yakin ingin menghapus jadwal ini?")) {
                await deleteDoc(doc(db, "jadwal_pelajaran", id));
            }
        };

        // Inisialisasi
        muatDataJadwal();
    </script>
</body>
</html>
