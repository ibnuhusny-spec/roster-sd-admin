<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Input Jadwal Pelajaran</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8 font-sans text-gray-800">

    <div class="max-w-7xl mx-auto mb-6 flex flex-col sm:flex-row justify-between items-center gap-4">
        <h1 class="text-3xl font-extrabold text-blue-800">üìÖ Kelola Jadwal Pelajaran</h1>
        
        <div class="flex gap-3">
            <a href="/index.html" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg transition shadow">
                üè† Halaman Depan
            </a>
            <a href="/kelola_data.html" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition shadow flex items-center gap-2">
                ‚öôÔ∏è Master Data
            </a>
        </div>
    </div>

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
        
        <!-- FORM INPUT JADWAL (Sticky) -->
        <div class="lg:col-span-1 bg-white rounded-2xl shadow-xl p-6 border border-blue-100 h-fit sticky top-6">
            <h2 id="formTitle" class="text-xl font-bold text-blue-700 mb-4 border-b pb-2">‚ûï Tambah Jadwal</h2>
            
            <form id="formJadwal" class="space-y-4" onsubmit="simpanJadwal(event)">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Hari</label>
                    <select id="pilihHari" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-gray-50" required>
                        <option value="">-- Pilih Hari --</option>
                        <option value="Senin">Senin</option>
                        <option value="Selasa">Selasa</option>
                        <option value="Rabu">Rabu</option>
                        <option value="Kamis">Kamis</option>
                        <option value="Jumat">Jumat</option>
                        <option value="Sabtu">Sabtu</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Kelas</label>
                    <select id="pilihKelas" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-gray-50" required>
                        <option value="">Memuat...</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Waktu / Jam</label>
                    <select id="pilihWaktu" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-gray-50" required>
                        <option value="">Memuat...</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Mata Pelajaran</label>
                    <select id="pilihMapel" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-gray-50" required>
                        <option value="">Memuat...</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Guru Pengajar</label>
                    <select id="pilihGuru" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-gray-50" required>
                        <option value="">Memuat...</option>
                    </select>
                </div>

                <div class="flex gap-2 mt-4">
                    <button type="button" id="btnBatalEdit" onclick="batalEdit()" class="hidden w-1/3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-4 rounded-xl shadow transition">
                        Batal
                    </button>
                    <button type="submit" id="btnSubmitJadwal" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition transform hover:-translate-y-0.5">
                        üíæ Simpan Jadwal
                    </button>
                </div>
            </form>
        </div>

        <!-- TABEL PREVIEW JADWAL -->
        <div class="lg:col-span-2 bg-white rounded-2xl shadow-xl p-6 border border-gray-100">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4 border-b pb-4">
                <h2 class="text-xl font-bold text-gray-800">üìã Daftar Jadwal</h2>
                
                <div class="flex items-center gap-2 w-full sm:w-auto">
                    <button onclick="salinJadwalKelas()" class="bg-blue-100 hover:bg-blue-600 text-blue-700 hover:text-white font-bold py-2 px-4 rounded-lg text-sm transition shadow flex items-center gap-1" title="Salin seluruh jadwal kelas ini ke kelas lain">
                        üìã Salin Kelas
                    </button>
                    <button onclick="hapusSemuaJadwal()" class="bg-red-100 hover:bg-red-600 text-red-700 hover:text-white font-bold py-2 px-4 rounded-lg text-sm transition shadow flex items-center gap-1">
                        üóëÔ∏è Hapus Semua
                    </button>

                    <label class="text-sm font-bold text-gray-600 whitespace-nowrap ml-2">Filter Kelas:</label>
                    <select id="filterKelas" onchange="tampilkanJadwal()" class="w-full sm:w-48 p-2 border border-gray-300 rounded-lg bg-gray-50 font-semibold text-blue-700">
                        <option value="Semua">Semua Kelas</option>
                    </select>
                </div>
            </div>

            <!-- Tabel yang bisa di-scroll sendiri -->
            <div class="overflow-y-auto max-h-[calc(100vh-220px)] rounded-lg border border-gray-200 relative">
                <table class="min-w-full bg-white text-sm text-left relative">
                    <thead class="bg-blue-50 text-blue-900 uppercase font-bold text-xs sticky top-0 z-10 shadow-sm">
                        <tr>
                            <th class="py-3 px-4 bg-blue-50">Hari</th>
                            <th class="py-3 px-4 bg-blue-50">Waktu</th>
                            <th class="py-3 px-4 bg-blue-50">Kelas</th>
                            <th class="py-3 px-4 bg-blue-50">Mata Pelajaran</th>
                            <th class="py-3 px-4 bg-blue-50">Guru</th>
                            <th class="py-3 px-4 bg-blue-50 text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="tabelJadwal" class="divide-y divide-gray-100">
                        <tr><td colspan="6" class="text-center py-4 text-gray-500">Memuat data jadwal...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        let firebaseConfig = { 
            apiKey: "API_KEY_ANDA",
            authDomain: "PROJECT_ID.firebaseapp.com",
            projectId: "PROJECT_ID",
            storageBucket: "PROJECT_ID.appspot.com",
            messagingSenderId: "SENDER_ID",
            appId: "APP_ID"
        };
        try {
            const module = await import("./firebase-config.js");
            if (module && module.firebaseConfig) { firebaseConfig = module.firebaseConfig; }
        } catch (error) { console.warn("Mode lokal."); }

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let semuaJadwal = []; 
        let idEditJadwal = null; 

        // --- MUAT DROPDOWN ---
        function muatDropdown(koleksi, idSelect, isWaktu = false) {
            if (firebaseConfig.apiKey === "API_KEY_ANDA") return;
            onSnapshot(collection(db, koleksi), (snapshot) => {
                const selectEl = document.getElementById(idSelect);
                if (idSelect === 'filterKelas') {
                    selectEl.innerHTML = '<option value="Semua">Semua Kelas</option>';
                } else {
                    selectEl.innerHTML = '<option value="">-- Pilih --</option>';
                }
                
                let dataArr = [];
                snapshot.forEach(docSnap => dataArr.push(docSnap.data()));

                if(isWaktu) {
                    dataArr.sort((a, b) => {
                        let t1 = a.waktu || a.nama || "";
                        let t2 = b.waktu || b.nama || "";
                        return t1.localeCompare(t2);
                    });
                } else {
                    dataArr.sort((a,b) => (a.nama || "").localeCompare(b.nama || ""));
                }

                dataArr.forEach(data => {
                    const nilai = data.nama || data.waktu;
                    if(nilai) {
                        selectEl.insertAdjacentHTML('beforeend', `<option value="${nilai}">${nilai}</option>`);
                    }
                });
            });
        }

        muatDropdown("master_kelas", "pilihKelas");
        muatDropdown("master_kelas", "filterKelas");
        muatDropdown("master_waktu", "pilihWaktu", true);
        muatDropdown("master_mapel", "pilihMapel");
        muatDropdown("master_guru", "pilihGuru");

        // --- FUNGSI BATAL EDIT ---
        window.batalEdit = function() {
            idEditJadwal = null;
            document.getElementById('formJadwal').reset();
            const btnSubmit = document.getElementById('btnSubmitJadwal');
            btnSubmit.innerHTML = "üíæ Simpan Jadwal";
            btnSubmit.classList.replace("bg-green-600", "bg-blue-600");
            btnSubmit.classList.replace("hover:bg-green-700", "hover:bg-blue-700");
            document.getElementById('formTitle').innerText = "‚ûï Tambah Jadwal";
            document.getElementById('btnBatalEdit').classList.add('hidden');
            btnSubmit.classList.remove('w-2/3');
            btnSubmit.classList.add('w-full');
        };

        // --- FUNGSI SIMPAN & UPDATE ---
        window.simpanJadwal = async function(e) {
            e.preventDefault();
            if (firebaseConfig.apiKey === "API_KEY_ANDA") return alert("Isi config Firebase dahulu!");

            const jadwalBaru = {
                hari: document.getElementById('pilihHari').value,
                kelas: document.getElementById('pilihKelas').value,
                waktu: document.getElementById('pilihWaktu').value,
                mapel: document.getElementById('pilihMapel').value,
                guru: document.getElementById('pilihGuru').value,
                timestamp: new Date().getTime()
            };

            const btnSubmit = document.getElementById('btnSubmitJadwal');
            const teksAsli = btnSubmit.innerHTML;
            btnSubmit.innerHTML = "‚è≥ Memproses..."; btnSubmit.disabled = true;

            try {
                if (idEditJadwal) {
                    await updateDoc(doc(db, "jadwal_pelajaran", idEditJadwal), jadwalBaru);
                    alert("‚úÖ Jadwal Berhasil Diperbarui!");
                    batalEdit();
                } else {
                    await addDoc(collection(db, "jadwal_pelajaran"), jadwalBaru);
                    alert("‚úÖ Jadwal Berhasil Disimpan!");
                    // Menghapus perintah reset form agar isian sebelumnya tetap ada
                    // document.getElementById('formJadwal').reset();
                }
            } catch (error) {
                console.error("Error menyimpan jadwal: ", error);
                alert("‚ùå Gagal menyimpan jadwal.");
            }
            
            btnSubmit.innerHTML = teksAsli; btnSubmit.disabled = false;
        };

        // --- FUNGSI TAMPILKAN JADWAL ---
        function muatDataJadwal() {
            if (firebaseConfig.apiKey === "API_KEY_ANDA") return;
            onSnapshot(collection(db, "jadwal_pelajaran"), (snapshot) => {
                semuaJadwal = [];
                snapshot.forEach(docSnap => {
                    semuaJadwal.push({ id: docSnap.id, ...docSnap.data() });
                });
                tampilkanJadwal();
            });
        }

        const urutanHari = { "Senin":1, "Selasa":2, "Rabu":3, "Kamis":4, "Jumat":5, "Sabtu":6, "Minggu":7 };

        window.tampilkanJadwal = function() {
            const tabel = document.getElementById('tabelJadwal');
            const kelasDipilih = document.getElementById('filterKelas').value;
            tabel.innerHTML = '';

            let jadwalTerfilter = semuaJadwal;
            if (kelasDipilih !== "Semua") {
                jadwalTerfilter = semuaJadwal.filter(j => j.kelas === kelasDipilih);
            }

            jadwalTerfilter.sort((a, b) => {
                if (urutanHari[a.hari] !== urutanHari[b.hari]) {
                    return urutanHari[a.hari] - urutanHari[b.hari];
                }
                return (a.waktu || "").localeCompare(b.waktu || "");
            });

            if (jadwalTerfilter.length === 0) {
                tabel.innerHTML = `<tr><td colspan="6" class="text-center py-6 text-gray-500 italic">Belum ada data jadwal untuk kelas ini.</td></tr>`;
                return;
            }

            jadwalTerfilter.forEach(j => {
                let bgHari = "bg-gray-50";
                if(j.hari === "Senin") bgHari = "bg-red-50 text-red-700";
                if(j.hari === "Selasa") bgHari = "bg-orange-50 text-orange-700";
                if(j.hari === "Rabu") bgHari = "bg-yellow-50 text-yellow-700";
                if(j.hari === "Kamis") bgHari = "bg-green-50 text-green-700";
                if(j.hari === "Jumat") bgHari = "bg-blue-50 text-blue-700";
                if(j.hari === "Sabtu") bgHari = "bg-purple-50 text-purple-700";

                tabel.insertAdjacentHTML('beforeend', `
                    <tr class="hover:bg-gray-50 transition duration-150">
                        <td class="py-3 px-4"><span class="px-2 py-1 rounded-md font-bold text-xs ${bgHari}">${j.hari}</span></td>
                        <td class="py-3 px-4 font-medium">${j.waktu}</td>
                        <td class="py-3 px-4 font-bold text-gray-700">${j.kelas}</td>
                        <td class="py-3 px-4">${j.mapel}</td>
                        <td class="py-3 px-4">${j.guru ? j.guru : '<span class="text-red-500 italic font-semibold">Belum diisi</span>'}</td>
                        <td class="py-3 px-4 text-center whitespace-nowrap">
                            <button onclick="editJadwal('${j.id}')" class="bg-yellow-100 text-yellow-600 hover:bg-yellow-500 hover:text-white p-2 rounded transition mr-1" title="Edit">
                                ‚úèÔ∏è
                            </button>
                            <button onclick="hapusJadwal('${j.id}')" class="bg-red-100 text-red-600 hover:bg-red-500 hover:text-white p-2 rounded transition" title="Hapus">
                                üóëÔ∏è
                            </button>
                        </td>
                    </tr>
                `);
            });
        };

        // --- FUNGSI EDIT JADWAL ---
        window.editJadwal = function(id) {
            const jadwal = semuaJadwal.find(j => j.id === id);
            if(!jadwal) return;
            
            document.getElementById('pilihHari').value = jadwal.hari;
            document.getElementById('pilihKelas').value = jadwal.kelas;
            document.getElementById('pilihWaktu').value = jadwal.waktu;
            document.getElementById('pilihMapel').value = jadwal.mapel;
            document.getElementById('pilihGuru').value = jadwal.guru;
            
            idEditJadwal = id; 
            
            const btnSubmit = document.getElementById('btnSubmitJadwal');
            btnSubmit.innerHTML = "üîÑ Update Jadwal";
            btnSubmit.classList.replace("bg-blue-600", "bg-green-600");
            btnSubmit.classList.replace("hover:bg-blue-700", "hover:bg-green-700");
            btnSubmit.classList.remove('w-full');
            btnSubmit.classList.add('w-2/3');
            
            document.getElementById('formTitle').innerText = "‚úèÔ∏è Edit Jadwal";
            document.getElementById('btnBatalEdit').classList.remove('hidden');
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        // --- FUNGSI SALIN JADWAL KELAS (MASSAL) ---
        window.salinJadwalKelas = async function() {
            if (firebaseConfig.apiKey === "API_KEY_ANDA") return alert("Isi config Firebase dahulu!");
            
            const kelasSumber = document.getElementById('filterKelas').value;
            if (kelasSumber === "Semua") {
                return alert("‚ö†Ô∏è Pilih kelas sumber yang ingin disalin dari dropdown 'Filter Kelas' terlebih dahulu! (Misal: 1A)");
            }

            const jadwalSumber = semuaJadwal.filter(j => j.kelas === kelasSumber);
            if (jadwalSumber.length === 0) {
                return alert(`Tidak ada jadwal di kelas ${kelasSumber} untuk disalin.`);
            }

            const kelasTarget = prompt(`Anda akan menyalin ${jadwalSumber.length} jadwal dari kelas ${kelasSumber}.\n\nMasukkan NAMA KELAS TUJUAN (contoh: 1B):`);
            
            if (!kelasTarget || kelasTarget.trim() === "") return; // Dibatalkan oleh user
            
            if (kelasTarget.trim() === kelasSumber) {
                return alert("‚ùå Kelas tujuan tidak boleh sama dengan kelas sumber!");
            }

            if (confirm(`Yakin ingin menyalin jadwal ${kelasSumber} ke ${kelasTarget}? \n(Hari, Waktu, dan Mapel akan disamakan, tetapi Nama Guru akan dikosongkan agar Anda bisa mengisinya ulang)`)) {
                try {
                    const batch = writeBatch(db);
                    
                    jadwalSumber.forEach(j => {
                        const docRef = doc(collection(db, "jadwal_pelajaran")); // Auto-generate ID dokumen baru
                        batch.set(docRef, {
                            hari: j.hari,
                            waktu: j.waktu,
                            mapel: j.mapel,
                            kelas: kelasTarget.trim(),
                            guru: "", // Sengaja dikosongkan agar diisi ulang
                            timestamp: new Date().getTime()
                        });
                    });

                    await batch.commit();
                    alert(`‚úÖ Berhasil menyalin ${jadwalSumber.length} jadwal ke kelas ${kelasTarget.trim()}!\nSilakan edit jadwal di kelas tersebut untuk mengisi nama guru.`);
                    
                    // Otomatis ubah filter ke kelas hasil salinan
                    const filterEl = document.getElementById('filterKelas');
                    if (![...filterEl.options].some(opt => opt.value === kelasTarget.trim())) {
                        filterEl.insertAdjacentHTML('beforeend', `<option value="${kelasTarget.trim()}">${kelasTarget.trim()}</option>`);
                    }
                    filterEl.value = kelasTarget.trim();
                    tampilkanJadwal();

                } catch (e) {
                    console.error("Error menyalin jadwal massal: ", e);
                    alert("‚ùå Gagal menyalin jadwal massal.");
                }
            }
        };

        // --- FUNGSI HAPUS SATUAN ---
        window.hapusJadwal = async function(id) {
            if(confirm("Apakah Anda yakin ingin menghapus jadwal ini?")) {
                await deleteDoc(doc(db, "jadwal_pelajaran", id));
            }
        };

        // --- FUNGSI HAPUS MASSAL ---
        window.hapusSemuaJadwal = async function() {
            if (firebaseConfig.apiKey === "API_KEY_ANDA") return alert("Isi config Firebase dahulu!");
            
            const kelasDipilih = document.getElementById('filterKelas').value;
            let pesan = kelasDipilih === "Semua" 
                ? "PERINGATAN Keras!\n\nAnda yakin ingin menghapus SEMUA jadwal dari semua kelas?\nTindakan ini tidak bisa dibatalkan!" 
                : `Yakin ingin menghapus SEMUA jadwal KHUSUS UNTUK KELAS ${kelasDipilih}?\n(Kelas lain tidak akan terhapus)`;

            if(confirm(pesan)) {
                try {
                    const batch = writeBatch(db);
                    let jumlahDihapus = 0;

                    semuaJadwal.forEach(j => {
                        if (kelasDipilih === "Semua" || j.kelas === kelasDipilih) {
                            const docRef = doc(db, "jadwal_pelajaran", j.id);
                            batch.delete(docRef);
                            jumlahDihapus++;
                        }
                    });

                    if (jumlahDihapus > 0) {
                        await batch.commit();
                        alert(`‚úÖ Berhasil menghapus ${jumlahDihapus} jadwal.`);
                    } else {
                        alert("Tidak ada jadwal yang bisa dihapus pada filter saat ini.");
                    }
                } catch(e) {
                    console.error("Error menghapus massal: ", e);
                    alert("‚ùå Gagal menghapus jadwal.");
                }
            }
        };

        // Inisialisasi
        muatDataJadwal();
    </script>
</body>
</html>
