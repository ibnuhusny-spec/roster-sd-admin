<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Input Jadwal - ROSTERKU</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- jQuery & Select2 -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <style>
        .select2-container .select2-selection--single {
            height: 46px !important; border-radius: 0.75rem !important; border: 1px solid #d1d5db !important;
            background-color: #f9fafb !important; display: flex !important; align-items: center !important;
            padding-left: 0.25rem;
        }
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 44px !important; right: 10px !important;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-gray-800">

    <!-- Navbar -->
    <nav class="bg-blue-800 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">‚öôÔ∏è</span>
                    <span class="font-bold text-white text-lg tracking-wide">Panel Admin Jadwal</span>
                </div>
                <div class="flex gap-4">
                    <a href="kelola_data.html" class="text-blue-200 hover:text-white font-medium flex items-center gap-1 transition text-sm">
                        <span>üìÅ</span> Kelola Data Master
                    </a>
                    <a href="index.html" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded-lg font-medium flex items-center gap-1 transition text-sm shadow-sm">
                        <span>üö™</span> Keluar
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto p-4 md:p-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- FORM INPUT JADWAL -->
            <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-sm border border-gray-200 h-fit sticky top-6">
                <h2 id="judulForm" class="text-xl font-extrabold text-blue-800 mb-4 flex items-center gap-2">
                    <span>‚ûï</span> Tambah Jadwal Baru
                </h2>
                
                <form id="formJadwal" onsubmit="simpanJadwal(event)" class="space-y-4">
                    <input type="hidden" id="editId">
                    
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Hari</label>
                        <select id="inputHari" class="w-full searchable" required>
                            <option value="">-- Pilih Hari --</option>
                            <option value="Senin">Senin</option><option value="Selasa">Selasa</option>
                            <option value="Rabu">Rabu</option><option value="Kamis">Kamis</option>
                            <option value="Jumat">Jumat</option><option value="Sabtu">Sabtu</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Waktu</label>
                        <!-- Mengambil dari master_waktu -->
                        <select id="inputWaktu" class="w-full searchable" required>
                            <option value="">-- Pilih Waktu --</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Kelas</label>
                        <select id="inputKelas" class="w-full searchable" required>
                            <option value="">-- Pilih Kelas --</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Mata Pelajaran</label>
                        <select id="inputMapel" class="w-full searchable" required>
                            <option value="">-- Pilih Mapel --</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Guru Pengajar</label>
                        <select id="inputGuru" class="w-full searchable" required>
                            <option value="">-- Pilih Guru --</option>
                        </select>
                    </div>

                    <div class="pt-4 flex gap-2">
                        <button type="button" id="btnBatal" onclick="resetForm()" class="hidden w-1/3 px-4 py-3 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-xl font-semibold transition">Batal</button>
                        <button type="submit" id="btnSimpan" class="w-full px-4 py-3 text-white bg-blue-600 hover:bg-blue-700 shadow-lg rounded-xl font-bold transition flex justify-center items-center gap-2">
                            üíæ Simpan Jadwal
                        </button>
                    </div>
                </form>
            </div>

            <!-- TABEL & ACTIONS -->
            <div class="lg:col-span-2">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 mb-4 flex flex-col md:flex-row justify-between items-center gap-4">
                    <div>
                        <h2 class="text-xl font-extrabold text-gray-800 mb-1">Daftar Jadwal</h2>
                        <select id="filterKelasTable" class="p-2 border border-gray-300 rounded-lg bg-gray-50 text-sm font-semibold text-blue-700 searchable">
                            <option value="Semua">Semua Kelas</option>
                        </select>
                    </div>
                    
                    <!-- TOMBOL FITUR EKSKLUSIF -->
                    <div class="flex flex-wrap gap-2 items-center">
                        <button onclick="bukaModalTerapkanGuru()" class="bg-amber-500 hover:bg-amber-600 text-white px-3 py-2 rounded-lg text-sm font-bold shadow transition flex items-center gap-1">
                            <span>üë®‚Äçüè´</span> Terapkan Guru
                        </button>
                        <button onclick="bukaModalSalinKelas()" class="bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-2 rounded-lg text-sm font-bold shadow transition flex items-center gap-1">
                            <span>üìë</span> Salin Kelas
                        </button>
                        <button onclick="bukaModalExcel()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2 rounded-lg text-sm font-bold shadow transition flex items-center gap-1">
                            <span>üìä</span> Excel
                        </button>
                        <div class="h-6 w-px bg-gray-300 hidden md:block mx-1"></div>
                        <button onclick="hapusJadwalPerKelas()" class="bg-red-400 hover:bg-red-500 text-white px-3 py-2 rounded-lg text-sm font-bold shadow transition flex items-center gap-1" title="Hapus seluruh jadwal dari kelas yang sedang difilter">
                            <span>üßπ</span> Hapus Kelas
                        </button>
                        <button onclick="hapusSemuaJadwal()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg text-sm font-bold shadow transition flex items-center gap-1" title="Hapus seluruh database jadwal">
                            <span>üö®</span> Hapus Semua
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-200">
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm text-left">
                            <thead class="bg-gray-50 text-gray-600 uppercase font-bold text-xs border-b">
                                <tr>
                                    <th class="py-3 px-4">Hari</th>
                                    <th class="py-3 px-4">Waktu</th>
                                    <th class="py-3 px-4">Kelas</th>
                                    <th class="py-3 px-4">Mapel & Guru</th>
                                    <th class="py-3 px-4 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="tabelJadwal" class="divide-y divide-gray-100">
                                <tr><td colspan="5" class="text-center py-6 text-gray-400 italic">Memuat data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DOWNLOAD EXCEL -->
    <div id="modalExcel" class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden animate-fade-in-up">
            <div class="bg-emerald-600 p-4 flex justify-between items-center text-white">
                <h3 class="font-bold text-lg flex items-center gap-2"><span>üìä</span> Pengaturan Cetak Excel</h3>
                <button onclick="tutupModalExcel()" class="text-white hover:text-gray-200 font-bold text-xl">&times;</button>
            </div>
            <div class="p-6 space-y-4 text-sm">
                <div>
                    <label class="block font-bold text-gray-700 mb-1">Kop Surat Baris 1</label>
                    <input type="text" id="exKop1" value="PEMERINTAH KABUPATEN / KOTA" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-emerald-500">
                </div>
                <div>
                    <label class="block font-bold text-gray-700 mb-1">Kop Surat Baris 2 (Nama Sekolah)</label>
                    <input type="text" id="exKop2" value="UPT SD NEGERI CONTOH" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-emerald-500">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block font-bold text-gray-700 mb-1">Nama Kepala Sekolah</label>
                        <input type="text" id="exKepsek" placeholder="Nama Kepsek..." class="w-full p-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block font-bold text-gray-700 mb-1">NIP Kepala Sekolah</label>
                        <input type="text" id="exNipKepsek" placeholder="NIP Kepsek..." class="w-full p-2 border rounded-lg">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block font-bold text-gray-700 mb-1">Nama Wali Kelas / Guru</label>
                        <input type="text" id="exWali" placeholder="Nama Guru..." class="w-full p-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block font-bold text-gray-700 mb-1">NIP Wali Kelas</label>
                        <input type="text" id="exNipWali" placeholder="NIP Guru..." class="w-full p-2 border rounded-lg">
                    </div>
                </div>
                <div>
                    <label class="block font-bold text-gray-700 mb-1">Tempat & Tanggal (Tanda Tangan)</label>
                    <input type="text" id="exTanggal" placeholder="Contoh: Makassar, 27 Februari 2026" class="w-full p-2 border rounded-lg">
                </div>
            </div>
            <div class="bg-gray-50 p-4 border-t flex justify-end gap-3">
                <button onclick="tutupModalExcel()" class="px-4 py-2 text-gray-600 bg-gray-200 hover:bg-gray-300 rounded-lg font-bold">Batal</button>
                <button onclick="prosesDownloadExcel()" class="px-4 py-2 text-white bg-emerald-600 hover:bg-emerald-700 rounded-lg font-bold flex items-center gap-2">
                    <span>‚¨áÔ∏è</span> Download File .xls
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL SALIN JADWAL KELAS -->
    <div id="modalSalin" class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-fade-in-up">
            <div class="bg-indigo-600 p-4 flex justify-between items-center text-white">
                <h3 class="font-bold text-lg flex items-center gap-2"><span>üìë</span> Salin Jadwal Antar Kelas</h3>
                <button onclick="tutupModalSalinKelas()" class="text-white hover:text-gray-200 font-bold text-xl">&times;</button>
            </div>
            <div class="p-6 space-y-4 text-sm">
                <p class="text-gray-600 text-xs mb-4">Fitur ini akan menyalin seluruh jadwal dari kelas asal ke kelas tujuan. <b class="text-red-600">Nama Guru akan dikosongkan</b> agar tidak terjadi bentrok.</p>
                <div>
                    <label class="block font-bold text-gray-700 mb-1">Salin DARI Kelas:</label>
                    <select id="salinDariKelas" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-gray-50">
                        <option value="">-- Pilih Kelas Asal --</option>
                    </select>
                </div>
                <div>
                    <label class="block font-bold text-gray-700 mb-1">Salin KE Kelas (Tujuan):</label>
                    <select id="salinKeKelas" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-gray-50">
                        <option value="">-- Pilih Kelas Tujuan --</option>
                    </select>
                </div>
            </div>
            <div class="bg-gray-50 p-4 border-t flex justify-end gap-3">
                <button onclick="tutupModalSalinKelas()" class="px-4 py-2 text-gray-600 bg-gray-200 hover:bg-gray-300 rounded-lg font-bold transition">Batal</button>
                <button id="btnProsesSalin" onclick="prosesSalinKelas()" class="px-4 py-2 text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg font-bold flex items-center gap-2 transition shadow">
                    <span>üìã</span> Proses Salin
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL TERAPKAN GURU -->
    <div id="modalTerapkanGuru" class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-fade-in-up">
            <div class="bg-amber-500 p-4 flex justify-between items-center text-white">
                <h3 class="font-bold text-lg flex items-center gap-2"><span>üë®‚Äçüè´</span> Terapkan Guru Massal</h3>
                <button onclick="tutupModalTerapkanGuru()" class="text-white hover:text-gray-100 font-bold text-xl">&times;</button>
            </div>
            <div class="p-6 space-y-4 text-sm">
                <p class="text-gray-600 text-xs mb-4">Fitur ini akan menerapkan guru yang dipilih ke <b>SELURUH</b> mata pelajaran pada kelas tersebut. (Sangat cocok untuk Guru Kelas/Wali Kelas SD).</p>
                <div>
                    <label class="block font-bold text-gray-700 mb-1">Pilih Kelas:</label>
                    <select id="terapkanKelas" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50">
                        <option value="">-- Pilih Kelas --</option>
                    </select>
                </div>
                <div>
                    <label class="block font-bold text-gray-700 mb-1">Terapkan Guru:</label>
                    <select id="terapkanGuru" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50">
                        <option value="">-- Pilih Guru --</option>
                    </select>
                </div>
            </div>
            <div class="bg-gray-50 p-4 border-t flex justify-end gap-3">
                <button onclick="tutupModalTerapkanGuru()" class="px-4 py-2 text-gray-600 bg-gray-200 hover:bg-gray-300 rounded-lg font-bold">Batal</button>
                <button onclick="prosesTerapkanGuru()" id="btnProsesTerapkan" class="px-4 py-2 text-white bg-amber-500 hover:bg-amber-600 rounded-lg font-bold flex items-center gap-2">
                    <span>‚úÖ</span> Terapkan
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        let firebaseConfig = null;
        try {
            const module = await import("./firebase-config.js");
            if (module && module.firebaseConfig) { firebaseConfig = module.firebaseConfig; }
        } catch (error) { console.warn("Lokal mode: gagal memuat konfigurasi"); }

        let app, db;
        if (firebaseConfig && firebaseConfig.projectId) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
        } else {
            console.warn("Mode Offline/Demo: Konfigurasi Firebase tidak lengkap atau 'projectId' tidak ditemukan.");
        }

        let semuaJadwal = [];

        // Inisialisasi Select2
        $(document).ready(function() {
            $('.searchable').select2();
            $('#filterKelasTable').on('change', function() { window.renderTabel(); });
        });

        // --- MENGAMBIL DATA MASTER DARI KELOLA DATA ---
        function muatDataMaster() {
            if (!db) return;
            
            // MASTER KELAS
            onSnapshot(collection(db, "master_kelas"), (snapshot) => {
                const selKelas = document.getElementById('inputKelas');
                const filterKelas = document.getElementById('filterKelasTable');
                const salinDari = document.getElementById('salinDariKelas');
                const salinKe = document.getElementById('salinKeKelas');
                const terapkanKls = document.getElementById('terapkanKelas');

                selKelas.innerHTML = '<option value="">-- Pilih Kelas --</option>';
                filterKelas.innerHTML = '<option value="Semua">Semua Kelas</option>';
                if(salinDari) salinDari.innerHTML = '<option value="">-- Pilih Kelas Asal --</option>';
                if(salinKe) salinKe.innerHTML = '<option value="">-- Pilih Kelas Tujuan --</option>';
                if(terapkanKls) terapkanKls.innerHTML = '<option value="">-- Pilih Kelas --</option>';

                let arr = []; snapshot.forEach(d => arr.push(d.data().nama));
                arr.sort((a,b)=>a.localeCompare(b)).forEach(nama => {
                    selKelas.insertAdjacentHTML('beforeend', `<option value="${nama}">${nama}</option>`);
                    filterKelas.insertAdjacentHTML('beforeend', `<option value="${nama}">${nama}</option>`);
                    if(salinDari) salinDari.insertAdjacentHTML('beforeend', `<option value="${nama}">${nama}</option>`);
                    if(salinKe) salinKe.insertAdjacentHTML('beforeend', `<option value="${nama}">${nama}</option>`);
                    if(terapkanKls) terapkanKls.insertAdjacentHTML('beforeend', `<option value="${nama}">${nama}</option>`);
                });
                $('#inputKelas').trigger('change'); $('#filterKelasTable').trigger('change');
            });

            // MASTER WAKTU (Dari Halaman Kelola Data)
            onSnapshot(collection(db, "master_waktu"), (snapshot) => {
                const sel = document.getElementById('inputWaktu');
                sel.innerHTML = '<option value="">-- Pilih Waktu --</option>';
                let arr = []; 
                snapshot.forEach(d => arr.push(d.data().waktu || d.data().nama));
                
                // Sorting Waktu
                arr.sort((a, b) => {
                    let m1 = (a||"").match(/\d+/g); let m2 = (b||"").match(/\d+/g);
                    let val1 = m1 ? parseInt(m1[0])*60 + (m1[1] ? parseInt(m1[1]) : 0) : 9999;
                    let val2 = m2 ? parseInt(m2[0])*60 + (m2[1] ? parseInt(m2[1]) : 0) : 9999;
                    if(val1 !== val2) return val1 - val2;
                    return a.localeCompare(b);
                });

                arr.forEach(w => sel.insertAdjacentHTML('beforeend', `<option value="${w}">${w}</option>`));
                $('#inputWaktu').trigger('change');
            });

            // MASTER MAPEL & GURU
            onSnapshot(collection(db, "master_mapel"), (snapshot) => {
                const sel = document.getElementById('inputMapel');
                sel.innerHTML = '<option value="">-- Pilih Mapel --</option>';

                let arr = []; snapshot.forEach(d => arr.push(d.data().nama));
                arr.sort().forEach(nama => {
                    sel.insertAdjacentHTML('beforeend', `<option value="${nama}">${nama}</option>`);
                });
                $('#inputMapel').trigger('change');
            });
            onSnapshot(collection(db, "master_guru"), (snapshot) => {
                const sel = document.getElementById('inputGuru');
                const terapkanGr = document.getElementById('terapkanGuru');
                sel.innerHTML = '<option value="">-- Pilih Guru --</option>';
                if(terapkanGr) terapkanGr.innerHTML = '<option value="">-- Pilih Guru --</option>';

                let arr = []; snapshot.forEach(d => arr.push(d.data().nama));
                arr.sort().forEach(nama => {
                    sel.insertAdjacentHTML('beforeend', `<option value="${nama}">${nama}</option>`);
                    if(terapkanGr) terapkanGr.insertAdjacentHTML('beforeend', `<option value="${nama}">${nama}</option>`);
                });
                $('#inputGuru').trigger('change');
            });
        }
        muatDataMaster();

        // --- MENGAMBIL & RENDER JADWAL ---
        function muatJadwal() {
            if (!db) {
                document.getElementById('tabelJadwal').innerHTML = `<tr><td colspan="5" class="text-center py-6 text-red-500 font-bold">‚ö†Ô∏è Gagal terhubung ke Database. Periksa file firebase-config.js Anda.</td></tr>`;
                return;
            }
            onSnapshot(collection(db, "jadwal_pelajaran"), (snapshot) => {
                semuaJadwal = [];
                snapshot.forEach(docSnap => {
                    semuaJadwal.push({ id: docSnap.id, ...docSnap.data() });
                });
                renderTabel();
            });
        }
        muatJadwal();

        const urutanHari = { "Senin":1, "Selasa":2, "Rabu":3, "Kamis":4, "Jumat":5, "Sabtu":6, "Minggu":7 };

        window.renderTabel = function() {
            const tabel = document.getElementById('tabelJadwal');
            const filter = document.getElementById('filterKelasTable').value;
            tabel.innerHTML = '';

            let data = filter === "Semua" ? semuaJadwal : semuaJadwal.filter(j => j.kelas === filter);
            
            data.sort((a, b) => {
                if (urutanHari[a.hari] !== urutanHari[b.hari]) return urutanHari[a.hari] - urutanHari[b.hari];
                
                // Sort Waktu berdasarkan angka jam
                let m1 = (a.waktu||"").match(/\d+/g); let m2 = (b.waktu||"").match(/\d+/g);
                let val1 = m1 ? parseInt(m1[0])*60 + (m1[1] ? parseInt(m1[1]) : 0) : 9999;
                let val2 = m2 ? parseInt(m2[0])*60 + (m2[1] ? parseInt(m2[1]) : 0) : 9999;
                if(val1 !== val2) return val1 - val2;
                return (a.waktu || "").localeCompare(b.waktu || "");
            });

            if (data.length === 0) {
                tabel.innerHTML = `<tr><td colspan="5" class="text-center py-6 text-gray-500">Belum ada data jadwal.</td></tr>`;
                return;
            }

            data.forEach(j => {
                let bgHari = "bg-gray-100";
                if(j.hari === "Senin") bgHari = "bg-red-100 text-red-700";
                else if(j.hari === "Selasa") bgHari = "bg-orange-100 text-orange-700";
                else if(j.hari === "Rabu") bgHari = "bg-yellow-100 text-yellow-700";
                else if(j.hari === "Kamis") bgHari = "bg-green-100 text-green-700";
                else if(j.hari === "Jumat") bgHari = "bg-blue-100 text-blue-700";
                else if(j.hari === "Sabtu") bgHari = "bg-purple-100 text-purple-700";

                tabel.insertAdjacentHTML('beforeend', `
                    <tr class="hover:bg-blue-50 transition border-b border-gray-50">
                        <td class="py-3 px-4"><span class="px-2 py-1 rounded text-xs font-bold ${bgHari}">${j.hari}</span></td>
                        <td class="py-3 px-4 font-medium text-gray-700">${j.waktu}</td>
                        <td class="py-3 px-4 font-bold text-blue-600">${j.kelas}</td>
                        <td class="py-3 px-4">
                            <div class="font-bold text-gray-800">${j.mapel}</div>
                            <div class="text-xs ${j.guru ? 'text-gray-500' : 'text-red-500 font-bold italic'}">üë®‚Äçüè´ ${j.guru || "Belum ada guru"}</div>
                        </td>
                        <td class="py-3 px-4 text-center">
                            <div class="flex items-center justify-center gap-2">
                                <button onclick="duplikatJadwal('${j.id}')" class="p-1.5 bg-indigo-100 text-indigo-700 hover:bg-indigo-200 rounded-lg transition" title="Salin / Duplikat Baris Ini">üìÑ</button>
                                <button onclick="editJadwal('${j.id}')" class="p-1.5 bg-yellow-100 text-yellow-700 hover:bg-yellow-200 rounded-lg transition" title="Edit">‚úèÔ∏è</button>
                                <button onclick="hapusJadwal('${j.id}')" class="p-1.5 bg-red-100 text-red-700 hover:bg-red-200 rounded-lg transition" title="Hapus">üóëÔ∏è</button>
                            </div>
                        </td>
                    </tr>
                `);
            });
        };

        // --- ANTI-BENTROK & SIMPAN ---
        window.simpanJadwal = async function(e) {
            e.preventDefault();
            if (!db) return alert("‚ùå Koneksi database tidak tersedia. Periksa firebase-config.js Anda.");
            
            const btnSimpan = document.getElementById('btnSimpan');
            btnSimpan.innerHTML = "‚è≥ Memproses..."; btnSimpan.disabled = true;

            const idEdit = document.getElementById('editId').value;
            const dataBaru = {
                hari: document.getElementById('inputHari').value,
                waktu: document.getElementById('inputWaktu').value,
                kelas: document.getElementById('inputKelas').value,
                mapel: document.getElementById('inputMapel').value,
                guru: document.getElementById('inputGuru').value
            };

            // Validasi Bentrok Kelas
            const cekBentrokKelas = semuaJadwal.find(j => j.hari === dataBaru.hari && j.waktu === dataBaru.waktu && j.kelas === dataBaru.kelas && j.id !== idEdit);
            if (cekBentrokKelas) {
                alert(`‚ùå BENTROK KELAS!\n\nKelas ${dataBaru.kelas} sudah ada pelajaran [${cekBentrokKelas.mapel}] di Hari ${dataBaru.hari} Jam ${dataBaru.waktu}.`);
                btnSimpan.innerHTML = "üíæ Simpan Jadwal"; btnSimpan.disabled = false; return;
            }

            // Validasi Bentrok Guru
            const cekBentrokGuru = semuaJadwal.find(j => j.hari === dataBaru.hari && j.waktu === dataBaru.waktu && j.guru === dataBaru.guru && j.id !== idEdit);
            if (cekBentrokGuru) {
                alert(`‚ùå BENTROK GURU!\n\nGuru ${dataBaru.guru} sudah mengajar di Kelas ${cekBentrokGuru.kelas} pada waktu tersebut.`);
                btnSimpan.innerHTML = "üíæ Simpan Jadwal"; btnSimpan.disabled = false; return;
            }

            try {
                if (idEdit) await updateDoc(doc(db, "jadwal_pelajaran", idEdit), dataBaru);
                else await addDoc(collection(db, "jadwal_pelajaran"), dataBaru);
                resetForm();
            } catch (error) { alert("‚ùå Gagal menyimpan."); }
            
            btnSimpan.innerHTML = "üíæ Simpan Jadwal"; btnSimpan.disabled = false;
        };

        // --- FITUR SALIN BARIS (DUPLIKAT) ---
        window.duplikatJadwal = function(id) {
            const data = semuaJadwal.find(j => j.id === id);
            if(data) {
                // Isi form tapi JANGAN isi editId (agar tersimpan sebagai data baru)
                document.getElementById('editId').value = "";
                $('#inputHari').val(data.hari).trigger('change');
                $('#inputWaktu').val(data.waktu).trigger('change');
                $('#inputKelas').val(data.kelas).trigger('change');
                $('#inputMapel').val(data.mapel).trigger('change');
                $('#inputGuru').val(data.guru).trigger('change');
                
                document.getElementById('judulForm').innerHTML = "üìÑ Duplikat Jadwal (Simpan sbg Baru)";
                document.getElementById('btnSimpan').innerHTML = "üíæ Simpan Salinan";
                document.getElementById('btnBatal').classList.remove('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        };

        window.editJadwal = function(id) {
            const data = semuaJadwal.find(j => j.id === id);
            if(data) {
                document.getElementById('editId').value = data.id;
                $('#inputHari').val(data.hari).trigger('change');
                $('#inputWaktu').val(data.waktu).trigger('change');
                $('#inputKelas').val(data.kelas).trigger('change');
                $('#inputMapel').val(data.mapel).trigger('change');
                $('#inputGuru').val(data.guru).trigger('change');
                
                document.getElementById('judulForm').innerHTML = "‚úèÔ∏è Edit Jadwal";
                document.getElementById('btnSimpan').innerHTML = "üíæ Update Jadwal";
                document.getElementById('btnBatal').classList.remove('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        };

        window.hapusJadwal = async function(id) {
            if (!db) return alert("‚ùå Koneksi database tidak tersedia.");
            if(confirm("‚ö†Ô∏è Yakin hapus baris jadwal ini?")) await deleteDoc(doc(db, "jadwal_pelajaran", id));
        };

        window.hapusJadwalPerKelas = async function() {
            const kelas = document.getElementById('filterKelasTable').value;
            if (kelas === "Semua") return alert("‚ùå Silakan filter tabel ke SATU KELAS terlebih dahulu (dropdown di atas tabel) untuk menghapus seluruh jadwal kelas tersebut.");
            
            if (!confirm(`‚ö†Ô∏è PERINGATAN!\n\nAnda yakin ingin menghapus SELURUH jadwal untuk KELAS ${kelas}?\nData yang dihapus tidak dapat dikembalikan.`)) return;

            const dataHapus = semuaJadwal.filter(j => j.kelas === kelas);
            if(dataHapus.length === 0) return alert(`Tidak ada jadwal di kelas ${kelas}.`);

            let terhapus = 0;
            for(const j of dataHapus) {
                try {
                    await deleteDoc(doc(db, "jadwal_pelajaran", j.id));
                    terhapus++;
                } catch(e) { console.error("Gagal hapus", e); }
            }
            alert(`‚úÖ Berhasil menghapus ${terhapus} jadwal di Kelas ${kelas}.`);
        };

        window.hapusSemuaJadwal = async function() {
            if (!confirm(`üö® AWAS! TINDAKAN BERBAHAYA!\n\nAnda akan menghapus SEMUA JADWAL DARI SELURUH KELAS! Apakah Anda 100% yakin?`)) return;
            const ketik = prompt("Untuk melanjutkan, ketik kata 'HAPUS' di bawah ini (huruf besar semua):");
            if (ketik !== "HAPUS") return alert("‚ùå Aksi dibatalkan. Kata kunci tidak cocok.");

            let terhapus = 0;
            for(const j of semuaJadwal) {
                try {
                    await deleteDoc(doc(db, "jadwal_pelajaran", j.id));
                    terhapus++;
                } catch(e) { console.error("Gagal hapus", e); }
            }
            alert(`‚úÖ SELURUH JADWAL BERHASIL DIKOSONGKAN. Total ${terhapus} baris data dihapus.`);
        };

        window.resetForm = function() {
            document.getElementById('formJadwal').reset();
            document.getElementById('editId').value = "";
            $('#inputHari').val('').trigger('change'); $('#inputWaktu').val('').trigger('change');
            $('#inputKelas').val('').trigger('change'); $('#inputMapel').val('').trigger('change'); $('#inputGuru').val('').trigger('change');
            
            document.getElementById('judulForm').innerHTML = "<span>‚ûï</span> Tambah Jadwal Baru";
            document.getElementById('btnSimpan').innerHTML = "üíæ Simpan Jadwal";
            document.getElementById('btnBatal').classList.add('hidden');
        };

        // --- FITUR SALIN JADWAL ANTAR KELAS ---
        window.bukaModalSalinKelas = function() { 
            document.getElementById('modalSalin').classList.remove('hidden'); 
            
            // Otomatis pilih kelas asal berdasarkan filter tabel jika tidak sedang di posisi "Semua"
            const filterSaatIni = document.getElementById('filterKelasTable').value;
            if(filterSaatIni !== "Semua") {
                document.getElementById('salinDariKelas').value = filterSaatIni;
            } else {
                document.getElementById('salinDariKelas').value = "";
            }
            document.getElementById('salinKeKelas').value = "";
        };
        window.tutupModalSalinKelas = function() { document.getElementById('modalSalin').classList.add('hidden'); };

        window.prosesSalinKelas = async function() {
            const dariKelas = document.getElementById('salinDariKelas').value;
            const keKelas = document.getElementById('salinKeKelas').value;

            if(!dariKelas || !keKelas) return alert("‚ùå Silakan pilih kelas asal dan kelas tujuan!");
            if(dariKelas === keKelas) return alert("‚ùå Kelas asal dan tujuan tidak boleh sama!");

            const jadwalAsal = semuaJadwal.filter(j => j.kelas === dariKelas);
            if(jadwalAsal.length === 0) return alert(`‚ùå Kelas ${dariKelas} tidak memiliki jadwal untuk disalin.`);

            const btn = document.getElementById('btnProsesSalin');
            btn.innerHTML = "‚è≥ Memproses..."; btn.disabled = true;

            let berhasil = 0;
            let bentrok = 0;

            for (const j of jadwalAsal) {
                // Cek apakah di kelas tujuan sudah ada jadwal di hari dan jam yang sama agar tidak menumpuk/bentrok
                const cekBentrok = semuaJadwal.find(tj => tj.kelas === keKelas && tj.hari === j.hari && tj.waktu === j.waktu);
                if (cekBentrok) {
                    bentrok++;
                    continue; // Lewati jadwal yang hari/jam-nya sudah terisi di kelas tujuan
                }

                try {
                    await addDoc(collection(db, "jadwal_pelajaran"), {
                        hari: j.hari,
                        waktu: j.waktu,
                        kelas: keKelas,
                        mapel: j.mapel,
                        guru: "" // Nama guru sengaja dikosongkan
                    });
                    berhasil++;
                } catch(e) { console.error("Gagal menyalin", e); }
            }

            tutupModalSalinKelas();
            alert(`‚úÖ Proses salin jadwal selesai!\n\nBerhasil disalin: ${berhasil} mata pelajaran\nDilewati (jam bentrok): ${bentrok} jadwal`);
            btn.innerHTML = "<span>üìã</span> Proses Salin"; btn.disabled = false;
        };

        // --- FITUR TERAPKAN GURU MASSAL ---
        window.bukaModalTerapkanGuru = function() {
            document.getElementById('modalTerapkanGuru').classList.remove('hidden');
            const filterSaatIni = document.getElementById('filterKelasTable').value;
            if(filterSaatIni !== "Semua") {
                document.getElementById('terapkanKelas').value = filterSaatIni;
            } else {
                document.getElementById('terapkanKelas').value = "";
            }
        };
        
        window.tutupModalTerapkanGuru = function() { document.getElementById('modalTerapkanGuru').classList.add('hidden'); };

        window.prosesTerapkanGuru = async function() {
            const kls = document.getElementById('terapkanKelas').value;
            const gr = document.getElementById('terapkanGuru').value;

            if(!kls || !gr) return alert("‚ùå Harap pilih Kelas dan Guru!");

            const jadwalTarget = semuaJadwal.filter(j => j.kelas === kls);
            if(jadwalTarget.length === 0) return alert(`‚ùå Tidak ada jadwal di kelas ${kls}.`);

            const btn = document.getElementById('btnProsesTerapkan');
            btn.innerHTML = "‚è≥ Memproses..."; btn.disabled = true;

            let berhasil = 0;
            let dilewati = 0;

            for(const j of jadwalTarget) {
                try {
                    // Pengecekan agar guru tidak bentrok mengajar di kelas lain pada hari & jam yang sama
                    const cekBentrok = semuaJadwal.find(tj => tj.hari === j.hari && tj.waktu === j.waktu && tj.guru === gr && tj.id !== j.id);
                    if(cekBentrok) {
                        dilewati++;
                        continue; // Jika guru sudah mengajar di kelas lain di jam yang sama, maka abaikan jadwal ini
                    }
                    await updateDoc(doc(db, "jadwal_pelajaran", j.id), { guru: gr });
                    berhasil++;
                } catch(e) { console.error("Gagal terapkan guru", e); }
            }

            tutupModalTerapkanGuru();
            alert(`‚úÖ Selesai!\n\nBerhasil diterapkan: ${berhasil} jadwal\nDilewati (karena bentrok jam dengan kelas lain): ${dilewati} jadwal`);
            btn.innerHTML = "<span>‚úÖ</span> Terapkan"; btn.disabled = false;
        };

        // --- FITUR DOWNLOAD EXCEL DENGAN MODAL (BERWARNA) ---
        window.bukaModalExcel = function() { document.getElementById('modalExcel').classList.remove('hidden'); }
        window.tutupModalExcel = function() { document.getElementById('modalExcel').classList.add('hidden'); }
        
        window.prosesDownloadExcel = function() {
            const filterKelas = document.getElementById('filterKelasTable').value;
            let data = filterKelas === "Semua" ? semuaJadwal : semuaJadwal.filter(j => j.kelas === filterKelas);
            if(data.length === 0) return alert("Data kosong, tidak ada yang bisa diunduh.");

            const kop1 = document.getElementById('exKop1').value;
            const kop2 = document.getElementById('exKop2').value;
            const kepsek = document.getElementById('exKepsek').value || ".....................";
            const nipKepsek = document.getElementById('exNipKepsek').value || ".....................";
            const wali = document.getElementById('exWali').value || ".....................";
            const nipWali = document.getElementById('exNipWali').value || ".....................";
            const tanggal = document.getElementById('exTanggal').value || ".....................";

            // Mengurutkan data
            data.sort((a,b) => {
                if (urutanHari[a.hari] !== urutanHari[b.hari]) return urutanHari[a.hari] - urutanHari[b.hari];
                let m1 = (a.waktu||"").match(/\d+/g); let m2 = (b.waktu||"").match(/\d+/g);
                let val1 = m1 ? parseInt(m1[0])*60 + (m1[1] ? parseInt(m1[1]) : 0) : 9999;
                let val2 = m2 ? parseInt(m2[0])*60 + (m2[1] ? parseInt(m2[1]) : 0) : 9999;
                return val1 - val2;
            });

            // Membuat Palette Warna Cerah untuk Membedakan Guru
            const warnaCerah = [
                "#FFB3BA", "#FFDFBA", "#FFFFBA", "#BAFFC9", "#BAE1FF", 
                "#E8BAFF", "#FFB3E6", "#C4FAF8", "#E2F0CB", "#FFC4C4", 
                "#FFDEAA", "#E0BBE4", "#957DAD", "#D291BC", "#FEC8D8", "#FDEB71"
            ];
            let mapWarnaGuru = {};
            let indexWarna = 0;
            
            // Assign warna unik per guru yang ada di data
            data.forEach(j => {
                if (j.guru && !mapWarnaGuru[j.guru]) {
                    mapWarnaGuru[j.guru] = warnaCerah[indexWarna % warnaCerah.length];
                    indexWarna++;
                }
            });

            // Mencegah kata "Kelas" dicetak ganda (Mengecek apakah nama kelas sudah mengandung kata "kelas")
            let judulKelas = filterKelas === 'Semua' ? 'SEKOLAH' : (filterKelas.toLowerCase().includes('kelas') ? filterKelas.toUpperCase() : 'KELAS ' + filterKelas.toUpperCase());

            // Membuat tabel HTML untuk dikonversi ke Excel dengan pengaturan warna (Inline CSS)
            let tabelHTML = `
            <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
            <head><meta charset="utf-8"></head>
            <body>
                <table style="width: 100%; font-family: Arial, sans-serif; border-collapse: collapse;">
                    <tr><td colspan="6" style="text-align: center; font-size: 14pt; font-weight: bold;">${kop1}</td></tr>
                    <tr><td colspan="6" style="text-align: center; font-size: 16pt; font-weight: bold;">${kop2}</td></tr>
                    <tr><td colspan="6" style="text-align: center; font-size: 12pt; font-weight: bold; padding-bottom: 20px;">JADWAL PELAJARAN ${judulKelas}</td></tr>
                    <tr><td colspan="6"></td></tr>
                    
                    <tr>
                        <th style="border: 1px solid black; background-color: #d1d5db; padding: 8px;">No</th>
                        <th style="border: 1px solid black; background-color: #d1d5db; padding: 8px;">Hari</th>
                        <th style="border: 1px solid black; background-color: #d1d5db; padding: 8px;">Waktu</th>
                        <th style="border: 1px solid black; background-color: #d1d5db; padding: 8px;">Kelas</th>
                        <th style="border: 1px solid black; background-color: #d1d5db; padding: 8px;">Mata Pelajaran</th>
                        <th style="border: 1px solid black; background-color: #d1d5db; padding: 8px;">Guru Pengajar</th>
                    </tr>
            `;

            let no = 1;
            data.forEach(j => {
                // Memberikan warna background berdasarkan nama guru, biarkan putih jika belum ada guru
                let bgWarna = j.guru ? mapWarnaGuru[j.guru] : "#ffffff";

                tabelHTML += `
                    <tr>
                        <td style="border: 1px solid black; text-align: center; background-color: ${bgWarna};">${no++}</td>
                        <td style="border: 1px solid black; text-align: center; font-weight: bold; background-color: ${bgWarna};">${j.hari}</td>
                        <td style="border: 1px solid black; text-align: center; background-color: ${bgWarna};">${j.waktu}</td>
                        <td style="border: 1px solid black; text-align: center; background-color: ${bgWarna};">${j.kelas}</td>
                        <td style="border: 1px solid black; background-color: ${bgWarna};">${j.mapel}</td>
                        <td style="border: 1px solid black; background-color: ${bgWarna};">${j.guru}</td>
                    </tr>
                `;
            });

            // Bagian Tanda Tangan (Footer)
            tabelHTML += `
                    <tr><td colspan="6"></td></tr>
                    <tr><td colspan="6"></td></tr>
                    <tr>
                        <td colspan="2" style="text-align: center;">Mengetahui,</td>
                        <td colspan="2"></td>
                        <td colspan="2" style="text-align: center;">${tanggal}</td>
                    </tr>
                    <tr>
                        <td colspan="2" style="text-align: center;">Kepala Sekolah</td>
                        <td colspan="2"></td>
                        <td colspan="2" style="text-align: center;">Wali Kelas / Guru</td>
                    </tr>
                    <tr><td colspan="6"></td></tr>
                    <tr><td colspan="6"></td></tr>
                    <tr><td colspan="6"></td></tr>
                    <tr>
                        <td colspan="2" style="text-align: center; font-weight: bold; text-decoration: underline;">${kepsek}</td>
                        <td colspan="2"></td>
                        <td colspan="2" style="text-align: center; font-weight: bold; text-decoration: underline;">${wali}</td>
                    </tr>
                    <tr>
                        <td colspan="2" style="text-align: center;">NIP. ${nipKepsek}</td>
                        <td colspan="2"></td>
                        <td colspan="2" style="text-align: center;">NIP. ${nipWali}</td>
                    </tr>
                </table>
            </body>
            </html>
            `;

            // Proses Download File Excel (.xls)
            let blob = new Blob([tabelHTML], { type: 'application/vnd.ms-excel' });
            let link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `Jadwal_Pelajaran_${filterKelas}.xls`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            tutupModalExcel();
        };

    </script>
</body>
</html>
