<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Input Jadwal SD - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8 font-sans text-gray-800">

    <div class="max-w-lg mx-auto mb-4 flex justify-between gap-2">
        <a href="index.html" class="flex-1 text-center bg-gray-200 text-gray-700 hover:bg-gray-300 font-semibold py-2 px-3 rounded-lg transition text-xs md:text-sm">
            üè† Halaman Depan
        </a>
        <a href="kelola_data.html" class="flex-1 text-center bg-indigo-100 text-indigo-700 hover:bg-indigo-200 font-semibold py-2 px-3 rounded-lg transition text-xs md:text-sm">
            ‚öôÔ∏è Kelola Data Master
        </a>
    </div>

    <div class="max-w-lg mx-auto bg-white rounded-xl shadow-md overflow-hidden p-6 md:p-8">
        <h2 class="text-xl md:text-2xl font-bold text-center text-blue-600 mb-6">Susun Jadwal Pelajaran (Admin)</h2>
        <div id="pesanBox" class="hidden p-4 mb-6 rounded-lg font-medium text-sm"></div>

        <form id="formJadwal" class="space-y-4 text-sm md:text-base">
            <div>
                <label class="block font-semibold mb-1">Hari</label>
                <select id="hari" required class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- Pilih Hari --</option>
                    <option value="Senin">Senin</option>
                    <option value="Selasa">Selasa</option>
                    <option value="Rabu">Rabu</option>
                    <option value="Kamis">Kamis</option>
                    <option value="Jumat">Jumat</option>
                    <option value="Sabtu">Sabtu</option>
                </select>
            </div>
            <div>
                <label class="block font-semibold mb-1">Jam Ke-</label>
                <select id="jam_ke" required class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- Memuat Jam... --</option>
                </select>
            </div>
            <div>
                <label class="block font-semibold mb-1">Kelas</label>
                <select id="kelas" required class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- Memuat Kelas... --</option>
                </select>
            </div>
            <div>
                <label class="block font-semibold mb-1">Mata Pelajaran</label>
                <select id="mapel" required class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- Memuat Mapel... --</option>
                </select>
            </div>
            <div>
                <label class="block font-semibold mb-1">Guru Pengajar</label>
                <select id="guru" required class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- Memuat Guru... --</option>
                </select>
            </div>

            <!-- FITUR BARU: Checkbox Izinkan Co-Teaching -->
            <div class="mt-2 bg-yellow-50 border border-yellow-200 p-3 rounded-lg flex items-start gap-2 shadow-inner">
                <input type="checkbox" id="coTeaching" class="mt-1 w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500">
                <label for="coTeaching" class="text-xs md:text-sm text-yellow-800 font-medium leading-tight">
                    <b>Izinkan Guru Pendamping</b><br>Centang jika kelas ini diisi oleh 2 guru pada jam yang sama (mengabaikan peringatan bentrok kelas).
                </label>
            </div>

            <button type="submit" id="btnSubmit" class="w-full mt-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded transition duration-200 shadow-md">
                Simpan Jadwal
            </button>
        </form>
    </div>

    <!-- TABEL ADMIN -->
    <div class="max-w-4xl mx-auto mt-8 mb-10 bg-white rounded-xl shadow-md overflow-hidden p-4 md:p-8 text-sm md:text-base">
        <h2 class="text-lg md:text-xl font-bold text-gray-700 mb-4 border-b pb-2">Daftar Jadwal Tersimpan</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white text-xs md:text-sm">
                <thead class="bg-gray-100 text-gray-600">
                    <tr>
                        <th class="py-2 px-3 md:px-4 text-left font-semibold">Hari</th>
                        <th class="py-2 px-3 md:px-4 text-left font-semibold">Jam</th>
                        <th class="py-2 px-3 md:px-4 text-left font-semibold">Kelas</th>
                        <th class="py-2 px-3 md:px-4 text-left font-semibold">Mapel</th>
                        <th class="py-2 px-3 md:px-4 text-left font-semibold">Guru</th>
                        <th class="py-2 px-3 md:px-4 text-center font-semibold">Aksi</th>
                    </tr>
                </thead>
                <tbody id="tabelAdminJadwal" class="divide-y divide-gray-200">
                    <tr><td colspan="6" class="py-4 text-center text-gray-500">Memuat data...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, onSnapshot, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // ==========================================
        // MASUKKAN FIREBASE CONFIG ANDA DI SINI
        // ==========================================
        const firebaseConfig = {
             apiKey: "AIzaSyAu8st2VRsNFyzC8UR8TDq8821y4_TVHVk",
  authDomain: "roster-sekolah-sd.firebaseapp.com",
  projectId: "roster-sekolah-sd",
  storageBucket: "roster-sekolah-sd.firebasestorage.app",
  messagingSenderId: "819380185646",
  appId: "1:819380185646:web:39ae854591ca40f0498dbf"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Sorting Natural untuk dropdown agar Jam 1, Jam 2, Jam 10 berurutan benar
        function muatDropdownMaster(koleksi, idDropdown, teksDefault) {
            const elemen = document.getElementById(idDropdown);
            if (firebaseConfig.apiKey === "API_KEY_ANDA") {
                elemen.innerHTML = `<option value="">-- Menunggu Firebase --</option>`;
                return;
            }
            onSnapshot(collection(db, koleksi), (snapshot) => {
                const nilaiTerpilih = elemen.value; // Simpan nilai yang sedang dipilih
                elemen.innerHTML = `<option value="">-- ${teksDefault} --</option>`;
                let arrData = [];
                snapshot.forEach((doc) => arrData.push(doc.data()));
                
                arrData.sort((a, b) => a.nama.localeCompare(b.nama, undefined, {numeric: true, sensitivity: 'base'}));
                
                arrData.forEach((data) => {
                    const selected = (data.nama === nilaiTerpilih) ? "selected" : "";
                    elemen.insertAdjacentHTML('beforeend', `<option value="${data.nama}" ${selected}>${data.nama}</option>`);
                });
            });
        }

        muatDropdownMaster("master_jam", "jam_ke", "Pilih Jam");
        muatDropdownMaster("master_kelas", "kelas", "Pilih Kelas");
        muatDropdownMaster("master_mapel", "mapel", "Pilih Mapel");
        muatDropdownMaster("master_guru", "guru", "Pilih Guru");

        const pesanBox = document.getElementById('pesanBox');
        function tampilkanPesan(pesan, tipe) {
            pesanBox.innerHTML = pesan;
            pesanBox.className = `p-4 mb-6 rounded-lg font-medium text-sm block ${tipe === 'sukses' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
            pesanBox.classList.remove('hidden');
            if(tipe === 'sukses') {
                setTimeout(() => { pesanBox.classList.add('hidden'); }, 4000);
            }
        }

        const tabelAdminJadwal = document.getElementById('tabelAdminJadwal');

        function muatTabelJadwal() {
            if (firebaseConfig.apiKey === "API_KEY_ANDA") return;
            
            onSnapshot(collection(db, "jadwal_pelajaran"), (snapshot) => {
                tabelAdminJadwal.innerHTML = "";
                if (snapshot.empty) {
                    tabelAdminJadwal.innerHTML = `<tr><td colspan="6" class="py-4 text-center text-gray-500 italic">Belum ada jadwal.</td></tr>`;
                    return;
                }

                let jadwalArr = [];
                snapshot.forEach(docSnap => jadwalArr.push({ id: docSnap.id, ...docSnap.data() }));

                const urutanHari = { "Senin":1, "Selasa":2, "Rabu":3, "Kamis":4, "Jumat":5, "Sabtu":6, "Minggu":7 };
                jadwalArr.sort((a, b) => {
                     return (urutanHari[a.hari] || 99) - (urutanHari[b.hari] || 99) || 
                            a.jam_ke.localeCompare(b.jam_ke, undefined, {numeric: true});
                });

                jadwalArr.forEach(jadwal => {
                    tabelAdminJadwal.insertAdjacentHTML('beforeend', `
                        <tr class="hover:bg-gray-50 transition border-b border-gray-100">
                            <td class="py-2 px-3 md:px-4 text-gray-700">${jadwal.hari}</td>
                            <td class="py-2 px-3 md:px-4 text-gray-700">${jadwal.jam_ke}</td>
                            <td class="py-2 px-3 md:px-4 font-bold text-indigo-700">${jadwal.kelas}</td>
                            <td class="py-2 px-3 md:px-4 text-gray-700">${jadwal.mapel}</td>
                            <td class="py-2 px-3 md:px-4 text-gray-700">${jadwal.guru}</td>
                            <td class="py-2 px-3 md:px-4 text-center">
                                <button onclick="hapusJadwal('${jadwal.id}')" class="bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-1 px-2 rounded shadow-sm transition">Hapus</button>
                            </td>
                        </tr>
                    `);
                });
            });
        }

        window.hapusJadwal = async function(idDokumen) {
            if(confirm("Hapus jadwal ini?")) {
                await deleteDoc(doc(db, "jadwal_pelajaran", idDokumen));
            }
        };

        muatTabelJadwal();

        const form = document.getElementById('formJadwal');
        const btnSubmit = document.getElementById('btnSubmit');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            btnSubmit.innerHTML = "Menyimpan...";
            btnSubmit.disabled = true;

            const hari = document.getElementById('hari').value;
            const jam_ke = document.getElementById('jam_ke').value;
            const kelas = document.getElementById('kelas').value;
            const mapel = document.getElementById('mapel').value;
            const guru = document.getElementById('guru').value;
            const isCoTeaching = document.getElementById('coTeaching').checked;

            try {
                const jadwalRef = collection(db, "jadwal_pelajaran");

                // 1. Cek apakah GURU yang sama sudah mengajar di jam ini
                const qGuru = query(jadwalRef, where("hari", "==", hari), where("jam_ke", "==", jam_ke), where("guru", "==", guru));
                if (!(await getDocs(qGuru)).empty) {
                    tampilkanPesan(`‚ùå <b>Gagal!</b> ${guru} sudah ada jadwal mengajar di jam ini.`, 'error');
                } else {
                    
                    // 2. Cek apakah KELAS sudah terisi
                    const qKelas = query(jadwalRef, where("hari", "==", hari), where("jam_ke", "==", jam_ke), where("kelas", "==", kelas));
                    const kelasDocs = await getDocs(qKelas);

                    // Jika kelas sudah terisi DAN checkbox co-teaching TIDAK dicentang, maka blokir
                    if (!kelasDocs.empty && !isCoTeaching) {
                        tampilkanPesan(`‚ùå <b>Gagal!</b> Kelas ${kelas} sudah terisi di jam ini.<br><span class="text-sm">Centang <b>"Izinkan Guru Pendamping"</b> jika memang diajar oleh 2 guru.</span>`, 'error');
                    } else {
                        // Jika lolos semua validasi, Simpan data
                        await addDoc(jadwalRef, { hari, jam_ke, kelas, mapel, guru });
                        tampilkanPesan("‚úÖ <b>Sukses!</b> Jadwal tersimpan.", 'sukses');
                        
                        document.getElementById('coTeaching').checked = false; 
                        document.getElementById('guru').focus(); 
                    }
                }
            } catch (error) {
                tampilkanPesan("‚ùå Terjadi kesalahan sistem.", 'error');
            }
            btnSubmit.innerHTML = "Simpan Jadwal";
            btnSubmit.disabled = false;
        });
    </script>
</body>
</html>
