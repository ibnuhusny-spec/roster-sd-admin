<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Input Jadwal</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 min-h-screen font-sans">
    
    <!-- Header Admin -->
    <header class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white shadow-lg py-6 px-4 md:px-8 mb-8">
        <div class="max-w-6xl mx-auto flex flex-col md:flex-row items-center justify-between">
            <div class="flex items-center gap-4">
                <a href="index.html" class="flex items-center gap-2 bg-white/20 hover:bg-white/30 py-2 px-4 rounded-xl transition cursor-pointer text-white font-bold text-sm shadow-sm">
                    <span>üè†</span> Beranda
                </a>
                <div>
                    <h1 class="text-2xl font-extrabold tracking-wide">Panel Admin Jadwal</h1>
                    <p class="text-blue-200 text-sm font-medium">Mode Pengelolaan Data</p>
                </div>
            </div>
            <div class="mt-4 md:mt-0 flex gap-2">
                <a href="kelola_data.html" class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded-xl shadow-md transition duration-200 flex items-center gap-2 text-sm md:text-base">
                    <span>‚öôÔ∏è</span> Kelola Data Master
                </a>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 md:px-8 mb-12">
        
        <!-- FORM INPUT JADWAL -->
        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-md border border-gray-100 mb-8">
            <h2 class="text-xl font-extrabold text-gray-800 mb-6 flex items-center gap-2">
                <span>‚ûï</span> Tambah Jadwal Pelajaran Baru
            </h2>
            
            <form id="formJadwal" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-5 items-end">
                <!-- HARI -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Pilih Hari</label>
                    <select id="inputHari" required class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 bg-gray-50 font-medium">
                        <option value="" disabled selected>-- Hari --</option>
                        <option value="Senin">Senin</option><option value="Selasa">Selasa</option>
                        <option value="Rabu">Rabu</option><option value="Kamis">Kamis</option>
                        <option value="Jumat">Jumat</option><option value="Sabtu">Sabtu</option>
                    </select>
                </div>

                <!-- WAKTU (Dropdown dari Data Master) -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Pilih Waktu</label>
                    <select id="inputWaktu" required class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 bg-gray-50 font-medium">
                        <option value="" disabled selected>-- Memuat... --</option>
                    </select>
                </div>

                <!-- KELAS -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Pilih Kelas</label>
                    <select id="inputKelas" required class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 bg-gray-50 font-medium">
                        <option value="" disabled selected>-- Memuat... --</option>
                    </select>
                </div>

                <!-- MAPEL -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Mata Pelajaran</label>
                    <input type="text" id="inputMapel" required placeholder="Nama Mapel" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 bg-gray-50 font-medium">
                </div>

                <!-- GURU -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Guru Pengajar</label>
                    <select id="inputGuru" required class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 bg-gray-50 font-medium">
                        <option value="" disabled selected>-- Memuat... --</option>
                    </select>
                </div>

                <!-- TOMBOL SIMPAN -->
                <div class="lg:col-span-5 flex justify-end mt-4">
                    <button type="submit" id="btnSimpan" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-xl shadow-md transition duration-200">
                        üíæ Simpan Jadwal
                    </button>
                </div>
            </form>
        </div>

        <!-- TABEL JADWAL TERDAFTAR (UNTUK MENGHAPUS JADWAL) -->
        <div class="bg-white rounded-2xl shadow-md overflow-hidden border border-gray-200">
            <div class="p-6 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-lg font-extrabold text-gray-800">Daftar Jadwal Saat Ini</h2>
                <button onclick="muatTabelJadwal()" class="text-sm bg-white border border-gray-300 hover:bg-gray-100 px-4 py-2 rounded-lg font-bold text-gray-700 transition">üîÑ Refresh</button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full text-left border-collapse">
                    <thead class="bg-blue-600 text-white">
                        <tr>
                            <th class="py-4 px-4 uppercase font-bold text-xs tracking-wider">Hari</th>
                            <th class="py-4 px-4 uppercase font-bold text-xs tracking-wider">Waktu</th>
                            <th class="py-4 px-4 uppercase font-bold text-xs tracking-wider">Kelas</th>
                            <th class="py-4 px-4 uppercase font-bold text-xs tracking-wider">Mata Pelajaran</th>
                            <th class="py-4 px-4 uppercase font-bold text-xs tracking-wider">Guru Pengajar</th>
                            <th class="py-4 px-4 uppercase font-bold text-xs tracking-wider text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyJadwal" class="divide-y divide-gray-200">
                        <tr><td colspan="6" class="py-8 text-center text-gray-500">Memuat data jadwal...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- SCRIPT FIREBASE & LOGIKA ADMIN -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // Konfigurasi Firebase
        let firebaseConfig = { apiKey: "API_KEY_ANDA", projectId: "PROJECT_ID" };
        try {
            const module = await import("./firebase-config.js");
            if (module && module.firebaseConfig) firebaseConfig = module.firebaseConfig;
        } catch (error) { console.warn("Menjalankan mode lokal."); }

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Muat Data Dropdown Kelas dan Guru
        async function muatDropdown() {
            if (firebaseConfig.apiKey === "API_KEY_ANDA") return;
            try {
                // Dropdown Kelas
                const selectKelas = document.getElementById('inputKelas');
                const kelasSnap = await getDocs(collection(db, "master_kelas"));
                selectKelas.innerHTML = '<option value="" disabled selected>-- Pilih Kelas --</option>';
                kelasSnap.forEach(k => selectKelas.insertAdjacentHTML('beforeend', `<option value="${k.data().nama}">${k.data().nama}</option>`));

                // Dropdown Waktu
                const selectWaktu = document.getElementById('inputWaktu');
                const waktuSnap = await getDocs(collection(db, "master_waktu"));
                selectWaktu.innerHTML = '<option value="" disabled selected>-- Pilih Waktu --</option>';
                waktuSnap.forEach(w => {
                    // Cek apakah datanya tersimpan di field "waktu" atau "nama" pada kelola_data Anda
                    const nilaiWaktu = w.data().waktu || w.data().nama || "-";
                    selectWaktu.insertAdjacentHTML('beforeend', `<option value="${nilaiWaktu}">${nilaiWaktu}</option>`);
                });

                // Dropdown Guru
                const selectGuru = document.getElementById('inputGuru');
                const guruSnap = await getDocs(collection(db, "master_guru"));
                selectGuru.innerHTML = '<option value="" disabled selected>-- Pilih Guru --</option>';
                guruSnap.forEach(g => selectGuru.insertAdjacentHTML('beforeend', `<option value="${g.data().nama}">${g.data().nama}</option>`));
            } catch (error) {
                console.error("Gagal memuat dropdown:", error);
            }
        }
        muatDropdown();

        // Menyimpan Jadwal Baru tanpa "Jam Ke"
        document.getElementById('formJadwal').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (firebaseConfig.apiKey === "API_KEY_ANDA") {
                alert("Harap hubungkan Firebase Anda terlebih dahulu di file firebase-config.js!");
                return;
            }

            const btn = document.getElementById('btnSimpan');
            const oldText = btn.innerHTML;
            btn.innerHTML = "‚è≥ Menyimpan..."; btn.disabled = true;

            try {
                await addDoc(collection(db, "jadwal_pelajaran"), {
                    hari: document.getElementById('inputHari').value,
                    waktu: document.getElementById('inputWaktu').value, 
                    kelas: document.getElementById('inputKelas').value,
                    mapel: document.getElementById('inputMapel').value,
                    guru: document.getElementById('inputGuru').value
                });
                
                e.target.reset(); // Kosongkan form setelah sukses menyimpan
                muatTabelJadwal(); // Refresh tabel di bawahnya
            } catch (error) {
                console.error("Error:", error);
                alert("Gagal menyimpan jadwal! Periksa koneksi internet Anda.");
            }

            btn.innerHTML = oldText; btn.disabled = false;
        });

        // Memuat dan Mengurutkan Tabel Jadwal Admin
        window.muatTabelJadwal = async function() {
            if (firebaseConfig.apiKey === "API_KEY_ANDA") return;
            
            const tbody = document.getElementById('tbodyJadwal');
            tbody.innerHTML = '<tr><td colspan="6" class="py-8 text-center text-gray-500">Memuat data...</td></tr>';
            
            try {
                const snap = await getDocs(collection(db, "jadwal_pelajaran"));
                let jadwalList = [];
                snap.forEach(doc => jadwalList.push({ id: doc.id, ...doc.data() }));

                if (jadwalList.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="py-8 text-center text-gray-500 font-bold">Belum ada data jadwal.</td></tr>';
                    return;
                }

                // Logika Pengurutan Tanpa Jam Ke- (Sama seperti di halaman publik)
                function getMenit(teks) {
                    const match = String(teks || "").match(/(\d{1,2})[:.](\d{2})/);
                    return match ? (parseInt(match[1], 10) * 60) + parseInt(match[2], 10) : 999999;
                }

                jadwalList.sort((a, b) => {
                    const urutanHari = { "Senin":1, "Selasa":2, "Rabu":3, "Kamis":4, "Jumat":5, "Sabtu":6, "Minggu":7 };
                    const hariA = urutanHari[a.hari] || 99;
                    const hariB = urutanHari[b.hari] || 99;
                    if (hariA !== hariB) return hariA - hariB;

                    const menitA = getMenit(a.waktu);
                    const menitB = getMenit(b.waktu);
                    if (menitA !== menitB) return menitA - menitB;

                    return String(a.kelas || "").localeCompare(String(b.kelas || ""));
                });

                tbody.innerHTML = '';
                jadwalList.forEach(j => {
                    tbody.insertAdjacentHTML('beforeend', `
                        <tr class="border-b border-gray-100 hover:bg-blue-50 transition">
                            <td class="py-3 px-4 font-bold text-gray-800">${j.hari}</td>
                            <td class="py-3 px-4">
                                <span class="font-bold text-blue-800 bg-blue-100 px-3 py-1 rounded-lg border border-blue-200 text-sm">${j.waktu || '-'}</span>
                            </td>
                            <td class="py-3 px-4">
                                <span class="bg-green-100 text-green-800 px-3 py-1 rounded-lg font-extrabold text-sm border border-green-200">${j.kelas}</span>
                            </td>
                            <td class="py-3 px-4 text-indigo-700 font-bold">${j.mapel}</td>
                            <td class="py-3 px-4 text-gray-700 font-medium">${j.guru}</td>
                            <td class="py-3 px-4 text-center">
                                <button onclick="hapusJadwal('${j.id}')" class="bg-red-500 hover:bg-red-600 text-white px-4 py-1.5 rounded-lg shadow-sm font-bold text-sm transition">üóëÔ∏è Hapus</button>
                            </td>
                        </tr>
                    `);
                });

            } catch (error) {
                console.error("Error:", error);
                tbody.innerHTML = '<tr><td colspan="6" class="py-8 text-center text-red-500 font-bold">Gagal memuat jadwal.</td></tr>';
            }
        };

        // Fungsi Menghapus Jadwal Terpilih
        window.hapusJadwal = async function(id) {
            if(confirm("Apakah Anda yakin ingin menghapus jadwal ini secara permanen?")) {
                try {
                    await deleteDoc(doc(db, "jadwal_pelajaran", id));
                    muatTabelJadwal(); // Refresh tabel otomatis setelah menghapus
                } catch (error) {
                    alert("Gagal menghapus data!");
                }
            }
        };

        // Muat tabel saat halaman pertama kali dibuka
        muatTabelJadwal();
    </script>
</body>
</html>
