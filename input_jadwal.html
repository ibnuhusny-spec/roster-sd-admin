<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Input Jadwal - ROSTERKU</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-gray-800">

    <!-- Navbar Admin -->
    <nav class="bg-blue-800 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">‚öôÔ∏è</span>
                    <span class="font-bold text-white text-lg tracking-wide">Panel Admin Jadwal</span>
                </div>
                <div class="flex gap-4">
                    <a href="master_data.html" class="text-blue-200 hover:text-white font-medium flex items-center gap-1 transition text-sm">
                        <span>üìÅ</span> Kelola Data Master
                    </a>
                    <a href="index.html" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded-lg font-medium flex items-center gap-1 transition text-sm shadow-sm">
                        <span>üö™</span> Keluar
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto p-4 md:p-8">
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- FORM INPUT JADWAL -->
            <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-sm border border-gray-200 h-fit sticky top-6">
                <h2 id="judulForm" class="text-xl font-extrabold text-blue-800 mb-4 flex items-center gap-2">
                    <span>‚ûï</span> Tambah Jadwal Baru
                </h2>
                
                <form id="formJadwal" onsubmit="simpanJadwal(event)" class="space-y-4">
                    <input type="hidden" id="editId">
                    
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Hari</label>
                        <select id="inputHari" class="w-full p-2.5 border border-gray-300 rounded-xl bg-gray-50 focus:ring-2 focus:ring-blue-500" required>
                            <option value="">-- Pilih Hari --</option>
                            <option value="Senin">Senin</option>
                            <option value="Selasa">Selasa</option>
                            <option value="Rabu">Rabu</option>
                            <option value="Kamis">Kamis</option>
                            <option value="Jumat">Jumat</option>
                            <option value="Sabtu">Sabtu</option>
                            <option value="Minggu">Minggu</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Waktu / Jam Ke-</label>
                        <input type="text" id="inputWaktu" placeholder="Contoh: 07:15 - 08:35" class="w-full p-2.5 border border-gray-300 rounded-xl bg-gray-50 focus:ring-2 focus:ring-blue-500" required>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Kelas</label>
                        <select id="inputKelas" class="w-full p-2.5 border border-gray-300 rounded-xl bg-gray-50 focus:ring-2 focus:ring-blue-500" required>
                            <option value="">-- Pilih Kelas --</option>
                            <!-- Diisi via JS -->
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Mata Pelajaran</label>
                        <select id="inputMapel" class="w-full p-2.5 border border-gray-300 rounded-xl bg-gray-50 focus:ring-2 focus:ring-blue-500" required>
                            <option value="">-- Pilih Mapel --</option>
                            <!-- Diisi via JS -->
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Guru Pengajar</label>
                        <select id="inputGuru" class="w-full p-2.5 border border-gray-300 rounded-xl bg-gray-50 focus:ring-2 focus:ring-blue-500" required>
                            <option value="">-- Pilih Guru --</option>
                            <!-- Diisi via JS -->
                        </select>
                    </div>

                    <div class="pt-4 flex gap-2">
                        <button type="button" id="btnBatal" onclick="resetForm()" class="hidden w-1/3 px-4 py-3 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-xl font-semibold transition-colors">Batal</button>
                        <button type="submit" id="btnSimpan" class="w-full px-4 py-3 text-white bg-blue-600 hover:bg-blue-700 shadow-lg shadow-blue-200 rounded-xl font-bold transition-all flex justify-center items-center gap-2">
                            üíæ Simpan Jadwal
                        </button>
                    </div>
                </form>
            </div>

            <!-- TABEL PREVIEW JADWAL -->
            <div class="lg:col-span-2">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 mb-4 flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-extrabold text-gray-800 mb-1">Daftar Jadwal</h2>
                        <p class="text-sm text-gray-500">Kelola jadwal yang sudah diinput.</p>
                    </div>
                    <div>
                        <select id="filterKelasTable" onchange="renderTabel()" class="p-2 border border-gray-300 rounded-lg bg-gray-50 text-sm font-semibold text-blue-700">
                            <option value="Semua">Semua Kelas</option>
                        </select>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-200">
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm text-left">
                            <thead class="bg-gray-50 text-gray-600 uppercase font-bold text-xs border-b">
                                <tr>
                                    <th class="py-3 px-4 w-20">Hari</th>
                                    <th class="py-3 px-4 w-28">Waktu</th>
                                    <th class="py-3 px-4 w-20">Kelas</th>
                                    <th class="py-3 px-4">Mapel & Guru</th>
                                    <th class="py-3 px-4 text-center w-24">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="tabelJadwal" class="divide-y divide-gray-100">
                                <tr><td colspan="5" class="text-center py-6 text-gray-400 italic">Memuat data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // Konfigurasi Firebase
        let firebaseConfig = { 
            apiKey: "API_KEY_ANDA",
            authDomain: "PROJECT_ID.firebaseapp.com",
            projectId: "PROJECT_ID",
            storageBucket: "PROJECT_ID.appspot.com",
            messagingSenderId: "SENDER_ID",
            appId: "APP_ID"
        };
        try {
            const module = await import("./firebase-config.js");
            if (module && module.firebaseConfig) { firebaseConfig = module.firebaseConfig; }
        } catch (error) { console.warn("Lokal mode"); }

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let semuaJadwal = [];

        // --- MENGAMBIL DATA MASTER UNTUK DROPDOWN ---
        function muatDataMaster() {
            if (firebaseConfig.apiKey === "API_KEY_ANDA") return;
            
            // Kelas
            onSnapshot(collection(db, "master_kelas"), (snapshot) => {
                const selKelas = document.getElementById('inputKelas');
                const filterKelas = document.getElementById('filterKelasTable');
                selKelas.innerHTML = '<option value="">-- Pilih Kelas --</option>';
                filterKelas.innerHTML = '<option value="Semua">Semua Kelas</option>';
                
                let arr = [];
                snapshot.forEach(d => arr.push(d.data().nama));
                arr.sort().forEach(nama => {
                    selKelas.insertAdjacentHTML('beforeend', `<option value="${nama}">${nama}</option>`);
                    filterKelas.insertAdjacentHTML('beforeend', `<option value="${nama}">${nama}</option>`);
                });
            });

            // Mapel
            onSnapshot(collection(db, "master_mapel"), (snapshot) => {
                const sel = document.getElementById('inputMapel');
                sel.innerHTML = '<option value="">-- Pilih Mapel --</option>';
                let arr = [];
                snapshot.forEach(d => arr.push(d.data().nama));
                arr.sort().forEach(nama => sel.insertAdjacentHTML('beforeend', `<option value="${nama}">${nama}</option>`));
            });

            // Guru
            onSnapshot(collection(db, "master_guru"), (snapshot) => {
                const sel = document.getElementById('inputGuru');
                sel.innerHTML = '<option value="">-- Pilih Guru --</option>';
                let arr = [];
                snapshot.forEach(d => arr.push(d.data().nama));
                arr.sort().forEach(nama => sel.insertAdjacentHTML('beforeend', `<option value="${nama}">${nama}</option>`));
            });
        }
        muatDataMaster();

        // --- MENGAMBIL SEMUA JADWAL (Realtime) ---
        function muatJadwal() {
            if (firebaseConfig.apiKey === "API_KEY_ANDA") return;
            onSnapshot(collection(db, "jadwal_pelajaran"), (snapshot) => {
                semuaJadwal = [];
                snapshot.forEach(docSnap => {
                    semuaJadwal.push({ id: docSnap.id, ...docSnap.data() });
                });
                renderTabel();
            });
        }
        muatJadwal();

        // Urutan Hari untuk sorting tabel
        const urutanHari = { "Senin":1, "Selasa":2, "Rabu":3, "Kamis":4, "Jumat":5, "Sabtu":6, "Minggu":7 };

        window.renderTabel = function() {
            const tabel = document.getElementById('tabelJadwal');
            const filter = document.getElementById('filterKelasTable').value;
            tabel.innerHTML = '';

            let data = filter === "Semua" ? semuaJadwal : semuaJadwal.filter(j => j.kelas === filter);
            
            data.sort((a, b) => {
                if (urutanHari[a.hari] !== urutanHari[b.hari]) return urutanHari[a.hari] - urutanHari[b.hari];
                return (a.waktu || "").localeCompare(b.waktu || "");
            });

            if (data.length === 0) {
                tabel.innerHTML = `<tr><td colspan="5" class="text-center py-6 text-gray-500">Belum ada data jadwal.</td></tr>`;
                return;
            }

            data.forEach(j => {
                let bgHari = "bg-gray-100";
                if(j.hari === "Senin") bgHari = "bg-red-100 text-red-700";
                else if(j.hari === "Selasa") bgHari = "bg-orange-100 text-orange-700";
                else if(j.hari === "Rabu") bgHari = "bg-yellow-100 text-yellow-700";
                else if(j.hari === "Kamis") bgHari = "bg-green-100 text-green-700";
                else if(j.hari === "Jumat") bgHari = "bg-blue-100 text-blue-700";
                else if(j.hari === "Sabtu") bgHari = "bg-purple-100 text-purple-700";

                tabel.insertAdjacentHTML('beforeend', `
                    <tr class="hover:bg-blue-50 transition border-b border-gray-50">
                        <td class="py-3 px-4"><span class="px-2 py-1 rounded text-xs font-bold ${bgHari}">${j.hari}</span></td>
                        <td class="py-3 px-4 font-medium text-gray-700">${j.waktu}</td>
                        <td class="py-3 px-4 font-bold text-blue-600">${j.kelas}</td>
                        <td class="py-3 px-4">
                            <div class="font-bold text-gray-800">${j.mapel}</div>
                            <div class="text-xs text-gray-500">üë®‚Äçüè´ ${j.guru}</div>
                        </td>
                        <td class="py-3 px-4 text-center">
                            <div class="flex items-center justify-center gap-2">
                                <button onclick="editJadwal('${j.id}')" class="p-1.5 bg-yellow-100 text-yellow-700 hover:bg-yellow-200 rounded-lg transition" title="Edit">‚úèÔ∏è</button>
                                <button onclick="hapusJadwal('${j.id}')" class="p-1.5 bg-red-100 text-red-700 hover:bg-red-200 rounded-lg transition" title="Hapus">üóëÔ∏è</button>
                            </div>
                        </td>
                    </tr>
                `);
            });
        };

        // ========================================================
        // FITUR ANTI-BENTROK & SIMPAN DATA
        // ========================================================
        window.simpanJadwal = async function(e) {
            e.preventDefault();
            
            const btnSimpan = document.getElementById('btnSimpan');
            btnSimpan.innerHTML = "‚è≥ Memproses...";
            btnSimpan.disabled = true;

            const idEdit = document.getElementById('editId').value;
            const dataBaru = {
                hari: document.getElementById('inputHari').value,
                waktu: document.getElementById('inputWaktu').value.trim(),
                kelas: document.getElementById('inputKelas').value,
                mapel: document.getElementById('inputMapel').value,
                guru: document.getElementById('inputGuru').value
            };

            // 1. CEK BENTROK KELAS (Kelas tidak boleh double mapel di jam yang sama)
            const cekBentrokKelas = semuaJadwal.find(j => 
                j.hari === dataBaru.hari && 
                j.waktu === dataBaru.waktu && 
                j.kelas === dataBaru.kelas && 
                j.id !== idEdit // Abaikan ID yang sedang diedit
            );

            if (cekBentrokKelas) {
                alert(`‚ùå BENTROK KELAS!\n\nKelas ${dataBaru.kelas} sudah memiliki jadwal pelajaran [${cekBentrokKelas.mapel}] pada Hari ${dataBaru.hari} Jam ${dataBaru.waktu}.\n\nSilakan pilih waktu atau kelas lain.`);
                btnSimpan.innerHTML = "üíæ Simpan Jadwal";
                btnSimpan.disabled = false;
                return;
            }

            // 2. CEK BENTROK GURU (Guru tidak boleh mengajar di 2 kelas berbeda di jam yang sama)
            const cekBentrokGuru = semuaJadwal.find(j => 
                j.hari === dataBaru.hari && 
                j.waktu === dataBaru.waktu && 
                j.guru === dataBaru.guru && 
                j.id !== idEdit // Abaikan ID yang sedang diedit
            );

            if (cekBentrokGuru) {
                alert(`‚ùå BENTROK GURU!\n\nBapak/Ibu ${dataBaru.guru} sudah ditugaskan mengajar di Kelas ${cekBentrokGuru.kelas} pada Hari ${dataBaru.hari} Jam ${dataBaru.waktu}.\n\nSilakan pilih waktu atau guru lain.`);
                btnSimpan.innerHTML = "üíæ Simpan Jadwal";
                btnSimpan.disabled = false;
                return;
            }

            // JIKA LOLOS VALIDASI BENTROK, PROSES SIMPAN KE DATABASE
            try {
                if (idEdit) {
                    await updateDoc(doc(db, "jadwal_pelajaran", idEdit), dataBaru);
                } else {
                    await addDoc(collection(db, "jadwal_pelajaran"), dataBaru);
                }
                resetForm();
            } catch (error) {
                console.error("Error:", error);
                alert("‚ùå Gagal menyimpan jadwal.");
            }

            btnSimpan.innerHTML = "üíæ Simpan Jadwal";
            btnSimpan.disabled = false;
        };

        window.editJadwal = function(id) {
            const data = semuaJadwal.find(j => j.id === id);
            if(data) {
                document.getElementById('editId').value = data.id;
                document.getElementById('inputHari').value = data.hari;
                document.getElementById('inputWaktu').value = data.waktu;
                document.getElementById('inputKelas').value = data.kelas;
                document.getElementById('inputMapel').value = data.mapel;
                document.getElementById('inputGuru').value = data.guru;
                
                document.getElementById('judulForm').innerHTML = "‚úèÔ∏è Edit Jadwal";
                document.getElementById('btnSimpan').innerHTML = "üíæ Update Jadwal";
                document.getElementById('btnSimpan').classList.replace('bg-blue-600', 'bg-yellow-600');
                document.getElementById('btnSimpan').classList.replace('hover:bg-blue-700', 'hover:bg-yellow-700');
                document.getElementById('btnBatal').classList.remove('hidden');
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        };

        window.hapusJadwal = async function(id) {
            if(confirm("‚ö†Ô∏è Yakin ingin menghapus jadwal ini?")) {
                await deleteDoc(doc(db, "jadwal_pelajaran", id));
            }
        };

        window.resetForm = function() {
            document.getElementById('formJadwal').reset();
            document.getElementById('editId').value = "";
            document.getElementById('judulForm').innerHTML = "<span>‚ûï</span> Tambah Jadwal Baru";
            document.getElementById('btnSimpan').innerHTML = "üíæ Simpan Jadwal";
            document.getElementById('btnSimpan').classList.replace('bg-yellow-600', 'bg-blue-600');
            document.getElementById('btnSimpan').classList.replace('hover:bg-yellow-700', 'hover:bg-blue-700');
            document.getElementById('btnBatal').classList.add('hidden');
        };

    </script>
</body>
</html>
