<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Manajemen Jadwal Pelajaran</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jQuery & Select2 -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
        .select2-container .select2-selection--single {
            height: 38px !important;
            border-color: #d1d5db !important;
            border-radius: 0.375rem !important;
            display: flex;
            align-items: center;
        }
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 36px !important;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans">

    <!-- Navbar -->
    <nav class="bg-blue-700 text-white p-4 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold flex items-center gap-2">
                <span>üìÖ</span> Manajemen Jadwal Pelajaran
            </h1>
            <div id="authStatus" class="text-sm bg-blue-800 px-3 py-1 rounded-full">Menghubungkan...</div>
        </div>
    </nav>

    <div class="container mx-auto p-4 mt-4 grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- Kolom Kiri: Form Input -->
        <div class="bg-white p-5 rounded-lg shadow-md lg:col-span-1 h-fit">
            <h2 id="judulForm" class="text-xl font-bold mb-4 text-gray-800 border-b pb-2 flex items-center gap-2">
                <span>‚ûï</span> Tambah Jadwal Baru
            </h2>
            <form id="formJadwal" class="space-y-4">
                <input type="hidden" id="editId">
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Hari</label>
                    <select id="inputHari" class="w-full select2" required>
                        <option value="">-- Pilih Hari --</option>
                        <option value="Senin">Senin</option>
                        <option value="Selasa">Selasa</option>
                        <option value="Rabu">Rabu</option>
                        <option value="Kamis">Kamis</option>
                        <option value="Jumat">Jumat</option>
                        <option value="Sabtu">Sabtu</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Waktu (Jam Ke / Pukul)</label>
                    <select id="inputWaktu" class="w-full select2-tags" required>
                        <option value="">-- Ketik/Pilih Waktu --</option>
                        <option value="07:00 - 08:30">07:00 - 08:30</option>
                        <option value="08:30 - 10:00">08:30 - 10:00</option>
                        <option value="10:15 - 11:45">10:15 - 11:45</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Kelas</label>
                    <select id="inputKelas" class="w-full select2-tags" required>
                        <option value="">-- Ketik/Pilih Kelas --</option>
                        <option value="X-A">X-A</option>
                        <option value="X-B">X-B</option>
                        <option value="XI-A">XI-A</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Mata Pelajaran</label>
                    <select id="inputMapel" class="w-full select2-tags" required>
                        <option value="">-- Ketik/Pilih Mapel --</option>
                        <option value="Matematika">Matematika</option>
                        <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                        <option value="Bahasa Inggris">Bahasa Inggris</option>
                        <option value="IPA">IPA</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Guru Pengajar</label>
                    <select id="inputGuru" class="w-full select2-tags">
                        <option value="">-- Ketik/Pilih Guru --</option>
                        <option value="Budi Santoso, S.Pd">Budi Santoso, S.Pd</option>
                        <option value="Siti Aminah, M.Pd">Siti Aminah, M.Pd</option>
                    </select>
                </div>

                <div class="flex gap-2 pt-2">
                    <button type="submit" id="btnSimpan" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition-colors">
                        üíæ Simpan Jadwal
                    </button>
                    <button type="button" id="btnBatal" onclick="resetForm()" class="hidden bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded transition-colors">
                        Batal
                    </button>
                </div>
            </form>
        </div>

        <!-- Kolom Kanan: Tabel Data & Tools -->
        <div class="bg-white p-5 rounded-lg shadow-md lg:col-span-2">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                <h2 class="text-xl font-bold text-gray-800 border-b pb-2 flex-1 w-full">üìã Daftar Jadwal</h2>
                
                <div class="w-full md:w-64 flex items-center gap-2">
                    <label class="text-sm font-bold text-gray-600">Filter:</label>
                    <select id="filterKelasTable" class="w-full p-2 border rounded border-gray-300" onchange="renderTable()">
                        <option value="Semua">Semua Kelas</option>
                        <!-- Options generated dynamically -->
                    </select>
                </div>
            </div>

            <!-- Toolbar Aksi -->
            <div class="flex flex-wrap gap-2 mb-4 bg-gray-50 p-3 rounded border border-gray-200">
                <button onclick="bukaModalSalinKelas()" class="bg-indigo-500 hover:bg-indigo-600 text-white text-sm px-3 py-1.5 rounded flex items-center gap-1 shadow-sm">
                    <span>üìã</span> Salin Kelas
                </button>
                <button onclick="bukaModalTerapkanGuru()" class="bg-teal-500 hover:bg-teal-600 text-white text-sm px-3 py-1.5 rounded flex items-center gap-1 shadow-sm">
                    <span>üë®‚Äçüè´</span> Terapkan Guru
                </button>
                <button onclick="bukaModalExcel()" class="bg-green-600 hover:bg-green-700 text-white text-sm px-3 py-1.5 rounded flex items-center gap-1 shadow-sm">
                    <span>üìä</span> Download Excel
                </button>
                <div class="flex-1"></div>
                <button onclick="hapusJadwalPerKelas()" class="bg-orange-500 hover:bg-orange-600 text-white text-sm px-3 py-1.5 rounded flex items-center gap-1 shadow-sm">
                    <span>üßπ</span> Hapus Per Kelas
                </button>
                <button onclick="hapusSemuaJadwal()" class="bg-red-600 hover:bg-red-700 text-white text-sm px-3 py-1.5 rounded flex items-center gap-1 shadow-sm">
                    <span>üö®</span> Kosongkan Semua
                </button>
            </div>

            <!-- Tabel -->
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200 text-sm">
                    <thead class="bg-gray-100 text-gray-700 border-b-2 border-gray-300">
                        <tr>
                            <th class="py-2 px-3 border-r text-left w-10">No</th>
                            <th class="py-2 px-3 border-r text-left">Hari</th>
                            <th class="py-2 px-3 border-r text-left">Waktu</th>
                            <th class="py-2 px-3 border-r text-left">Kelas</th>
                            <th class="py-2 px-3 border-r text-left">Mata Pelajaran</th>
                            <th class="py-2 px-3 border-r text-left">Guru</th>
                            <th class="py-2 px-3 text-center w-24">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="tabelJadwal" class="text-gray-600">
                        <tr><td colspan="7" class="text-center py-4">Memuat data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MODAL: Salin Kelas -->
    <div id="modalSalin" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md shadow-xl">
            <h3 class="text-lg font-bold mb-4 border-b pb-2 text-indigo-700">üìã Salin Jadwal Antar Kelas</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-gray-700">Salin DARI Kelas:</label>
                    <input type="text" id="salinDariKelas" class="w-full p-2 border rounded" placeholder="Contoh: X-A">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700">Salin KE Kelas:</label>
                    <input type="text" id="salinKeKelas" class="w-full p-2 border rounded" placeholder="Contoh: X-B">
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-2">
                <button onclick="tutupModalSalinKelas()" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded">Batal</button>
                <button id="btnProsesSalin" onclick="prosesSalinKelas()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded">Proses Salin</button>
            </div>
        </div>
    </div>

    <!-- MODAL: Terapkan Guru -->
    <div id="modalTerapkanGuru" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md shadow-xl">
            <h3 class="text-lg font-bold mb-4 border-b pb-2 text-teal-700">üë®‚Äçüè´ Terapkan Guru ke Kelas</h3>
            <p class="text-xs text-gray-500 mb-4">Isi semua jam pelajaran di kelas tertentu dengan satu guru yang sama.</p>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-gray-700">Pilih Kelas:</label>
                    <input type="text" id="terapkanKelas" class="w-full p-2 border rounded" placeholder="Contoh: X-A">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700">Nama Guru:</label>
                    <input type="text" id="terapkanGuru" class="w-full p-2 border rounded" placeholder="Nama Guru">
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-2">
                <button onclick="tutupModalTerapkanGuru()" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded">Batal</button>
                <button id="btnProsesTerapkan" onclick="prosesTerapkanGuru()" class="px-4 py-2 bg-teal-600 hover:bg-teal-700 text-white rounded">Terapkan</button>
            </div>
        </div>
    </div>

    <!-- MODAL: Download Excel -->
    <div id="modalExcel" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-lg shadow-xl max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold mb-4 border-b pb-2 text-green-700">üìä Ekspor Jadwal ke Excel</h3>
            <div class="space-y-3">
                <div>
                    <label class="block text-xs font-bold text-gray-700">Kop Surat Baris 1</label>
                    <input type="text" id="exKop1" class="w-full p-2 border rounded text-sm" value="PEMERINTAH PROVINSI DAERAH">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-700">Kop Surat Baris 2 (Nama Sekolah)</label>
                    <input type="text" id="exKop2" class="w-full p-2 border rounded text-sm" value="SMA NEGERI 1 CONTOH">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-700">Nama Kepala Sekolah</label>
                        <input type="text" id="exKepsek" class="w-full p-2 border rounded text-sm" placeholder="Nama Kepsek">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700">NIP Kepala Sekolah</label>
                        <input type="text" id="exNipKepsek" class="w-full p-2 border rounded text-sm" placeholder="NIP Kepsek">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-700">Nama Wali Kelas/Wakakur</label>
                        <input type="text" id="exWali" class="w-full p-2 border rounded text-sm" placeholder="Nama Wali">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700">NIP Wali Kelas</label>
                        <input type="text" id="exNipWali" class="w-full p-2 border rounded text-sm" placeholder="NIP Wali">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-700">Tempat & Tanggal TTD</label>
                    <input type="text" id="exTanggal" class="w-full p-2 border rounded text-sm" value="Jakarta, 17 Juli 2023">
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-2">
                <button onclick="tutupModalExcel()" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded">Batal</button>
                <button onclick="prosesDownloadExcel()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded">Download .xls</button>
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Variables
        window.semuaJadwal = [];
        window.db = null;
        window.urutanHari = { "Senin": 1, "Selasa": 2, "Rabu": 3, "Kamis": 4, "Jumat": 5, "Sabtu": 6, "Minggu": 7 };
        
        let currentUser = null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'jadwal-app-demo';

        // Initialize Firebase
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            // Mock config for environments outside Canvas
            projectId: "demo-project"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        window.db = getFirestore(app);

        // Authentication & Data Fetching Flow
        async function initApp() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                currentUser = auth.currentUser;
                document.getElementById('authStatus').innerHTML = "‚úÖ Online";
                document.getElementById('authStatus').classList.replace('bg-blue-800', 'bg-green-600');

                // Load Data
                const collRef = collection(window.db, 'artifacts', appId, 'users', currentUser.uid, 'jadwal_pelajaran');
                
                onSnapshot(collRef, (snapshot) => {
                    window.semuaJadwal = [];
                    let listKelas = new Set();

                    snapshot.forEach((doc) => {
                        let data = doc.data();
                        data.id = doc.id;
                        window.semuaJadwal.push(data);
                        if(data.kelas) listKelas.add(data.kelas);
                    });

                    updateDropdownKelas(Array.from(listKelas));
                    window.renderTable();
                }, (error) => {
                    console.error("Error mengambil data:", error);
                    alert("Gagal memuat data jadwal.");
                });

            } catch (error) {
                console.error("Auth Error:", error);
                document.getElementById('authStatus').innerHTML = "‚ùå Offline";
                document.getElementById('authStatus').classList.replace('bg-blue-800', 'bg-red-600');
            }
        }

        // Jalankan Inisialisasi
        initApp();

        // DOM Ready Initializations
        $(document).ready(function() {
            $('.select2').select2();
            $('.select2-tags').select2({ tags: true });

            // Form Submit Handler
            $('#formJadwal').on('submit', async function(e) {
                e.preventDefault();
                if (!currentUser) return alert("Belum terhubung ke database!");

                const id = $('#editId').val();
                const hari = $('#inputHari').val();
                const waktu = $('#inputWaktu').val();
                const kelas = $('#inputKelas').val();
                const mapel = $('#inputMapel').val();
                const guru = $('#inputGuru').val();

                const btn = document.getElementById('btnSimpan');
                btn.disabled = true;
                btn.innerHTML = "‚è≥ Menyimpan...";

                const jadwalData = { hari, waktu, kelas, mapel, guru };
                const collRef = collection(window.db, 'artifacts', appId, 'users', currentUser.uid, 'jadwal_pelajaran');

                try {
                    if (id) {
                        await updateDoc(doc(window.db, 'artifacts', appId, 'users', currentUser.uid, 'jadwal_pelajaran', id), jadwalData);
                    } else {
                        await addDoc(collRef, jadwalData);
                    }
                    window.resetForm();
                } catch (error) {
                    console.error("Gagal simpan:", error);
                    alert("Gagal menyimpan jadwal.");
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = "üíæ Simpan Jadwal";
                }
            });
        });

        // FUNGSI UNTUK MERENDER TABEL
        window.renderTable = function() {
            const filterKelas = document.getElementById('filterKelasTable').value;
            const tbody = document.getElementById('tabelJadwal');
            tbody.innerHTML = '';

            let dataTampil = filterKelas === "Semua" ? window.semuaJadwal : window.semuaJadwal.filter(j => j.kelas === filterKelas);

            // Pengurutan (Berdasarkan Hari lalu Waktu)
            dataTampil.sort((a, b) => {
                if (window.urutanHari[a.hari] !== window.urutanHari[b.hari]) {
                    return window.urutanHari[a.hari] - window.urutanHari[b.hari];
                }
                let m1 = (a.waktu||"").match(/\d+/g); let m2 = (b.waktu||"").match(/\d+/g);
                let val1 = m1 ? parseInt(m1[0])*60 + (m1[1] ? parseInt(m1[1]) : 0) : 9999;
                let val2 = m2 ? parseInt(m2[0])*60 + (m2[1] ? parseInt(m2[1]) : 0) : 9999;
                return val1 - val2;
            });

            if (dataTampil.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-gray-500 italic">Belum ada jadwal untuk filter ini.</td></tr>`;
                return;
            }

            dataTampil.forEach((j, index) => {
                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-200 hover:bg-gray-50 transition-colors";
                tr.innerHTML = `
                    <td class="py-2 px-3 border-r text-center">${index + 1}</td>
                    <td class="py-2 px-3 border-r font-semibold text-blue-800">${j.hari}</td>
                    <td class="py-2 px-3 border-r">${j.waktu}</td>
                    <td class="py-2 px-3 border-r font-bold text-gray-700">${j.kelas}</td>
                    <td class="py-2 px-3 border-r">${j.mapel}</td>
                    <td class="py-2 px-3 border-r">${j.guru || '-'}</td>
                    <td class="py-2 px-3 text-center">
                        <div class="flex justify-center gap-1">
                            <button onclick="editJadwal('${j.id}')" class="bg-yellow-500 hover:bg-yellow-600 text-white p-1 rounded text-xs" title="Edit">‚úèÔ∏è</button>
                            <button onclick="hapusJadwal('${j.id}')" class="bg-red-500 hover:bg-red-600 text-white p-1 rounded text-xs" title="Hapus">üóëÔ∏è</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        };

        // FUNGSI UPDATE FILTER KELAS
        function updateDropdownKelas(listKelas) {
            const select = document.getElementById('filterKelasTable');
            const valSaatIni = select.value;
            
            // Pertahankan opsi "Semua"
            let html = `<option value="Semua">Semua Kelas</option>`;
            
            listKelas.sort().forEach(k => {
                html += `<option value="${k}">${k}</option>`;
            });
            
            select.innerHTML = html;
            
            // Kembalikan nilai sebelumnya jika masih ada
            if(listKelas.includes(valSaatIni) || valSaatIni === "Semua") {
                select.value = valSaatIni;
            } else {
                select.value = "Semua";
            }
        }

        // FUNGSI EDIT JADWAL
        window.editJadwal = function(id) {
            const jadwal = window.semuaJadwal.find(j => j.id === id);
            if(!jadwal) return;

            document.getElementById('editId').value = jadwal.id;
            
            // Update Select2 values
            $('#inputHari').val(jadwal.hari).trigger('change');
            
            // Untuk Select2 dengan Tags, buat option jika belum ada
            if ($('#inputWaktu').find("option[value='" + jadwal.waktu + "']").length) {
                $('#inputWaktu').val(jadwal.waktu).trigger('change');
            } else { 
                var newWaktu = new Option(jadwal.waktu, jadwal.waktu, true, true);
                $('#inputWaktu').append(newWaktu).trigger('change');
            }

            if ($('#inputKelas').find("option[value='" + jadwal.kelas + "']").length) {
                $('#inputKelas').val(jadwal.kelas).trigger('change');
            } else { 
                var newKelas = new Option(jadwal.kelas, jadwal.kelas, true, true);
                $('#inputKelas').append(newKelas).trigger('change');
            }

            if ($('#inputMapel').find("option[value='" + jadwal.mapel + "']").length) {
                $('#inputMapel').val(jadwal.mapel).trigger('change');
            } else { 
                var newMapel = new Option(jadwal.mapel, jadwal.mapel, true, true);
                $('#inputMapel').append(newMapel).trigger('change');
            }

            if ($('#inputGuru').find("option[value='" + jadwal.guru + "']").length) {
                $('#inputGuru').val(jadwal.guru).trigger('change');
            } else { 
                var newGuru = new Option(jadwal.guru, jadwal.guru, true, true);
                $('#inputGuru').append(newGuru).trigger('change');
            }

            document.getElementById('judulForm').innerHTML = "<span>‚úèÔ∏è</span> Edit Jadwal";
            
            const btnSimpan = document.getElementById('btnSimpan');
            btnSimpan.innerHTML = "üíæ Update Jadwal";
            btnSimpan.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            btnSimpan.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
            
            document.getElementById('btnBatal').classList.remove('hidden');
            
            // Scroll ke atas
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };


        // =========================================================================
        // ================= KODE DARI PENGGUNA (DIBAWAH INI) ======================
        // =========================================================================

        window.hapusJadwal = async function(id) {
            if (!window.db) return alert("‚ùå Koneksi database tidak tersedia.");
            // Penyesuaian Path Firestore
            if(confirm("‚ö†Ô∏è Yakin hapus baris jadwal ini?")) await deleteDoc(doc(window.db, 'artifacts', appId, 'users', currentUser.uid, 'jadwal_pelajaran', id));
        };

        window.hapusJadwalPerKelas = async function() {
            const kelas = document.getElementById('filterKelasTable').value;
            if (kelas === "Semua") return alert("‚ùå Silakan filter tabel ke SATU KELAS terlebih dahulu (dropdown di atas tabel) untuk menghapus seluruh jadwal kelas tersebut.");
            
            if (!confirm(`‚ö†Ô∏è PERINGATAN!\n\nAnda yakin ingin menghapus SELURUH jadwal untuk KELAS ${kelas}?\nData yang dihapus tidak dapat dikembalikan.`)) return;

            const dataHapus = semuaJadwal.filter(j => j.kelas === kelas);
            if(dataHapus.length === 0) return alert(`Tidak ada jadwal di kelas ${kelas}.`);

            let terhapus = 0;
            for(const j of dataHapus) {
                try {
                    // Penyesuaian Path Firestore
                    await deleteDoc(doc(window.db, 'artifacts', appId, 'users', currentUser.uid, 'jadwal_pelajaran', j.id));
                    terhapus++;
                } catch(e) { console.error("Gagal hapus", e); }
            }
            alert(`‚úÖ Berhasil menghapus ${terhapus} jadwal di Kelas ${kelas}.`);
        };

        window.hapusSemuaJadwal = async function() {
            if (!confirm(`üö® AWAS! TINDAKAN BERBAHAYA!\n\nAnda akan menghapus SEMUA JADWAL DARI SELURUH KELAS! Apakah Anda 100% yakin?`)) return;
            const ketik = prompt("Untuk melanjutkan, ketik kata 'HAPUS' di bawah ini (huruf besar semua):");
            if (ketik !== "HAPUS") return alert("‚ùå Aksi dibatalkan. Kata kunci tidak cocok.");

            let terhapus = 0;
            for(const j of semuaJadwal) {
                try {
                    // Penyesuaian Path Firestore
                    await deleteDoc(doc(window.db, 'artifacts', appId, 'users', currentUser.uid, 'jadwal_pelajaran', j.id));
                    terhapus++;
                } catch(e) { console.error("Gagal hapus", e); }
            }
            alert(`‚úÖ SELURUH JADWAL BERHASIL DIKOSONGKAN. Total ${terhapus} baris data dihapus.`);
        };

        window.resetForm = function() {
            document.getElementById('formJadwal').reset();
            document.getElementById('editId').value = "";
            $('#inputHari').val('').trigger('change'); $('#inputWaktu').val('').trigger('change');
            $('#inputKelas').val('').trigger('change'); $('#inputMapel').val('').trigger('change'); $('#inputGuru').val('').trigger('change');
            
            document.getElementById('judulForm').innerHTML = "<span>‚ûï</span> Tambah Jadwal Baru";
            
            const btnSimpan = document.getElementById('btnSimpan');
            btnSimpan.innerHTML = "üíæ Simpan Jadwal";
            btnSimpan.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
            btnSimpan.classList.add('bg-blue-600', 'hover:bg-blue-700');
            
            document.getElementById('btnBatal').classList.add('hidden');
        };

        // --- FITUR SALIN JADWAL ANTAR KELAS ---
        window.bukaModalSalinKelas = function() { 
            document.getElementById('modalSalin').classList.remove('hidden'); 
            
            // Otomatis pilih kelas asal berdasarkan filter tabel jika tidak sedang di posisi "Semua"
            const filterSaatIni = document.getElementById('filterKelasTable').value;
            if(filterSaatIni !== "Semua") {
                document.getElementById('salinDariKelas').value = filterSaatIni;
            } else {
                document.getElementById('salinDariKelas').value = "";
            }
            document.getElementById('salinKeKelas').value = "";
        };
        window.tutupModalSalinKelas = function() { document.getElementById('modalSalin').classList.add('hidden'); };

        window.prosesSalinKelas = async function() {
            const dariKelas = document.getElementById('salinDariKelas').value;
            const keKelas = document.getElementById('salinKeKelas').value;

            if(!dariKelas || !keKelas) return alert("‚ùå Silakan pilih kelas asal dan kelas tujuan!");
            if(dariKelas === keKelas) return alert("‚ùå Kelas asal dan tujuan tidak boleh sama!");

            const jadwalAsal = semuaJadwal.filter(j => j.kelas === dariKelas);
            if(jadwalAsal.length === 0) return alert(`‚ùå Kelas ${dariKelas} tidak memiliki jadwal untuk disalin.`);

            const btn = document.getElementById('btnProsesSalin');
            btn.innerHTML = "‚è≥ Memproses..."; btn.disabled = true;

            let berhasil = 0;
            let bentrok = 0;
            
            const collRef = collection(window.db, 'artifacts', appId, 'users', currentUser.uid, 'jadwal_pelajaran');

            for (const j of jadwalAsal) {
                // Cek apakah di kelas tujuan sudah ada jadwal di hari dan jam yang sama agar tidak menumpuk/bentrok
                const cekBentrok = semuaJadwal.find(tj => tj.kelas === keKelas && tj.hari === j.hari && tj.waktu === j.waktu);
                if (cekBentrok) {
                    bentrok++;
                    continue; // Lewati jadwal yang hari/jam-nya sudah terisi di kelas tujuan
                }

                try {
                    // Penyesuaian Path Firestore
                    await addDoc(collRef, {
                        hari: j.hari,
                        waktu: j.waktu,
                        kelas: keKelas,
                        mapel: j.mapel,
                        guru: "" // Nama guru sengaja dikosongkan
                    });
                    berhasil++;
                } catch(e) { console.error("Gagal menyalin", e); }
            }

            tutupModalSalinKelas();
            alert(`‚úÖ Proses salin jadwal selesai!\n\nBerhasil disalin: ${berhasil} mata pelajaran\nDilewati (jam bentrok): ${bentrok} jadwal`);
            btn.innerHTML = "Proses Salin"; btn.disabled = false;
        };

        // --- FITUR TERAPKAN GURU MASSAL ---
        window.bukaModalTerapkanGuru = function() {
            document.getElementById('modalTerapkanGuru').classList.remove('hidden');
            const filterSaatIni = document.getElementById('filterKelasTable').value;
            if(filterSaatIni !== "Semua") {
                document.getElementById('terapkanKelas').value = filterSaatIni;
            } else {
                document.getElementById('terapkanKelas').value = "";
            }
        };
        
        window.tutupModalTerapkanGuru = function() { document.getElementById('modalTerapkanGuru').classList.add('hidden'); };

        window.prosesTerapkanGuru = async function() {
            const kls = document.getElementById('terapkanKelas').value;
            const gr = document.getElementById('terapkanGuru').value;

            if(!kls || !gr) return alert("‚ùå Harap pilih Kelas dan Guru!");

            const jadwalTarget = semuaJadwal.filter(j => j.kelas === kls);
            
            // CEGAH ERROR: Beritahu pengguna jika jadwal di kelas tersebut belum dibuat
            if(jadwalTarget.length === 0) {
                return alert(`‚ùå KELAS MASIH KOSONG!\n\nBelum ada jadwal satupun di Kelas ${kls}.\n\nüí° Info: Fitur ini berfungsi untuk memasukkan nama guru ke baris jadwal yang "sudah dibuat". Silakan buat dulu jadwalnya di form sebelah kiri, atau gunakan fitur "Salin Kelas" terlebih dahulu.`);
            }

            const btn = document.getElementById('btnProsesTerapkan');
            btn.innerHTML = "‚è≥ Memproses..."; btn.disabled = true;

            let berhasil = 0;
            let dilewati = 0;

            for(const j of jadwalTarget) {
                try {
                    // Pengecekan agar guru tidak bentrok (menggunakan trim agar spasi pada teks jam tidak menimbulkan error)
                    const cekBentrok = semuaJadwal.find(tj => tj.hari === j.hari && (tj.waktu||"").trim() === (j.waktu||"").trim() && tj.guru === gr && tj.id !== j.id);
                    if(cekBentrok) {
                        dilewati++;
                        continue; // Jika guru sudah mengajar di kelas lain di jam yang sama, maka abaikan jadwal ini
                    }
                    
                    if(j.id) {
                        // Penyesuaian Path Firestore
                        await updateDoc(doc(window.db, 'artifacts', appId, 'users', currentUser.uid, 'jadwal_pelajaran', j.id), { guru: gr });
                        berhasil++;
                    }
                } catch(e) { console.error("Gagal terapkan guru", e); }
            }

            tutupModalTerapkanGuru();
            alert(`‚úÖ PROSES SELESAI!\n\nüë®‚Äçüè´ Guru: ${gr}\nüè´ Kelas: ${kls}\n\nBerhasil dimasukkan: ${berhasil} mapel\nDilewati (karena guru bentrok jam): ${dilewati} mapel`);
            btn.innerHTML = "Terapkan"; btn.disabled = false;
        };

        // --- FITUR DOWNLOAD EXCEL DENGAN MODAL (BERWARNA) ---
        window.bukaModalExcel = function() { document.getElementById('modalExcel').classList.remove('hidden'); }
        window.tutupModalExcel = function() { document.getElementById('modalExcel').classList.add('hidden'); }
        
        window.prosesDownloadExcel = function() {
            const filterKelas = document.getElementById('filterKelasTable').value;
            let data = filterKelas === "Semua" ? semuaJadwal : semuaJadwal.filter(j => j.kelas === filterKelas);
            if(data.length === 0) return alert("Data kosong, tidak ada yang bisa diunduh.");

            const kop1 = document.getElementById('exKop1').value;
            const kop2 = document.getElementById('exKop2').value;
            const kepsek = document.getElementById('exKepsek').value || ".....................";
            const nipKepsek = document.getElementById('exNipKepsek').value || ".....................";
            const wali = document.getElementById('exWali').value || ".....................";
            const nipWali = document.getElementById('exNipWali').value || ".....................";
            const tanggal = document.getElementById('exTanggal').value || ".....................";

            // Mengurutkan data
            data.sort((a,b) => {
                if (urutanHari[a.hari] !== urutanHari[b.hari]) return urutanHari[a.hari] - urutanHari[b.hari];
                let m1 = (a.waktu||"").match(/\d+/g); let m2 = (b.waktu||"").match(/\d+/g);
                let val1 = m1 ? parseInt(m1[0])*60 + (m1[1] ? parseInt(m1[1]) : 0) : 9999;
                let val2 = m2 ? parseInt(m2[0])*60 + (m2[1] ? parseInt(m2[1]) : 0) : 9999;
                return val1 - val2;
            });

            // Membuat Palette Warna Cerah untuk Membedakan Guru
            const warnaCerah = [
                "#FFB3BA", "#FFDFBA", "#FFFFBA", "#BAFFC9", "#BAE1FF", 
                "#E8BAFF", "#FFB3E6", "#C4FAF8", "#E2F0CB", "#FFC4C4", 
                "#FFDEAA", "#E0BBE4", "#957DAD", "#D291BC", "#FEC8D8", "#FDEB71"
            ];
            let mapWarnaGuru = {};
            let indexWarna = 0;
            
            // Assign warna unik per guru yang ada di data
            data.forEach(j => {
                if (j.guru && !mapWarnaGuru[j.guru]) {
                    mapWarnaGuru[j.guru] = warnaCerah[indexWarna % warnaCerah.length];
                    indexWarna++;
                }
            });

            // Mencegah kata "Kelas" dicetak ganda (Mengecek apakah nama kelas sudah mengandung kata "kelas")
            let judulKelas = filterKelas === 'Semua' ? 'SEKOLAH' : (filterKelas.toLowerCase().includes('kelas') ? filterKelas.toUpperCase() : 'KELAS ' + filterKelas.toUpperCase());

            // Membuat tabel HTML untuk dikonversi ke Excel dengan pengaturan warna (Inline CSS)
            let tabelHTML = `
            <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
            <head><meta charset="utf-8"></head>
            <body>
                <table style="width: 100%; font-family: Arial, sans-serif; border-collapse: collapse;">
                    <tr><td colspan="6" style="text-align: center; font-size: 14pt; font-weight: bold;">${kop1}</td></tr>
                    <tr><td colspan="6" style="text-align: center; font-size: 16pt; font-weight: bold;">${kop2}</td></tr>
                    <tr><td colspan="6" style="text-align: center; font-size: 12pt; font-weight: bold; padding-bottom: 20px;">JADWAL PELAJARAN ${judulKelas}</td></tr>
                    <tr><td colspan="6"></td></tr>
                    
                    <tr>
                        <th style="border: 1px solid black; background-color: #d1d5db; padding: 8px;">No</th>
                        <th style="border: 1px solid black; background-color: #d1d5db; padding: 8px;">Hari</th>
                        <th style="border: 1px solid black; background-color: #d1d5db; padding: 8px;">Waktu</th>
                        <th style="border: 1px solid black; background-color: #d1d5db; padding: 8px;">Kelas</th>
                        <th style="border: 1px solid black; background-color: #d1d5db; padding: 8px;">Mata Pelajaran</th>
                        <th style="border: 1px solid black; background-color: #d1d5db; padding: 8px;">Guru Pengajar</th>
                    </tr>
            `;

            let no = 1;
            let hariSaatIni = ""; // Menyimpan status hari yang sedang diproses

            data.forEach(j => {
                // Reset nomor urut ke 1 jika hari pada baris ini berbeda dengan hari sebelumnya
                if (j.hari !== hariSaatIni) {
                    no = 1;
                    hariSaatIni = j.hari;
                }

                // Memberikan warna background berdasarkan nama guru, biarkan putih jika belum ada guru
                let bgWarna = j.guru ? mapWarnaGuru[j.guru] : "#ffffff";

                tabelHTML += `
                    <tr>
                        <td style="border: 1px solid black; text-align: center; background-color: ${bgWarna};">${no++}</td>
                        <td style="border: 1px solid black; text-align: center; font-weight: bold; background-color: ${bgWarna};">${j.hari}</td>
                        <td style="border: 1px solid black; text-align: center; background-color: ${bgWarna};">${j.waktu}</td>
                        <td style="border: 1px solid black; text-align: center; background-color: ${bgWarna};">${j.kelas}</td>
                        <td style="border: 1px solid black; background-color: ${bgWarna};">${j.mapel}</td>
                        <td style="border: 1px solid black; background-color: ${bgWarna};">${j.guru}</td>
                    </tr>
                `;
            });

            // Bagian Tanda Tangan (Footer)
            tabelHTML += `
                    <tr><td colspan="6"></td></tr>
                    <tr><td colspan="6"></td></tr>
                    <tr>
                        <td colspan="2" style="text-align: center;">Mengetahui,</td>
                        <td colspan="2"></td>
                        <td colspan="2" style="text-align: center;">${tanggal}</td>
                    </tr>
                    <tr>
                        <td colspan="2" style="text-align: center;">Kepala Sekolah</td>
                        <td colspan="2"></td>
                        <td colspan="2" style="text-align: center;">Wali Kelas / Guru</td>
                    </tr>
                    <tr><td colspan="6"></td></tr>
                    <tr><td colspan="6"></td></tr>
                    <tr><td colspan="6"></td></tr>
                    <tr>
                        <td colspan="2" style="text-align: center; font-weight: bold; text-decoration: underline;">${kepsek}</td>
                        <td colspan="2"></td>
                        <td colspan="2" style="text-align: center; font-weight: bold; text-decoration: underline;">${wali}</td>
                    </tr>
                    <tr>
                        <td colspan="2" style="text-align: center;">NIP. ${nipKepsek}</td>
                        <td colspan="2"></td>
                        <td colspan="2" style="text-align: center;">NIP. ${nipWali}</td>
                    </tr>
                </table>
            </body>
            </html>
            `;

            // Proses Download File Excel (.xls)
            let blob = new Blob([tabelHTML], { type: 'application/vnd.ms-excel' });
            let link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `Jadwal_Pelajaran_${filterKelas}.xls`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            tutupModalExcel();
        };
    </script>
</body>
</html>
